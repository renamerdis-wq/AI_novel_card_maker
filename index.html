<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î°úÍ∑∏ Ïπ¥Îìú ÏÉùÏÑ±Í∏∞ v1.8.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>

    <style>
        /* =========================================
       Font Imports
       ========================================= */
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang&family=Gowun+Dodum&family=Nanum+Gothic&family=Nanum+Myeongjo&family=Nanum+Pen+Script&family=Noto+Sans+KR:wght@100..900&family=Noto+Serif+KR:wght@200..900&display=swap');
        @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");

        @font-face {
            font-family: 'RIDIBatang';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_twelve@1.0/RIDIBatang.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'KoPub World Batang';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_eight@1.0/KoPubWorldBatangPro-Regular.woff') format('woff');
        }

        @font-face {
            font-family: 'MaruBuri';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_20-10-21@1.0/MaruBuri-Regular.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        @font-face {
            font-family: 'Cafe24SsurroundAir';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2105_2@1.0/Cafe24SsurroundAir.woff') format('woff');
            font-weight: normal;
            font-style: normal;
        }

        /* =========================================
       Global Styles
       ========================================= */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #e2e8f0;
            font-family: 'Pretendard', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: #334155;
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        /* =========================================
       Zoom Controls (Floating UI)
       ========================================= */
        .zoom-wrapper {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 2500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .zoom-trigger {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid #cbd5e1;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .zoom-trigger:hover {
            background: rgba(255, 255, 255, 0.9);
            opacity: 1;
            transform: scale(1.05);
        }

        .zoom-menu {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 8px;
            border-radius: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid #cbd5e1;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.2s ease-out;
        }

        #zoomRange {
            appearance: slider-vertical;
            width: 8px;
            height: 120px;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* =========================================
       Editor Panel (Bottom Sheet / Sidebar)
       ========================================= */
        .editor-area {
            width: 100%;
            background: #fff;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            position: fixed;
            bottom: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            border-top: 1px solid #cbd5e1;
            border-radius: 20px 20px 0 0;
            height: 60vh;
            max-height: 90vh;
            min-height: 150px;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .editor-area.collapsed {
            transform: translateY(100%);
        }

        .editor-content-wrapper {
            padding: 16px;
            flex: 1;
            overflow-y: auto;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Color Picker Palette */
        .iro-palette {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .palette-item {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* Drag Handle */
        .index-handle {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            width: 140px;
            height: 45px;
            background: #fff;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 -6px 12px rgba(0, 0, 0, 0.08);
            cursor: ns-resize;
            font-weight: 800;
            color: #3b82f6;
            border: 1px solid #cbd5e1;
            border-bottom: 1px solid #fff;
            z-index: 2001;
            font-size: 14px;
            touch-action: none;
        }

        .index-handle:hover {
            background: #f8fafc;
            color: #2563eb;
        }

        /* =========================================
   Header Layout (Multi-line Wrap)
   ========================================= */
        .editor-header-bar {
            display: flex;
            flex-direction: column;
            /* Ï†úÎ™©Í≥º Î≤ÑÌäºÏùÑ ÏúÑÏïÑÎûòÎ°ú Î∞∞Ïπò */
            gap: 12px;
            /* Ï†úÎ™©-Î≤ÑÌäº ÏÇ¨Ïù¥ Í∞ÑÍ≤© */
            padding: 16px;
            background: #fff;
            border-bottom: 1px solid #f1f5f9;
            border-radius: 20px 20px 0 0;
        }

        .editor-title {
            font-size: 16px;
            font-weight: 800;
            color: #1e293b;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        /* Î≤ÑÌäºÎì§ÏùÑ Í∞êÏã∏Îäî ÏòÅÏó≠ (Ï§ÑÎ∞îÍøà ÌóàÏö©) */
        .header-btn-group {
            display: flex;
            flex-wrap: wrap;
            /* Í≥µÍ∞ÑÏù¥ Î∂ÄÏ°±ÌïòÎ©¥ Îã§Ïùå Ï§ÑÎ°ú ÎÑòÏñ¥Í∞ê */
            gap: 6px;
            width: 100%;
        }

        /* Î≤ÑÌäº Ïä§ÌÉÄÏùº Ï°∞Ï†ï (ÌÑ∞ÏπòÌïòÍ∏∞ ÏâΩÍ≤å ÍΩâ Ï±ÑÏö∞Í∏∞) */
        .header-btn-group button {
            flex-grow: 1;
            /* ÎÇ®ÏùÄ Í≥µÍ∞ÑÏùÑ Î≤ÑÌäºÎì§Ïù¥ ÎÇòÎà† Í∞ÄÏßê */
            display: flex;
            justify-content: center;
            align-items: center;
            white-space: nowrap;
            padding: 8px 12px;
            /* ÌÑ∞Ïπò ÏòÅÏó≠ ÌôïÎ≥¥ */
        }

        .main-controls {
            padding: 10px 16px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-panel {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.05);
        }

        .tab-menu {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            border-bottom: 2px solid #e0f2fe;
        }

        .tab-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background: transparent;
            font-size: 13px;
            font-weight: 700;
            color: #64748b;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: 0.2s;
        }

        .tab-btn.active {
            color: #0284c7;
            border-bottom-color: #0284c7;
            background: rgba(2, 132, 199, 0.05);
        }

        .style-section {
            display: none;
            flex-direction: column;
            gap: 12px;
        }

        .style-section.active {
            display: flex;
        }

        .bg-mode-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            margin-top: 5px;
        }

        .bg-mode-section.hidden {
            display: none;
        }

        .style-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 12px;
            font-weight: 700;
            color: #475569;
        }

        .slider-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            transition: opacity 0.2s;
        }

        .slider-row.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        /* Font Grid */
        .font-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 5px;
        }

        .font-btn {
            padding: 12px;
            border: 1px solid #cbd5e1;
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            text-align: center;
            transition: all 0.2s;
            color: #334155;
        }

        .font-btn:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }

        .font-btn.active {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #2563eb;
            font-weight: bold;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .slider-label {
            min-width: 40px;
            color: #64748b;
        }

        .val-display {
            min-width: 30px;
            text-align: right;
            font-family: monospace;
            color: #3b82f6;
            font-weight: bold;
        }

        /* Mini Color Inputs */
        .mini-color-row {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #fff;
            padding: 6px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            flex: 1;
        }

        .mini-preview {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid #ddd;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjgiPjxyZWN0IHdpZHRoPSI4IiBoZWlnaHQ9IjgiIGZpbGw9IiNmZmYiLz48cGF0aCBkPSJNTAgMEg0VjBIMHY0aDR2NHoiIGZpbGw9IiNjY2MiLz48L3N2Zz4=');
        }

        .mini-color-layer {
            width: 100%;
            height: 100%;
        }

        input[type="color"] {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            opacity: 0;
            cursor: pointer;
        }

        .mini-input {
            border: none;
            width: 100%;
            font-family: monospace;
            font-size: 12px;
            outline: none;
            background: transparent;
            color: #334155;
        }

        /* Preset & Buttons */
        .preset-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            overflow-x: visible;
            padding-bottom: 5px;
        }

        .btn-preset {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.1s;
            position: relative;
        }

        .btn-preset:active {
            transform: scale(0.9);
        }

        .btn-preset.deletable::after {
            content: '‚úñ';
            position: absolute;
            top: -5px;
            right: -5px;
            background: red;
            color: white;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            font-size: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn-save {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }

        .btn-save:hover {
            background: #2563eb;
        }

        .btn-reset {
            background: #fff0f0;
            color: #e11d48;
            border: 1px solid #fecdd3;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-style {
            background: #fff;
            color: #0f172a;
            border: 1px solid #cbd5e1;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn-style:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }

        .btn-fit {
            flex: 1;
            padding: 8px;
            border: 1px solid #cbd5e1;
            background: #fff;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-fit.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* Block List & Inputs */
        .block-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .block-item {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .block-tag {
            font-size: 11px;
            font-weight: 800;
            color: #94a3b8;
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 6px;
            text-transform: uppercase;
        }

        .block-controls {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .code-editor {
            width: 100%;
            height: 250px;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            outline: none;
            background: #fff;
            color: #1e293b;
            transition: border 0.2s;
            background-image: linear-gradient(135deg, transparent 50%, #94a3b8 50%),
                linear-gradient(135deg, transparent 50%, #94a3b8 50%);
            background-position: bottom 5px right 5px, bottom 5px right 10px;
            background-size: 8px 8px;
            background-repeat: no-repeat;
        }

        .code-editor:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .source-viewer {
            width: 100%;
            height: 70px;
            background: #1e293b;
            color: #e2e8f0;
            font-family: monospace;
            font-size: 11px;
            padding: 10px;
            border-radius: 8px;
            border: none;
            margin-top: 5px;
            resize: vertical;
            display: none;
            line-height: 1.4;
        }

        .source-viewer.show {
            display: block;
        }

        .source-label {
            font-size: 11px;
            color: #64748b;
            margin-top: 8px;
            margin-bottom: 4px;
            display: block;
            font-weight: 700;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        /* =========================================
       Preview / Card Styles
       ========================================= */
        .preview-container {
            padding: 40px 20px;
            width: 100%;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 60px;
            padding-bottom: 300px;
            min-height: 100vh;
        }

        #capture-area {
            background: transparent;
            transform-origin: top center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
            transition: width 0.3s, transform 0.2s ease-out;
        }

        .card-frame {
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            font-size: var(--base-sz, 45px);
            line-height: var(--base-lh, 1.7);

            --hl-bg: #fef08a;
            --hl-col: #000;
            --th-col: #64748b;
            --th-style: italic;
            --th-font: 'RIDIBatang', serif;
            --it-col: #64748b;
            --it-style: italic;
            --it-weight: 700;
            --bd-col: #000;
            --qt-col: #475569;
            --hr-col: #cbd5e1;
            --bb-l-bg: #ffffff;
            --bb-l-tx: #1e293b;
            --bb-r-bg: #3b82f6;
            --bb-r-tx: #ffffff;
            --para-sp: 27px;
        }

        .text-part {
            margin: 0 0 var(--para-sp, 1.2em) 0;
            text-align: var(--global-align, justify);
            word-break: var(--word-break, break-all);
            /* Updated Default */
            line-height: inherit;
        }

        /* Utility Classes */
        .align-left {
            text-align: left !important;
        }

        .align-center {
            text-align: center !important;
        }

        .align-right {
            text-align: right !important;
        }

        .align-justify {
            text-align: justify !important;
        }

        .size-up-1 {
            font-size: 1.2em;
            line-height: 1.6;
        }

        .size-up-2 {
            font-size: 1.4em;
            line-height: 1.5;
        }

        .size-down-1 {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .size-down-2 {
            font-size: 0.8em;
            opacity: 0.8;
        }

        /* Parsed Element Styles */
        .bubble-row {
            display: flex;
            margin-bottom: calc(var(--para-sp, 1.2em) * 0.7);
            width: 100%;
        }

        .bubble-row.left {
            justify-content: flex-start;
        }

        .bubble-row.right {
            justify-content: flex-end;
        }

        .bubble {
            max-width: 85%;
            padding: 0.6em 0.8em;
            border-radius: 30px;
            font-size: 1em;
            position: relative;
            line-height: inherit;
            word-break: break-all;
        }

        .bubble.left {
            background: var(--bb-l-bg);
            color: var(--bb-l-tx);
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-top-left-radius: 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .bubble.right {
            background: var(--bb-r-bg);
            color: var(--bb-r-tx);
            border-top-right-radius: 2px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .highlight-text {
            background: linear-gradient(to bottom, transparent 40%, var(--hl-bg) 40%);
            border-radius: 2px;
            padding: 0 2px;
            font-weight: 700;
            color: var(--hl-col);
        }

        .quote-text {
            color: var(--qt-col);
            font-weight: 700;
            display: block;
            margin: 0.5em 0;
            padding-left: 12px;
            border-left: 3px solid var(--qt-col);
        }

        .parsed-bold {
            font-weight: 800;
            color: var(--bd-col);
        }

        .parsed-italic {
            color: var(--it-col);
            font-size: 0.95em;
            font-weight: var(--it-weight);
            font-style: var(--it-style);
        }

        .parsed-thought {
            color: var(--th-col);
            font-size: 0.95em;
            font-style: italic;
            font-family: var(--th-font);
        }

        .parsed-h1 {
            font-size: 1.5em;
            font-weight: 800;
            margin: 0 0 var(--para-sp, 1.2em);
            color: inherit;
            letter-spacing: -0.5px;
            line-height: inherit;
        }

        .parsed-h2 {
            font-size: 1.2em;
            font-weight: 700;
            margin: 0 0 var(--para-sp, 1.2em);
            color: inherit;
            line-height: inherit;
        }

        .parsed-h3 {
            font-size: 1.1em;
            font-weight: 700;
            margin: 0 0 var(--para-sp, 1.2em);
            color: inherit;
            opacity: 0.9;
            line-height: inherit;
        }

        .parsed-hr {
            border: 0;
            height: 1px;
            background: var(--hr-col);
            margin: 1.5em 0;
        }

        /* Î¨∏Ïûê Î©îÏãúÏßÄ Ïä§ÌÉÄÏùº (Î∞±Ìã± ` ÏÇ¨Ïö©) */
        .sms-box {
            background-color: var(--sms-bg);
            color: var(--sms-tx);
            border: 1px solid rgba(0, 0, 0, 0.1);
            /* ÌÖåÎëêÎ¶¨Îäî Ïó∞ÌïòÍ≤å Í≥†Ï†ï */
            border-radius: 15px;
            padding: 2px 8px;
            font-family: 'Pretendard', sans-serif;
            font-size: 0.97em;
            display: inline-block;
            margin: 0 2px;
            vertical-align: middle;
        }

        #imgFileInput,
        #bgImgFileInput,
        #insertImgFileInput,
        #presetFileInput {
            display: none;
        }

        .editor-img-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .overlay-colors {
            display: flex;
            gap: 8px;
        }

        .btn-overlay {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            position: relative;
        }

        .btn-overlay.selected::after {
            content: '‚úî';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 10px;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            background: #fff;
            cursor: pointer;
        }

        .btn-group {
            display: flex;
            gap: 4px;
        }

        .lock-chk {
            appearance: none;
            width: 20px;
            height: 20px;
            cursor: pointer;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='11' width='18' height='11' rx='2' ry='2'%3E%3C/rect%3E%3Cpath d='M7 11V7a5 5 0 0 1 10 0v4'%3E%3C/path%3E%3C/svg%3E");
            margin-left: 5px;
        }

        .lock-chk:checked {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ef4444' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='11' width='18' height='11' rx='2' ry='2'%3E%3C/rect%3E%3Cpath d='M7 11V7a5 5 0 0 1 10 0v4'%3E%3C/path%3E%3C/svg%3E");
        }

        input[type="range"]:disabled,
        input[type="number"]:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        /* =========================================
       Ruler Guides (ÎààÍ∏à)
       ========================================= */
        .ruler-guide {
            position: absolute;
            width: 20px;
            /* ÎààÍ∏à Í∏∏Ïù¥ */
            height: 1px;
            /* ÎààÍ∏à ÎëêÍªò */
            background-color: #94a3b8;
            /* ÎààÍ∏à ÏÉâÏÉÅ (ÏßÑÌïú ÌöåÏÉâ) */
            z-index: 100;
            /* Ïπ¥ÎìúÎ≥¥Îã§ ÏúÑÏóê ÌëúÏãú */
            pointer-events: none;
            /* ÌÅ¥Î¶≠ ÌÜµÍ≥º */
        }

        /* ÎààÍ∏à ÏòÜÏóê Î∂ôÎäî ÏûëÏùÄ ÎùºÎ≤® (1/2, 1/3 Îì±) */
        .ruler-guide::after {
            content: attr(data-label);
            position: absolute;
            font-size: 10px;
            font-family: monospace;
            color: #64748b;
            top: -6px;
        }

        /* ÏôºÏ™Ω ÎààÍ∏à ÏúÑÏπò Î∞è ÎùºÎ≤® Ï†ïÎ†¨ */
        .guide-left {
            left: -25px;
        }

        .guide-left::after {
            right: 25px;
        }

        /* ÎùºÎ≤®ÏùÑ ÎààÍ∏à ÏôºÏ™ΩÏóê */

        /* Ïò§Î•∏Ï™Ω ÎààÍ∏à ÏúÑÏπò Î∞è ÎùºÎ≤® Ï†ïÎ†¨ */
        .guide-right {
            right: -25px;
        }

        .guide-right::after {
            left: 25px;
        }

        /* ÎùºÎ≤®ÏùÑ ÎààÍ∏à Ïò§Î•∏Ï™ΩÏóê */


        /* =========================================
       Responsive: PC Layout (>= 1024px)
       ========================================= */
        @media screen and (min-width: 1024px) {
            .editor-area {
                width: 420px;
                height: 100vh !important;
                max-height: none;
                top: 0;
                left: 0;
                bottom: auto;
                border-top: none;
                border-right: 1px solid #cbd5e1;
                border-radius: 0 20px 20px 0;
                transform: translateX(0);
            }

            .editor-area.collapsed {
                transform: translateX(-100%);
            }

            .index-handle {
                top: 50%;
                left: 100%;
                right: auto;
                transform: translateY(-50%);
                width: 40px;
                height: 100px;
                border-radius: 0 10px 10px 0;
                border-bottom: 1px solid #cbd5e1;
                border-left: none;
                flex-direction: column;
                writing-mode: vertical-rl;
                text-orientation: mixed;
                gap: 10px;
            }

            #foldIcon {
                transform: rotate(90deg);
                display: inline-block;
            }

            body {
                transition: padding-left 0.4s cubic-bezier(0.25, 1, 0.5, 1);
                padding-left: 420px;
            }

            body:has(.editor-area.collapsed) {
                padding-left: 0;
            }

            .preview-container {
                padding-top: 40px;
                align-items: center;
            }

            .zoom-wrapper {
                left: auto;
                right: 40px;
            }
        }

        /* =========================================
   Regex Modal Styles (Multi-Row Support)
   ========================================= */
        #regexModal {
            display: none;
            flex-direction: column;
            gap: 12px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
            width: 400px;
            max-height: 80vh;
            /* Í∏∏Ïñ¥ÏßÄÎ©¥ Ïä§ÌÅ¨Î°§ */
            padding: 20px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalPop {
            from {
                opacity: 0;
                transform: translate(-50%, -45%) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .regex-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 12px;
        }

        .regex-title {
            font-size: 16px;
            font-weight: 800;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .regex-close-btn {
            border: none;
            background: #f1f5f9;
            color: #64748b;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }

        .regex-close-btn:hover {
            background: #e2e8f0;
            color: #ef4444;
        }

        /* ÌîÑÎ¶¨ÏÖã Î≤ÑÌäº */
        .regex-preset-box {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .btn-regex-preset {
            font-size: 11px;
            font-weight: 600;
            padding: 6px 10px;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 16px;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-regex-preset:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }

        /* Í∑úÏπô Î¶¨Ïä§Ìä∏ ÏòÅÏó≠ (Ïä§ÌÅ¨Î°§ Í∞ÄÎä•) */
        #regexListContainer {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            flex: 1;
            min-height: 100px;
            padding-right: 4px;
        }

        .regex-row-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 12px;
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            position: relative;
            animation: fadeIn 0.2s ease-out;
        }

        .regex-row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            color: #64748b;
            font-weight: 700;
        }

        .regex-inputs-row {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .regex-mini-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
            outline: none;
            width: 100%;
        }

        .regex-mini-input:focus {
            border-color: #3b82f6;
            background: #fff;
        }

        .btn-del-row {
            background: #fee2e2;
            color: #ef4444;
            border: 1px solid #fecaca;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
        }

        .btn-add-rule {
            width: 100%;
            padding: 8px;
            background: white;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            color: #64748b;
            font-weight: 700;
            cursor: pointer;
            font-size: 12px;
            transition: 0.2s;
        }

        .btn-add-rule:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }

        /* ÌïòÎã® Ïã§Ìñâ Î≤ÑÌäº */
        .regex-btn-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            padding-top: 10px;
            border-top: 1px solid #f1f5f9;
        }

        .btn-regex-run {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #4f46e5, #3b82f6);
            color: white;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-regex-all {
            flex: 1;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            background: #ffffff;
            color: #475569;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
        }

        .btn-regex-all:hover {
            background: #f1f5f9;
            color: #0f172a;
        }


        /* Î≤ÑÌäº Í∑∏Î£π */
        .regex-btn-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-regex-run {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #4f46e5, #3b82f6);
            color: white;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .btn-regex-run:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-regex-run:active {
            transform: scale(0.98);
        }

        .btn-regex-all {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: #ffffff;
            border: 1px solid #cbd5e1;
            color: #475569;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-regex-all:hover {
            background: #f1f5f9;
            color: #0f172a;
            border-color: #94a3b8;
        }

        /* =========================================
           Bookmarklet Modal Styles
           ========================================= */
        #bookmarkletModal {
            display: none;
            flex-direction: column;
            gap: 15px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
            width: 380px;
            padding: 24px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            text-align: center;
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .bookmarklet-pill {
            display: inline-block;
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 800;
            font-size: 15px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            cursor: grab;
            /* ÎìúÎûòÍ∑∏ Í∞ÄÎä•Ìïú ÎäêÎÇå */
            border: 2px dashed #93c5fd;
            transition: transform 0.2s;
        }

        .bookmarklet-pill:hover {
            transform: scale(1.05);
            background: #2563eb;
        }

        .bookmarklet-desc {
            font-size: 13px;
            color: #64748b;
            line-height: 1.5;
            margin-bottom: 10px;
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
        }

        /* Ï≤¥ÌÅ¨Î∞ïÏä§ ÏïÑÏù¥ÌÖú Ïä§ÌÉÄÏùº */
        .check-box-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            background: #f8fafc;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: 0.2s;
        }
        .check-box-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        .check-box-item input[type="checkbox"] {
            accent-color: #8b5cf6;
            width: 16px; 
            height: 16px;
        }


        /* Ïä¨ÎùºÏù¥Îçî ÏÉâÏÉÅ Í∞ïÏ†ú ÌÜµÏùº */
        input[type="range"] {
            accent-color: #3b82f6;
            /* ÌååÎûÄÏÉâ (ÌÖåÎßàÏÉâ) */
            cursor: pointer;
        }

        /* =========================================
           [NEW] WNCS ÎåìÍ∏ÄÏ∞Ω Ïä§ÌÉÄÏùº (ÏÇ¨Ïö©Ïûê ÎπÑÏú® Ï°∞Ï†à Ï†ÅÏö©)
           ========================================= */
        /* ÌïµÏã¨: font-sizeÎ•º calc(var(--base-sz) * var(--wncs-scale))Î°ú ÏÑ§Ï†ïÌïòÏó¨
           Ï†ÑÏ≤¥ Ìè∞Ìä∏ ÌÅ¨Í∏∞(--base-sz)ÏôÄ ÎåìÍ∏Ä ÎπÑÏú®(--wncs-scale)Ïóê Îî∞Îùº Ïú†ÎèôÏ†ÅÏúºÎ°ú Î≥ÄÌïòÍ≤å Ìï®.
        */
        .wncs-details { 
            background: #1e1e1e; 
            margin: 15px 0; 
            border: 1px solid #333; 
            border-radius: 8px; 
            font-family: 'Noto Sans KR', sans-serif; 
            text-align: left;
            font-size: calc(var(--base-sz, 45px) * var(--wncs-scale, 0.35)); /* Ïó¨Í∏∞Í∞Ä ÌïµÏã¨! */
            line-height: 1.6;
        }
        
        /* Ïù¥Ï†ú ÎÇ¥Î∂ÄÎäî 1em Í∏∞Ï§ÄÏúºÎ°ú ÏûëÏÑ±ÌïòÎ©¥ Î∂ÄÎ™® ÌÅ¨Í∏∞Î•º Îî∞ÎùºÍ∞ëÎãàÎã§ */
        .wncs-summary { cursor: pointer; padding: 0.5em 1.2em; font-weight: bold; font-size: 1em; color: #e0e0e0; background: #282828; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; transition: .2s; }
        .wncs-summary-ep { font-weight: 400; font-size: 0.9em; color: #bbbbbb; }
        .wncs-details .wncs-summary:hover { background: #303030; }
        .wncs-details[open] .wncs-summary { border-bottom: 1px solid #333; }
        
        .wncs-container { padding: 1em 1.4em; color: #c9c9c9; background: #222; border-radius: 0 0 8px 8px; }
        
        .wncs-author-note { background: #191919; padding: 0.4em 1em 0.9em 1em; border: 1px solid #333; border-radius: 6px; margin-bottom: 1em; }
        .wncs-author-title { font-size: 0.9em; font-weight: 600; color: #26f2a4; margin-bottom: 0.1em; }
        .wncs-author-content { font-size: 0.95em; line-height: 1.8; color: #d0d0d0; white-space: pre-wrap; }
        
        .wncs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.7em; padding-bottom: 0.7em; border-bottom: 1px solid #383838; }
        .wncs-header h2 { font-size: 1.4em; color: #e0e0e0; margin: 0; }
        .wncs-header-filters span { margin-left: 1em; cursor: pointer; color: #aaa; font-size: 1em; padding: 0.3em 0.6em; border-radius: 4px; }
        .wncs-filter-active { color: #e0e0e0; font-weight: bold; background: #333; }
        
        .wncs-comment-thread { margin-bottom: 0.7em; }
        .wncs-comment { border-bottom: 1px dotted #444; }
        .wncs-main-comment { padding: 0; }
        
        .wncs-best-badge { background: transparent; color: #3bff8a; border: 1px solid #3bff8a; padding: 0.1em 0.5em; font-size: 0.75em; line-height: 1; font-weight: bold; border-radius: 9999px; margin-right: 0.4em; vertical-align: middle; }
        
        .wncs-comment-meta { display: flex; align-items: center; font-size: 0.9em; color: #aaa; margin-bottom: 0.2em; }
        .wncs-nickname { color: #c9c9c9; font-weight: 450; margin-right: 0.7em; }
        .wncs-date { margin-left: auto; margin-right: 0.4em; font-size: 0.9em; color: #888; }
        .wncs-options-button { color: #777; font-size: 1.1em; padding: 0 0.3em; background: none; border: none; cursor: pointer; }
        
        .wncs-comment-content { font-size: 1em; line-height: 1.6; color: #f5f5f5; white-space: pre-wrap; }
        
        .wncs-comment-actions { margin-top: 0.3em; display: flex; align-items: center; font-size: 1em; padding-bottom: 0.6em; }
        .wncs-episode { font-size: 0.85em; color: #888; margin-right: auto; }
        .wncs-like-button, .wncs-reply-button { background: none; border: none; color: #999; cursor: pointer; padding: 0.3em 0.6em; display: inline-flex; align-items: center; border-radius: 4px; transition: .2s; font-size: 1em; }
        .wncs-like-button { margin-right: 0.3em; }
        .wncs-like-icon, .wncs-reply-icon { font-size: 1.1em; margin-right: 0.3em; }
        
        .wncs-reply-toggle-checkbox { position: absolute; left: -9999px; width: 0; height: 0; opacity: 0; }
        .wncs-replies-container { display: none; margin-left: 1.8em; border-left: 2px solid #404040; margin-top: 0.7em; }
        .wncs-reply-toggle-checkbox:checked ~ .wncs-replies-container { display: block; }
        .wncs-replies-elevated { background: #262626; border-left: 3px solid #3b8c6e; border-radius: 6px; margin: 0.7em 0 1.2em 0; padding: 0.8em 1.2em; box-shadow: 0 2px 4px rgba(0,0,0,.35); }
        .wncs-reply-comment { padding: 0.6em 0; border-bottom: 1px solid #3a3a3a; }
        .wncs-reply-comment:first-child { padding-top: 0; }
        .wncs-reply-comment:last-child { padding-bottom: 0; border-bottom: none; }
        .wncs-reply-comment .wncs-nickname { font-size: 0.9em; }       
        /* ‚îÄ‚îÄ ÏÉÅÎã® ÏöîÏïΩ ‚îÄ‚îÄ */
        .wncs-summary { cursor: pointer; padding: 6px 18px; font-weight: bold; font-size: 0.35em; color: #e0e0e0; background: #282828; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; transition: .2s; }
        .wncs-summary-ep { font-weight: 400; font-size: 0.9em; color: #bbbbbb; } /* Î∂ÄÎ™® ÎåÄÎπÑ 0.9 */
        .wncs-details .wncs-summary:hover { background: #303030; }
        .wncs-details[open] .wncs-summary { border-bottom: 1px solid #333; }
        
        /* ‚îÄ‚îÄ Ïª®ÌÖåÏù¥ÎÑà ‚îÄ‚îÄ */
        .wncs-container { padding: 15px 20px; color: #c9c9c9; background: #222; border-radius: 0 0 8px 8px; }
        
        /* ‚îÄ‚îÄ ÏûëÍ∞ÄÏùò Îßê ‚îÄ‚îÄ */
        .wncs-author-note { background: #191919; padding: 5px 14px 12px 14px; border: 1px solid #333; border-radius: 6px; margin-bottom: 14px; }
        .wncs-author-title { font-size: 0.3em; font-weight: 600; color: #26f2a4; margin-bottom: 1px; }
        .wncs-author-content { font-size: 0.3em; line-height: 1.8; color: #d0d0d0; white-space: pre-wrap; }
        
        /* ‚îÄ‚îÄ Ìó§Îçî (ÎåìÍ∏Ä Ïàò) ‚îÄ‚îÄ */
        .wncs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #383838; }
        .wncs-header h2 { font-size: 0.5em; color: #e0e0e0; margin: 0; }
        .wncs-header-filters span { margin-left: 15px; cursor: pointer; color: #aaa; font-size: 0.35em; padding: 4px 8px; border-radius: 4px; }
        .wncs-filter-active { color: #e0e0e0; font-weight: bold; background: #333; }
        
        /* ‚îÄ‚îÄ ÎåìÍ∏Ä ‚îÄ‚îÄ */
        .wncs-comment-thread { margin-bottom: 10px; }
        .wncs-comment { border-bottom: 1px dotted #444; }
        .wncs-main-comment { padding: 0; }
        
        /* BEST Î±ÉÏßÄ */
        .wncs-best-badge { background: transparent; color: #3bff8a; border: 1px solid #3bff8a; padding: 2px 8px; font-size: 0.25em; line-height: 1; font-weight: bold; border-radius: 9999px; margin-right: 5px; vertical-align: middle; }
        
        /* Î©îÌÉÄ Ï†ïÎ≥¥ */
        .wncs-comment-meta { display: flex; align-items: center; font-size: 0.3em; color: #aaa; margin-bottom: 2px; }
        .wncs-nickname { color: #c9c9c9; font-weight: 450; margin-right: 10px; }
        .wncs-date { margin-left: auto; margin-right: 6px; font-size: 0.9em; color: #888; }
        .wncs-options-button { color: #777; font-size: 1.2em; padding: 0 5px; background: none; border: none; cursor: pointer; }
        
        /* Î≥∏Î¨∏ (ÌïµÏã¨: 0.35em = Í∏∞Î≥∏ 45pxÏùº Îïå ÏïΩ 15.75px) */
        .wncs-comment-content { font-size: 0.35em; line-height: 1.6; color: #f5f5f5; white-space: pre-wrap; }
        
        /* Ïï°ÏÖò ÎùºÏù∏ */
        .wncs-comment-actions { margin-top: 4px; display: flex; align-items: center; font-size: 0.35em; padding-bottom: 8px; }
        .wncs-episode { font-size: 0.8em; color: #888; margin-right: auto; }
        .wncs-like-button, .wncs-reply-button { background: none; border: none; color: #999; cursor: pointer; padding: 4px 8px; display: inline-flex; align-items: center; border-radius: 4px; transition: .2s; font-size: 1em; }
        .wncs-like-button { margin-right: 4px; }
        .wncs-like-icon, .wncs-reply-icon { font-size: 1.1em; margin-right: 5px; }
        
        /* ÎåÄÎåìÍ∏Ä */
        .wncs-reply-toggle-checkbox { position: absolute; left: -9999px; width: 0; height: 0; opacity: 0; }
        .wncs-replies-container { display: none; margin-left: 25px; border-left: 2px solid #404040; margin-top: 10px; }
        .wncs-reply-toggle-checkbox:checked ~ .wncs-replies-container { display: block; }
        .wncs-replies-elevated { background: #262626; border-left: 3px solid #3b8c6e; border-radius: 6px; margin: 10px 0 18px 0px; padding: 12px 18px; box-shadow: 0 2px 4px rgba(0,0,0,.35); }
        .wncs-reply-comment { padding: 8px 0; border-bottom: 1px solid #3a3a3a; }
        .wncs-reply-comment:first-child { padding-top: 0; }
        .wncs-reply-comment:last-child { padding-bottom: 0; border-bottom: none; }
        .wncs-reply-comment .wncs-nickname { font-size: 0.9em; } /* ÎåÄÎåìÍ∏Ä ÎãâÎÑ§ÏûÑ */
        
                
    </style>
</head>

<body>

    <div class="zoom-wrapper" id="zoomWrapper">
        <div class="zoom-trigger" onclick="toggleZoomMenu(event)">üîç</div>
        <div class="zoom-menu" id="zoomMenu">
            <button class="btn-sm" onclick="setZoom('in')">‚ûï</button>
            <input type="range" id="zoomRange" min="10" max="200" value="100" oninput="manualZoom(this.value)">
            <button class="btn-sm" onclick="setZoom('out')">‚ûñ</button>
            <span id="zoomLabel" class="zoom-label" style="font-size:10px; font-weight:800;">Auto</span>
            <button class="btn-sm" style="font-size: 10px; margin-top:5px; padding: 4px;"
                onclick="setZoom('auto')">FIT</button>
        </div>
    </div>

    <div class="preview-container">
        <div id="capture-area"></div>
    </div>

    <div class="editor-area collapsed" id="editorArea">

        <div class="index-handle" onclick="toggleEditor()">
            <span id="foldIcon">‚ñ≤</span> EDITOR
        </div>

        <div class="editor-header-bar" onclick="toggleEditor()">
            <div class="editor-title">Î°úÍ∑∏ Ïπ¥Îìú ÏÉùÏÑ±Í∏∞ v1.8.1</div>
            <div class="header-btn-group">
                <button class="btn-reset" onclick="resetAll(event)" title="Ï¥àÍ∏∞Ìôî">üîÑ</button>
                <button class="btn-reset" style="background:#f3e8ff; color:#6b21a8; border-color:#d8b4fe;"
                    onclick="exportProject()" title="ÌîÑÎ°úÏ†ùÌä∏ Ï†ÄÏû• (JSON)">üì§ ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
                <button class="btn-reset" style="background:#f3e8ff; color:#6b21a8; border-color:#d8b4fe;"
                    onclick="document.getElementById('projectFileInput').click()" title="ÌîÑÎ°úÏ†ùÌä∏ Î∂àÎü¨Ïò§Í∏∞ (JSON)">üì•
                    Î∂àÎü¨Ïò§Í∏∞</button>

                <input type="file" id="projectFileInput" accept=".json" onchange="loadProject(this)"
                    style="display: none;">

                <button class="btn-reset"
                    style="background:#fae8ff; color:#86198f; border-color:#f0abfc; font-weight:bold;"
                    onclick="document.getElementById('autoLogInput').click()"
                    title="txt ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ ÏõêÌïòÎäî ÌïÑÌÑ∞Î•º Ï†ÅÏö©Ìï¥ Î∂àÎü¨ÏòµÎãàÎã§.">üìÑ TXT Í∞ÄÏ†∏Ïò§Í∏∞</button>

                <input type="file" id="autoLogInput" accept=".txt" onchange="openTxtImportModal(this)"
                    style="display: none;">

                <button class="btn-reset" style="background:#eef2ff; color:#4f46e5; border-color:#c7d2fe;"
                    onclick="openRegexModal(-1)" title="Ï†ïÍ∑úÏãù">¬ÆÔ∏è</button>
                <button class="btn-reset" style="background:#e0e7ff; color:#4338ca; border-color:#c7d2fe;"
                    onclick="openCssModal()" title="ÏÇ¨Ïö©Ïûê CSS Ï∂îÍ∞Ä">‚ú®CSS</button>
                <button class="btn-reset" style="background:#fffbeb; color:#b45309; border-color:#fcd34d;"
                    onclick="openBookmarkletModal()" title="ÏºÄÏù¥Î∏åÎçï Ï†ÄÏû• Î∂ÅÎßàÌÅ¨Î¶ø ÎßåÎì§Í∏∞">üîñ Î∂ÅÎßàÌÅ¨Î¶ø ÏÉùÏÑ±</button>
                <button class="btn-reset" style="background:#f0fdf4; color:#15803d; border-color:#bbf7d0;"
                    onclick="setAllVisibility(true)" title="Î™®Îëê Î≥¥Ïù¥Í∏∞">üëÅÔ∏èAll</button>
                <button class="btn-reset" style="background:#fef2f2; color:#ef4444; border-color:#fecaca;"
                    onclick="setAllVisibility(false)" title="Î™®Îëê Ïà®Í∏∞Í∏∞">üôàAll</button>
                <button class="btn-reset" style="background:#fff7ed; color:#c2410c; border-color:#ffedd5;"
                    onclick="splitAllBlocks()" title="ÎÇòÎàÑÍ∏∞">‚úÇÔ∏èAll</button>
                <button class="btn-reset" style="background:#e0f2fe; color:#0369a1; border-color:#bae6fd;" 
                    onclick="mergeAllBlocks()" title="Ìï©ÏπòÍ∏∞">üß¥All</button>
                <button class="btn-reset" style="background:#fee2e2; color:#b91c1c; border-color:#fecaca;"
                    onclick="deleteAllBlocks()" title="ÏÇ≠Ï†ú">üóëÔ∏èAll</button>
                <button class="btn-save" style="background:#475569; " onclick="event.stopPropagation(); saveHtml()">üíæ
                    HTML Ï†ÄÏû•</button>
                <button class="btn-save" style="background:#0f766e;" onclick="event.stopPropagation(); copySafeHtml()">
                    üìã HTML Î≥µÏÇ¨
                </button>
                <button class="btn-save" style="padding: 8px 10px;"
                    onclick="event.stopPropagation(); saveImage(this, 'standard')">üì∑ Í∏∞Î≥∏ Ï†ÄÏû•</button>
                <button class="btn-save" style="background:#334155; padding: 8px 10px;"
                    onclick="event.stopPropagation(); saveImage(this, 'high')">‚ú® Í≥†ÌôîÏßà Ï†ÄÏû•</button>

            </div>
        </div>

        <div class="main-controls">
            <span style="font-size:13px; font-weight:bold;">Ïπ¥Îìú Ìè≠:</span>
            <input type="number" id="cardWidthInput" value="1080" step="10" max="3000"
                style="width:70px; padding:6px; border:1px solid #cbd5e1; border-radius:6px;"
                oninput="updatePreview(); saveData();"> px
            <div style="flex-grow:1"></div>
            <button id="btnStyleToggle" class="btn-style" onclick="toggleStylePanel()">üé® Ïä§ÌÉÄÏùº ÏÑ§Ï†ï ‚ñº</button>
        </div>

        <div id="editorContent" class="editor-content-wrapper">

            <div id="styleBody" class="control-panel" style="display:none;">
                <div class="style-row">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span>üé® Ïä§ÌÉÄÏùº & ÌîÑÎ¶¨ÏÖã:</span>
                        <div class="btn-group">
                            <button class="btn-sm" onclick="saveCurrentToPreset()">üíæ ÌòÑÏû¨ ÏÑ§Ï†ï Ï†ÄÏû•</button>
                            <button class="btn-sm" onclick="exportPresets()">üì§ ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
                            <button class="btn-sm" onclick="document.getElementById('presetFileInput').click()">üì•
                                Î∂àÎü¨Ïò§Í∏∞</button>
                        </div>
                    </div>
                    <div id="presetList" class="preset-container"></div>
                </div>

                <div class="tab-menu" style="margin-top:10px;">
                    <button class="tab-btn active" onclick="switchTab('base', event)">Î∞∞Í≤Ω & Ìè∞Ìä∏</button>
                    <button class="tab-btn" onclick="switchTab('detail', event)">ÎîîÌÖåÏùº ÏÉâÏÉÅ</button>
                </div>

                <div id="sect-base" class="style-section active">
                    <div id="grad-controls" class="bg-mode-section active">
                        <div class="style-row">
                            <span style="display:flex; justify-content:space-between;">
                                <span>üåà Î∞∞Í≤ΩÏÉâ (Í∑∏ÎùºÎç∞Ïù¥ÏÖò):</span>
                                <label style="font-weight:normal; font-size:11px;"><input type="checkbox"
                                        id="showImgOption" onchange="toggleImgPanel(this.checked); saveData();"> Ïù¥ÎØ∏ÏßÄ Î∞∞Í≤Ω
                                    ÏÇ¨Ïö©</label>
                            </span>
                        </div>
                        <div class="style-row">
                            <span>ÏãúÏûëÏÉâ:</span>
                            <div class="mini-color-row">
                                <div class="mini-preview" onclick="openPicker('bg1', 'ÏãúÏûëÏÉâ')">
                                    <div id="bg1-pv" class="mini-color-layer"></div>
                                </div>
                                <input type="text" id="bg1-txt" class="mini-input"
                                    onchange="setColor('bg1',this.value)">
                            </div>
                        </div>
                        <div class="style-row">
                            <span>ÎÅùÏÉâ:</span>
                            <div class="mini-color-row">
                                <div class="mini-preview" onclick="openPicker('bg2', 'ÎÅùÏÉâ')">
                                    <div id="bg2-pv" class="mini-color-layer"></div>
                                </div>
                                <input type="text" id="bg2-txt" class="mini-input"
                                    onchange="setColor('bg2',this.value)">
                            </div>
                        </div>
                        <div class="style-row">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span>Í∞ÅÎèÑ:</span>
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <input type="number" id="input-gradAngle" class="val-display" value="235"
                                        style="width:55px; border:1px solid #e2e8f0; border-radius:4px; text-align:right;"
                                        oninput="syncSlider('gradAngle', this.value)"> ¬∞
                                    <input type="checkbox" class="lock-chk" title="Ïû†Í∏à"
                                        onchange="const d=this.checked; document.getElementById('gradAngle').disabled=d; document.getElementById('input-gradAngle').disabled=d;">
                                </div>
                            </div>
                            <input type="range" id="gradAngle" min="0" max="360" value="235"
                                oninput="syncInput('gradAngle', this.value)">
                        </div>
                    </div>

                    <div id="img-controls" class="bg-mode-section hidden">
                        <div class="style-row"><span>üñºÔ∏è Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï:</span></div>
                        <button class="btn-style" style="width:100%;"
                            onclick="document.getElementById('bgImgFileInput').click()">üìÇ Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù</button>
                        <input type="file" id="bgImgFileInput" accept="image/*" onchange="handleBgUpload(this)">

                        <div class="style-row" style="margin-top:5px;">
                            <div style="display:flex; justify-content:space-between;">
                                <span>Ïù¥ÎØ∏ÏßÄ Ï°∞Ï†ï:</span>
                                <button class="btn-sm" onclick="resetBgPos()">üîÑ Ï¥àÍ∏∞Ìôî</button>
                            </div>

                            <div class="style-row"
                                style="background:#fff; padding:8px; border-radius:6px; border:1px solid #cbd5e1;">
                                <div id="row-bgScale" class="slider-row"
                                    style="display:flex; align-items:center; gap:8px;">
                                    <span class="slider-label">ÌÅ¨Í∏∞:</span>
                                    <input type="range" id="bgScale" min="10" max="400" value="100" style="flex:1"
                                        oninput="syncInput('bgScale', this.value)">
                                    <input type="number" id="input-bgScale" class="val-display" value="100"
                                        style="width:55px; border:1px solid #e2e8f0; border-radius:4px; text-align:right;"
                                        oninput="syncSlider('bgScale', this.value)">%
                                    <input type="checkbox" class="lock-chk" title="Ïû†Í∏à"
                                        onchange="const d=this.checked; document.getElementById('bgScale').disabled=d; document.getElementById('input-bgScale').disabled=d;">
                                </div>
                                <div id="row-bgPosX" class="slider-row"
                                    style="display:flex; align-items:center; gap:8px;">
                                    <span class="slider-label">Í∞ÄÎ°ú:</span>
                                    <input type="range" id="bgPosX" min="0" max="100" value="50" style="flex:1"
                                        oninput="syncInput('bgPosX', this.value)">
                                    <input type="number" id="input-bgPosX" class="val-display" value="50"
                                        style="width:55px; border:1px solid #e2e8f0; border-radius:4px; text-align:right;"
                                        oninput="syncSlider('bgPosX', this.value)">%
                                    <input type="checkbox" class="lock-chk" title="Ïû†Í∏à"
                                        onchange="const d=this.checked; document.getElementById('bgPosX').disabled=d; document.getElementById('input-bgPosX').disabled=d;">
                                </div>
                                <div id="row-bgPosY" class="slider-row"
                                    style="display:flex; align-items:center; gap:8px;">
                                    <span class="slider-label">ÏÑ∏Î°ú:</span>
                                    <input type="range" id="bgPosY" min="0" max="100" value="50" style="flex:1"
                                        oninput="syncInput('bgPosY', this.value)">
                                    <input type="number" id="input-bgPosY" class="val-display" value="50"
                                        style="width:55px; border:1px solid #e2e8f0; border-radius:4px; text-align:right;"
                                        oninput="syncSlider('bgPosY', this.value)">%
                                    <input type="checkbox" class="lock-chk" title="Ïû†Í∏à"
                                        onchange="const d=this.checked; document.getElementById('bgPosY').disabled=d; document.getElementById('input-bgPosY').disabled=d;">
                                </div>
                            </div>

                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <button class="btn-fit" id="btnCover" onclick="setBgSize('cover'); saveData();">Ï±ÑÏö∞Í∏∞
                                    (Cover)</button>
                                <button class="btn-fit active" id="btnContain"
                                    onclick="setBgSize('contain'); saveData();">ÎßûÏ∂§ (Contain)</button>
                            </div>
                            <p style="font-size:10px; color:#64748b; margin:0;">‚Äª Ï±ÑÏö∞Í∏∞ Î™®ÎìúÎäî ÎπàÌãàÏóÜÏù¥ Ï±ÑÏö∞Í∏∞ ÏúÑÌï¥ ÌÅ¨Í∏∞/ÏúÑÏπò Ï°∞Ï†àÏù¥ Í≥†Ï†ïÎê©ÎãàÎã§.
                            </p>
                        </div>

                        <div class="style-row">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span>Ïò§Î≤ÑÎ†àÏù¥ Î∂àÌà¨Î™ÖÎèÑ:</span>
                                <div style="display:flex; align-items:center; gap:5px;">
                                    <input type="number" id="input-overlayAlpha" class="val-display" value="0.5"
                                        step="0.05"
                                        style="width:55px; border:1px solid #e2e8f0; border-radius:4px; text-align:right;"
                                        oninput="syncSlider('overlayAlpha', this.value)">
                                    <input type="checkbox" class="lock-chk" title="Ïû†Í∏à"
                                        onchange="const d=this.checked; document.getElementById('overlayAlpha').disabled=d; document.getElementById('input-overlayAlpha').disabled=d;">
                                </div>
                            </div>
                            <input type="range" id="overlayAlpha" style="width:100%;" min="0" max="1" step="0.05"
                                value="0.5" oninput="syncInput('overlayAlpha', this.value)">
                        </div>
                    </div>

                    <div class="style-row">
                        <span>Ìè∞Ìä∏ ÏÑ†ÌÉù:</span>
                        <input type="hidden" id="fontSelect" value="Pretendard, sans-serif">
                        <div class="font-grid" id="fontBtnContainer">
                            <button class="font-btn active" style="font-family: 'Pretendard', sans-serif;"
                                onclick="setFont('Pretendard, sans-serif')">ÌîÑÎ¶¨ÌÖêÎã§Îìú</button>
                            <button class="font-btn" style="font-family: 'Noto Sans KR', sans-serif;"
                                onclick="setFont('\'Noto Sans KR\', sans-serif')">Î≥∏Í≥†Îîï (Noto)</button>
                            <button class="font-btn" style="font-family: 'Nanum Gothic', sans-serif;"
                                onclick="setFont('\'Nanum Gothic\', sans-serif')">ÎÇòÎàîÍ≥†Îîï</button>
                            <button class="font-btn" style="font-family: 'Cafe24SsurroundAir', sans-serif;"
                                onclick="setFont('\'Cafe24SsurroundAir\', sans-serif')">ÏÑúÎùºÏö¥Îìú Air</button>

                            <button class="font-btn" style="font-family: 'Ridibatang', serif;"
                                onclick="setFont('\'Ridibatang\', serif')">Î¶¨ÎîîÎ∞îÌÉï</button>
                            <button class="font-btn" style="font-family: 'KoPub World Batang', serif;"
                                onclick="setFont('\'KoPub World Batang\', serif')">KoPubÎ∞îÌÉï</button>
                            <button class="font-btn" style="font-family: 'Noto Serif KR', serif;"
                                onclick="setFont('\'Noto Serif KR\', serif')">Î≥∏Î™ÖÏ°∞ (Noto)</button>
                            <button class="font-btn" style="font-family: 'MaruBuri', serif;"
                                onclick="setFont('\'MaruBuri\', serif')">ÎßàÎ£®Î∂ÄÎ¶¨</button>

                            <button class="font-btn" style="font-family: 'Gowun Dodum', sans-serif;"
                                onclick="setFont('\'Gowun Dodum\', sans-serif')">Í≥†Ïö¥ÎèãÏõÄ</button>
                            <button class="font-btn" style="font-family: 'Gowun Batang', serif;"
                                onclick="setFont('\'Gowun Batang\', serif')">Í≥†Ïö¥Î∞îÌÉï</button>
                            <button class="font-btn" style="font-family: 'Nanum Pen Script', cursive; font-size:15px;"
                                onclick="setFont('\'Nanum Pen Script\', cursive')">ÎÇòÎàîÏÜêÍ∏ÄÏî®</button>
                        </div>
                    </div>

                    <div class="style-row">
                        <span>Í∏∞Î≥∏ Ï†ïÎ†¨:</span>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-fit" id="align-left" onclick="setAlign('left')">Left</button>
                            <button class="btn-fit" id="align-center" onclick="setAlign('center')">Center</button>
                            <button class="btn-fit" id="align-right" onclick="setAlign('right')">Right</button>
                            <button class="btn-fit active" id="align-justify"
                                onclick="setAlign('justify')">Justify</button>
                        </div>
                        <input type="hidden" id="textAlignInput" value="justify">
                    </div>

                    <div class="style-row">
                        <span>Ï§ÑÎ∞îÍøà Í∏∞Ï§Ä:</span>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-fit" id="wb-keep" onclick="setWordBreak('keep-all')">Îã®Ïñ¥ (Keep)</button>
                            <button class="btn-fit active" id="wb-break" onclick="setWordBreak('break-all')">Í∏ÄÏûê
                                (Break)</button>
                        </div>
                        <input type="hidden" id="wordBreakInput" value="break-all">
                    </div>

                    <div class="style-row">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span>Ïó¨Î∞±:</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="number" id="input-paddingRange" class="val-display" value="90"
                                    style="width:55px; border:1px solid #e2e8f0; border-radius:4px; text-align:right;"
                                    oninput="syncSlider('paddingRange', this.value)"> px
                                <input type="checkbox" class="lock-chk" title="Ïû†Í∏à"
                                    onchange="const d=this.checked; document.getElementById('paddingRange').disabled=d; document.getElementById('input-paddingRange').disabled=d;">
                            </div>
                        </div>
                        <input type="range" id="paddingRange" min="0" max="200" value="90"
                            oninput="syncInput('paddingRange', this.value)">
                    </div>

                    <div class="style-row">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span>Í∏ÄÏûê ÌÅ¨Í∏∞:</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="number" id="input-fontSize" class="val-display" value="45"
                                    style="width:55px; border:1px solid #e2e8f0; border-radius:4px; text-align:right;"
                                    oninput="syncSlider('fontSize', this.value)"> px
                                <input type="checkbox" class="lock-chk" title="Ïû†Í∏à"
                                    onchange="const d=this.checked; document.getElementById('fontSize').disabled=d; document.getElementById('input-fontSize').disabled=d;">
                            </div>
                        </div>
                        <input type="range" id="fontSize" min="10" max="80" step="1" value="45"
                            oninput="syncInput('fontSize', this.value)">
                    </div>

                    <div class="style-row">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span>üß© Ïª§Ïä§ÌÖÄ/CSS Î∞∞Ïú®:</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="number" id="input-cssScale" class="val-display" value="1.0" step="0.1"
                                    style="width:55px; border:1px solid #e2e8f0; border-radius:4px; text-align:right;"
                                    oninput="syncSlider('cssScale', this.value)"> (Î∞∞)
                            </div>
                        </div>
                        <input type="range" id="cssScale" min="0.5" max="3.0" step="0.1" value="1.0"
                            oninput="syncInput('cssScale', this.value)">
                    </div>
                                        

                    <div class="style-row">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span>Í∏ÄÏûê ÍµµÍ∏∞:</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="number" id="input-fontWeight" class="val-display" value="400" step="100"
                                    style="width:55px; border:1px solid #e2e8f0; border-radius:4px; text-align:right;"
                                    oninput="syncSlider('fontWeight', this.value)">
                                <input type="checkbox" class="lock-chk" title="Ïû†Í∏à"
                                    onchange="const d=this.checked; document.getElementById('fontWeight').disabled=d; document.getElementById('input-fontWeight').disabled=d;">
                            </div>
                        </div>
                        <input type="range" id="fontWeight" min="100" max="900" step="100" value="400"
                            oninput="syncInput('fontWeight', this.value)">
                    </div>
                    
                    <div class="style-row">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span>ÎåìÍ∏Ä ÌÅ¨Í∏∞ ÎπÑÏú®:</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="number" id="input-wncsScale" class="val-display" value="35"
                                    style="width:55px; border:1px solid #e2e8f0; border-radius:4px; text-align:right;"
                                    oninput="syncSlider('wncsScale', this.value)"> %
                                <input type="checkbox" class="lock-chk" title="Ïû†Í∏à"
                                    onchange="const d=this.checked; document.getElementById('wncsScale').disabled=d; document.getElementById('input-wncsScale').disabled=d;">
                            </div>
                        </div>
                        <input type="range" id="wncsScale" min="10" max="150" step="1" value="35"
                            oninput="syncInput('wncsScale', this.value)">
                    </div>

                    
                    <div class="style-row">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span>Ï§Ñ Í∞ÑÍ≤©:</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="number" id="input-lineHeight" class="val-display" value="1.3" step="0.1"
                                    style="width:55px; border:1px solid #e2e8f0; border-radius:4px; text-align:right;"
                                    oninput="syncSlider('lineHeight', this.value)"> (Î∞∞)
                                <input type="checkbox" class="lock-chk" title="Ïû†Í∏à"
                                    onchange="const d=this.checked; document.getElementById('lineHeight').disabled=d; document.getElementById('input-lineHeight').disabled=d;">
                            </div>
                        </div>
                        <input type="range" id="lineHeight" min="1.0" max="2.5" step="0.1" value="1.3"
                            oninput="syncInput('lineHeight', this.value)">
                    </div>

                    <div class="style-row">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span>Î¨∏Îã® Í∞ÑÍ≤©:</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="number" id="input-paraSpacing" class="val-display" value="27" step="1"
                                    style="width:55px; border:1px solid #e2e8f0; border-radius:4px; text-align:right;"
                                    oninput="syncSlider('paraSpacing', this.value)"> px
                                <input type="checkbox" class="lock-chk" title="Ïû†Í∏à"
                                    onchange="const d=this.checked; document.getElementById('paraSpacing').disabled=d; document.getElementById('input-paraSpacing').disabled=d;">
                            </div>
                        </div>
                        <input type="range" id="paraSpacing" min="0" max="200" step="1" value="27"
                            oninput="syncInput('paraSpacing', this.value)">
                    </div>
                </div>

                <div id="sect-detail" class="style-section">
                    <div class="style-row">
                        <span>Í∏∞Î≥∏ Í∏ÄÏûêÏÉâ:</span>
                        <div class="mini-color-row">
                            <div class="mini-preview" onclick="openPicker('text', 'Í∏∞Î≥∏ Í∏ÄÏûêÏÉâ')">
                                <div id="text-pv" class="mini-color-layer"></div>
                            </div>
                            <input type="text" id="text-txt" class="mini-input" onchange="setColor('text',this.value)">
                        </div>
                    </div>
                    <div class="style-row">
                        <span>Ï§ÑÌëú (---):</span>
                        <div class="mini-color-row">
                            <div class="mini-preview" onclick="openPicker('hr', 'Ï§ÑÌëú')">
                                <div id="hr-pv" class="mini-color-layer"></div>
                            </div>
                            <input type="text" id="hr-txt" class="mini-input" onchange="setColor('hr',this.value)">
                        </div>
                    </div>

                    <div class="style-row">
                        <span>"ÎåÄÏÇ¨" (ÌòïÍ¥ëÌéú):</span>
                        <div class="mini-color-row">
                            <div class="mini-preview" onclick="openPicker('hlbg', 'ÎåÄÏÇ¨ Î∞∞Í≤Ω')">
                                <div id="hlbg-pv" class="mini-color-layer"></div>
                            </div>
                            <input type="text" id="hlbg-txt" class="mini-input" onchange="setColor('hlbg',this.value)">
                        </div>
                    </div>

                    <div class="style-row">
                        <span>"ÎåÄÏÇ¨" (Í∏ÄÏûêÏÉâ):</span>
                        <div class="mini-color-row">
                            <div class="mini-preview" onclick="openPicker('hltx', 'ÎåÄÏÇ¨ Í∏ÄÏûêÏÉâ')">
                                <div id="hltx-pv" class="mini-color-layer"></div>
                            </div>
                            <input type="text" id="hltx-txt" class="mini-input" onchange="setColor('hltx',this.value)">
                        </div>
                    </div>

                    <div class="style-row">
                        <span>'ÏÜçÎßàÏùå' (Î™ÖÏ°∞+Ïù¥ÌÉ§Î¶≠):</span>
                        <div class="mini-color-row">
                            <div class="mini-preview" onclick="openPicker('th', 'ÏÜçÎßàÏùå Í∏ÄÏûêÏÉâ')">
                                <div id="th-pv" class="mini-color-layer"></div>
                            </div>
                            <input type="text" id="th-txt" class="mini-input" onchange="setColor('th',this.value)">
                        </div>
                    </div>

                    <div class="style-row">
                        <div style="display:flex; justify-content:space-between;">
                            <span>*Ïù¥ÌÉ§Î¶≠* (Î≥ºÎìú):</span>
                            <label
                                style="font-size:11px; cursor:pointer; display:flex; align-items:center; color:#64748b;">
                                <input type="checkbox" id="noItalic" onchange="updatePreview(); saveData();"> Ìö®Í≥º ÎÅÑÍ∏∞
                            </label>
                        </div>
                        <div class="mini-color-row">
                            <div class="mini-preview" onclick="openPicker('it', 'Ïù¥ÌÉ§Î¶≠ Í∏ÄÏûêÏÉâ')">
                                <div id="it-pv" class="mini-color-layer"></div>
                            </div>
                            <input type="text" id="it-txt" class="mini-input" onchange="setColor('it',this.value)">
                        </div>
                    </div>

                    <div class="style-row">
                        <span>**Í∞ïÏ°∞** (Extra Bold):</span>
                        <div class="mini-color-row">
                            <div class="mini-preview" onclick="openPicker('bd', 'Í∞ïÏ°∞ Í∏ÄÏûêÏÉâ')">
                                <div id="bd-pv" class="mini-color-layer"></div>
                            </div>
                            <input type="text" id="bd-txt" class="mini-input" onchange="setColor('bd',this.value)">
                        </div>
                    </div>

                    <hr class="parsed-hr" style="margin:10px 0;">

                    <hr class="parsed-hr" style="margin:10px 0;">

                    <div class="style-row">
                        <span>üìü Î¨∏Ïûê Î∞ïÏä§(Î∞±Ìã±) Î∞∞Í≤Ω:</span>
                        <div class="mini-color-row">
                            <div class="mini-preview" onclick="openPicker('sms_bg', 'Î¨∏Ïûê Î∞ïÏä§ Î∞∞Í≤Ω')">
                                <div id="sms_bg-pv" class="mini-color-layer"></div>
                            </div>
                            <input type="text" id="sms_bg-txt" class="mini-input"
                                onchange="setColor('sms_bg',this.value)">
                        </div>
                    </div>
                    <div class="style-row">
                        <span>üìü Î¨∏Ïûê Î∞ïÏä§(Î∞±Ìã±) Í∏ÄÏûê:</span>
                        <div class="mini-color-row">
                            <div class="mini-preview" onclick="openPicker('sms_tx', 'Î¨∏Ïûê Î∞ïÏä§ Í∏ÄÏûê')">
                                <div id="sms_tx-pv" class="mini-color-layer"></div>
                            </div>
                            <input type="text" id="sms_tx-txt" class="mini-input"
                                onchange="setColor('sms_tx',this.value)">
                        </div>
                    </div>

                    <div class="style-row">
                        <span>üó®Ô∏è ÎßêÌíçÏÑ†(Ï¢å) Î∞∞Í≤Ω:</span>
                        <div class="mini-color-row">
                            <div class="mini-preview" onclick="openPicker('bb_l_bg', 'ÎßêÌíçÏÑ†(Ï¢å) Î∞∞Í≤Ω')">
                                <div id="bb_l_bg-pv" class="mini-color-layer"></div>
                            </div>
                            <input type="text" id="bb_l_bg-txt" class="mini-input"
                                onchange="setColor('bb_l_bg',this.value)">
                        </div>
                    </div>
                    <div class="style-row">
                        <span>üó®Ô∏è ÎßêÌíçÏÑ†(Ï¢å) Í∏ÄÏûê:</span>
                        <div class="mini-color-row">
                            <div class="mini-preview" onclick="openPicker('bb_l_tx', 'ÎßêÌíçÏÑ†(Ï¢å) Í∏ÄÏûê')">
                                <div id="bb_l_tx-pv" class="mini-color-layer"></div>
                            </div>
                            <input type="text" id="bb_l_tx-txt" class="mini-input"
                                onchange="setColor('bb_l_tx',this.value)">
                        </div>
                    </div>

                    <div class="style-row" style="margin-top:5px;">
                        <span>üó®Ô∏è ÎßêÌíçÏÑ†(Ïö∞) Î∞∞Í≤Ω:</span>
                        <div class="mini-color-row">
                            <div class="mini-preview" onclick="openPicker('bb_r_bg', 'ÎßêÌíçÏÑ†(Ïö∞) Î∞∞Í≤Ω')">
                                <div id="bb_r_bg-pv" class="mini-color-layer"></div>
                            </div>
                            <input type="text" id="bb_r_bg-txt" class="mini-input"
                                onchange="setColor('bb_r_bg',this.value)">
                        </div>
                    </div>
                    <div class="style-row">
                        <span>üó®Ô∏è ÎßêÌíçÏÑ†(Ïö∞) Í∏ÄÏûê:</span>
                        <div class="mini-color-row">
                            <div class="mini-preview" onclick="openPicker('bb_r_tx', 'ÎßêÌíçÏÑ†(Ïö∞) Í∏ÄÏûê')">
                                <div id="bb_r_tx-pv" class="mini-color-layer"></div>
                            </div>
                            <input type="text" id="bb_r_tx-txt" class="mini-input"
                                onchange="setColor('bb_r_tx',this.value)">
                        </div>
                    </div>
                </div>
            </div>


            <div id="block-list" style="display:flex; flex-direction:column; gap:10px; margin-top:15px;"></div>

            <div style="margin-top:15px; display:flex; gap:8px;">
                <button class="btn-style" style="flex:1; background:#f1f5f9; color:#334155; padding:12px;"
                    onclick="addBlock('text')">+ üìù ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä</button>
                <button class="btn-style" style="flex:1; background:#f1f5f9; color:#334155; padding:12px;"
                    onclick="document.getElementById('imgFileInput').click()">+ üñºÔ∏è Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä</button>
            </div>

            <div style="text-align: center; padding: 30px 0; color: #94a3b8; font-size: 12px; font-weight: 600;">
                ¬© RenaMerdis v1.8.1
                <br><br> <a href="https://hits.sh/renamerdis-wq.github.io/Log-card-maker-RM/"><img alt="Hits"
                        src="https://hits.sh/renamerdis-wq.github.io/Log-card-maker-RM.svg?label=%F0%9F%AB%B6%F0%9F%8F%BB&color=9f9f9f" /></a>
            </div>

            <input type="file" id="imgFileInput" accept="image/*" onchange="addImgBlock(this)">
            <input type="file" id="bgImgFileInput" accept="image/*" onchange="handleBgUpload(this)">
            <input type="file" id="insertImgFileInput" accept="image/*" onchange="handleInsertImgUpload(this)">
            <input type="file" id="presetFileInput" accept=".json" onchange="loadPresets(this)">
        </div>
    </div>

    <div id="colorPickerModal"
        style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:3000; background:white; padding:20px; border-radius:15px; box-shadow:0 10px 40px rgba(0,0,0,0.3); width: 300px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <span id="pickerTitle" style="font-weight:bold; font-size:14px; color:#334155;">ÏÉâÏÉÅ ÏÑ†ÌÉù</span>
            <button onclick="closePicker(false)"
                style="border:none; background:none; cursor:pointer; font-size:18px;">‚úï</button>
        </div>

        <div id="iroPicker" style="display:flex; justify-content:center; margin-bottom:15px;"></div>

        <div style="display:flex; gap:8px;">
            <input type="text" id="hexInput"
                style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:8px; font-family:monospace; text-align:center; font-size:14px;">
            <button class="btn-save" onclick="closePicker(true)" style="margin:0; padding:0 15px;">ÌôïÏù∏</button>
        </div>
    </div>

    <div id="pickerOverlay" onclick="closePicker(false)"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2999;">
    </div>

    <div id="regexModal">
        <div class="regex-header">
            <div class="regex-title">
                <span style="font-size:18px;">üî°</span> Î©ÄÌã∞ Ï†ïÍ∑úÏãù ÏπòÌôò
            </div>
            <button class="regex-close-btn" onclick="closeRegexModal()">‚úï</button>
        </div>

        <div style="font-size:12px; font-weight:700; color:#475569; margin-bottom:4px;">‚ö° Îπ†Î•∏ Ï∂îÍ∞Ä (ÌÅ¥Î¶≠ Ïãú Î¶¨Ïä§Ìä∏Ïóê Ï∂îÍ∞ÄÎê®)</div>
        <div class="regex-preset-box">
            <button class="btn-regex-preset" onclick="addRegexRule('lightboard')">ü§ñ ÎùºÏù¥Ìä∏Î≥¥Îìú Ï†úÍ±∞</button>
            <button class="btn-regex-preset" onclick="addRegexRule('wncs')">‚öôÔ∏è WNCS Ï†úÍ±∞</button>
            <button class="btn-regex-preset" onclick="addRegexRule('nai')">üñºÔ∏è NAI ÌÉúÍ∑∏({{..}}) Ï†úÍ±∞</button>
            <button class="btn-regex-preset" onclick="addRegexRule('response')">üìù '# ÏùëÎãµ' Ï†úÍ±∞</button>
            <button class="btn-regex-preset" onclick="addRegexRule('says nothing')">üôä '*says nothing*' Ï†úÍ±∞</button>
            <button class="btn-regex-preset" onclick="addRegexRule('annotation')">‚úèÔ∏è Ï£ºÏÑù Ï†úÍ±∞</button>
            <button class="btn-regex-preset" onclick="addRegexRule('details')">üìÇ Details ÌÉúÍ∑∏ Ï†úÍ±∞</button>
            <button class="btn-regex-preset" onclick="addRegexRule('empty')">üßπ Í≥µÎ∞± Ï§Ñ Ï†úÍ±∞</button>
        </div>

        <div id="regexListContainer">
        </div>

        <button class="btn-add-rule" onclick="addRegexRule('custom')">‚ûï ÏÉà Í∑úÏπô ÏßÅÏ†ë Ï∂îÍ∞ÄÌïòÍ∏∞</button>

        <div class="regex-btn-row">
            <button id="btnRegexOne" class="btn-regex-all" onclick="executeRegexQueue(false)">üëá Ïù¥ Î∏îÎ°ùÎßå Ï†ÅÏö©</button>
            <button class="btn-regex-run" onclick="executeRegexQueue(true)">üåç Ï†ÑÏ≤¥ ÏùºÍ¥Ñ Ï†ÅÏö©</button>
        </div>
    </div>

    <div id="cssModal" style="display:none; flex-direction:column; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:3000; width:500px; max-width:90%; height:600px; background:#fff; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); padding:20px; animation: modalPop 0.3s;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <span style="font-size:18px; font-weight:800;">üé® ÏÇ¨Ïö©Ïûê Ï†ïÏùò CSS</span>
            <button onclick="closeCssModal()" style="border:none; background:none; font-size:20px; cursor:pointer;">‚úï</button>
        </div>
        
        <div style="font-size:12px; color:#666; margin-bottom:10px;">
            Ïó¨Í∏∞Ïóê ÏûÖÎ†•Ìïú CSSÎäî <b>ÎØ∏Î¶¨Î≥¥Í∏∞</b>ÏôÄ <b>HTML Ï†ÄÏû•</b> Ïãú Ï†ÅÏö©Îê©ÎãàÎã§.<br>
            <code>.status-card { ... }</code> Ï≤òÎüº ÌÅ¥ÎûòÏä§ Ïä§ÌÉÄÏùºÏùÑ Ï†ïÏùòÌïòÏÑ∏Ïöî.
        </div>

        <textarea id="customCssInput" 
            style="flex:1; width:100%; background:#1e1e1e; color:#d4d4d4; font-family:monospace; padding:15px; border-radius:8px; border:none; resize:none; font-size:13px; line-height:1.5;"
            placeholder="/* Ïó¨Í∏∞Ïóê CSS ÏΩîÎìúÎ•º Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî */"
            oninput="applyCustomCss(this.value)"></textarea>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
            <button class="btn-save" onclick="closeCssModal()">Îã´Í∏∞ (ÏûêÎèôÏ†ÅÏö©Îê®)</button>
        </div>
    </div>
    

    <div id="txtImportModal" style="display:none; flex-direction:column; gap:15px; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:3000; width:400px; padding:24px; background:#fff; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);">
    
    <div style="font-size:18px; font-weight:800; color:#1e293b; border-bottom:1px solid #f1f5f9; padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
        <span>üìÑ ÌÖçÏä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞ ÏòµÏÖò</span>
        <button onclick="closeTxtImportModal()" style="border:none; background:none; font-size:16px; cursor:pointer; color:#64748b;">‚úï</button>
    </div>

    <div style="font-size:13px; color:#64748b;">
        ÏõêÌïòÎäî Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.<br>
        <span style="font-size:11px; color:#94a3b8;">(Ï≤¥ÌÅ¨Î•º Î™®Îëê Ìï¥Ï†úÌïòÎ©¥ ÏõêÎ≥∏ Í∑∏ÎåÄÎ°ú Í∞ÄÏ†∏ÏòµÎãàÎã§)</span>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <label class="check-box-item"><input type="checkbox" id="chk-lightboard" checked> ü§ñ ÎùºÏù¥Ìä∏Î≥¥Îìú Ï†úÍ±∞</label>
        <label class="check-box-item"><input type="checkbox" id="chk-wncs" checked> ‚öôÔ∏è WNCS ÌÉúÍ∑∏ Ï†úÍ±∞</label>
        <label class="check-box-item"><input type="checkbox" id="chk-nai" checked> üñºÔ∏è NAI ÌÉúÍ∑∏ Ï†úÍ±∞</label>
        <label class="check-box-item"><input type="checkbox" id="chk-response" checked> üìù '# ÏùëÎãµ' Ï†úÍ±∞</label>
        <label class="check-box-item"><input type="checkbox" id="chk-saysnothing" checked> üôä *says nothing* Ï†úÍ±∞</label>
        <label class="check-box-item"><input type="checkbox" id="chk-annotation" checked> ‚úèÔ∏è Ï£ºÏÑù Ï†úÍ±∞</label>
        <label class="check-box-item"><input type="checkbox" id="chk-details" checked> üìÇ Details ÌÉúÍ∑∏ Ï†úÍ±∞</label>
        <label class="check-box-item"><input type="checkbox" id="chk-empty" checked> üßπ Í≥µÎ∞± Ï§Ñ Ï†úÍ±∞</label>
    </div>

    <div style="display:flex; gap:8px; margin-top:10px;">
        <button class="btn-save" style="flex:1; background:#64748b;" onclick="closeTxtImportModal()">Ï∑®ÏÜå</button>
        <button class="btn-save" style="flex:2; background:#8b5cf6;" onclick="executeTxtImport()">üì• Î∂àÎü¨Ïò§Í∏∞</button>
    </div>
</div>
    

    <div id="bookmarkletModal">
        <div style="font-size:18px; font-weight:800; color:#1e293b; margin-bottom:5px;">
            üîñ Î∂ÅÎßàÌÅ¨Î¶ø Í∞ÄÏ†∏Í∞ÄÍ∏∞
        </div>

        <div class="bookmarklet-desc">
            Î≥¥ÏïàÏÉÅ Î≤ÑÌäº ÌÅ¥Î¶≠ÎßåÏúºÎ°úÎäî Ï∂îÍ∞ÄÌï† Ïàò ÏóÜÏäµÎãàÎã§.<br>
            ÏïÑÎûò <b>ÌååÎûÄ Î≤ÑÌäº</b>ÏùÑ ÎßàÏö∞Ïä§Î°ú Ïû°Í≥†<br>
            Î∏åÎùºÏö∞Ï†Ä ÏÉÅÎã® <b>[Ï¶êÍ≤®Ï∞æÍ∏∞ Î∞î]</b>Î°ú<br>
            <b>ÎìúÎûòÍ∑∏ & ÎìúÎ°≠</b> Ìï¥Ï£ºÏÑ∏Ïöî!<br>
            (ÏºÄÎçïÏóêÏÑú ÏûëÎèô Ïãú Í∏∞Î≥∏ Îã§ÌÅ¨ ÌÖåÎßà, Í∏∞Î≥∏ Ìè∞Ìä∏ ÏÉâÏÉÅ, Í∏ÄÏûê Í∑∏Î¶ºÏûê ÏºúÏÑú ÏûëÎèô)<br>
        </div>

        <div style="padding:10px;">
            <a class="bookmarklet-pill" 
               href='javascript:(async function(){let box=document.createElement("div");box.style.cssText="position:fixed;top:10px;left:10px;z-index:99999;background:rgba(0,0,0,0.8);color:white;padding:15px;border-radius:10px;font-size:14px;font-weight:bold;";box.innerText="üöÄ Ï§ÑÎ∞îÍøà Î∂ÑÎ¶¨ Ï†ÄÏû• ÏãúÏûë...";document.body.appendChild(box);let count=0;while(true){let btn=Array.from(document.querySelectorAll("button")).find(b=>b.innerText.replace(/\s/g,"").includes("ÎçîÎ≥¥Í∏∞"));if(btn){count++;box.innerText=`üëÜ Í≥ºÍ±∞ Î°úÎî© Ï§ë... (${count}Ìöå)`;btn.click();await new Promise(r=>setTimeout(r,1500));window.scrollTo(0,0);}else{break;}}box.innerText="üìù Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ Ï§ë...";await new Promise(r=>setTimeout(r,500));let msgs=document.querySelectorAll("p.text-caveduck-shadow, div[class*=\"bg-background-markdown\"]");let res=[];let lastP=null;msgs.forEach(m=>{if(!m.innerText.trim())return;let curP=m.parentElement;if(lastP&&curP!==lastP)res.push("\n---\n");lastP=curP;if(m.tagName.toLowerCase()==="p"){let s=m.getAttribute("style")||"";let t=m.innerText.trim();if(s.includes("--color-user-message")||s.includes("--color-char-message")){let lines=t.split("\n");lines.forEach(l=>{if(l.trim())res.push(`"${l.trim()}"`);});}else{res.push(t);}}else{res.push("```");res.push(m.outerHTML);res.push("```");}});let blob=new Blob([res.join("\n")],{type:"text/plain"});let link=document.createElement("a");link.href=URL.createObjectURL(blob);link.download=`ÏºÄÏù¥Î∏åÎçï_ÌïòÏù¥Î∏åÎ¶¨Îìú_${new Date().toISOString().slice(0,10)}.txt`;document.body.appendChild(link);link.click();document.body.removeChild(link);box.innerText="‚úÖ Ï†ÄÏû• ÏôÑÎ£å!";setTimeout(()=>box.remove(),4000);})();'
               onclick="alert(&quot;ÌÅ¥Î¶≠ÌïòÎäî Í≤å ÏïÑÎãôÎãàÎã§!\nÎ≤ÑÌäºÏùÑ Ïû°Í≥† Î∏åÎùºÏö∞Ï†Ä ÏúÑÏ™Ω Ï¶êÍ≤®Ï∞æÍ∏∞ Î∞îÎ°ú 'ÎìúÎûòÍ∑∏' ÌïòÏÑ∏Ïöî.\n(ÏºÄÎçï ÎåÄÌôîÎ∞©Ïóê Îì§Ïñ¥Í∞ÄÏÑú Ï∂îÍ∞ÄÌïú Î∂ÅÎßàÌÅ¨Î•º ÎàÑÎ•¥Í≥† Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî. TXT ÌååÏùºÏù¥ Ï†ÄÏû•Îê©ÎãàÎã§.(ÎßûÏ∂§Ï±ÑÌåÖÎ∞© ÏÑ§Ï†ïÏóêÏÑú ÏÉâÏÉÅÌÖåÎßà Îã§ÌÅ¨, Ìè∞Ìä∏ÏÉâÏÉÅ Í∏∞Î≥∏Í∞í, Í∏ÄÏûê Í∑∏Î¶ºÏûê ÏºúÍ∏∞Î°ú ÏÑ§Ï†ïÌï¥ÏïºÌï©ÎãàÎã§.)&quot;); return false;">
                üì• ÏºÄÏù¥Î∏åÎçï Ï†ÄÏû•Í∏∞
            </a>
        </div>

        <button class="btn-save" style="background:#64748b; margin-top:10px;"
            onclick="closeBookmarkletModal()">Îã´Í∏∞</button>
    </div>


    <script>
        /* =========================================
           1. Data & State Management
           ========================================= */
        const STORAGE_KEY = 'LogCardv1_8_1_data'; // Updated for v1.8.1 compatibility

        // Default Color Palette
        let colors = {
            bg1: '#fdfbf7', bg2: '#ede0d4', text: '#4a3b32',
            hr: '#d7ccc8',
            hlbg: '#e6ccb2', hltx: '#3e2723',
            th: '#8d6e63', it: '#5d4037', bd: '#3e2723', qt: '#795548',
            bb_l_bg: '#fafafa', bb_l_tx: '#5d4037',
            bb_r_bg: '#a1887f', bb_r_tx: '#ffffff',
            sms_bg: '#f1f5f9', sms_tx: '#334155'
        };

        // Preset Data Configuration
        let presets = [
            // 1. Basic & Natural
            {
                name: 'ÌÅ¨Î¶º ÎùºÎñº',
                bg1: '#fdfbf7', bg2: '#ede0d4', text: '#4a3b32', hr: '#d7ccc8',
                hlbg: '#ecd8c5', hltx: '#3e2723', th: '#8d6e63', it: '#5d4037', bd: '#3e2723', qt: '#795548',
                bb_l_bg: '#fafafa', bb_l_tx: '#5d4037', bb_r_bg: '#a1887f', bb_r_tx: '#ffffff',
                sms_bg: '#f3ece4', sms_tx: '#5d4037' // Ï∂îÍ∞ÄÎê®
            },
            {
                name: 'Í∏∞Î≥∏ ÌôîÏù¥Ìä∏',
                bg1: '#ffffff', bg2: '#f8fafc', text: '#1e293b', hr: '#e2e8f0',
                hlbg: '#fef08a', hltx: '#000000', th: '#64748b', it: '#475569', bd: '#0f172a', qt: '#334155',
                bb_l_bg: '#f1f5f9', bb_l_tx: '#1e293b', bb_r_bg: '#3b82f6', bb_r_tx: '#ffffff',
                sms_bg: '#f1f5f9', sms_tx: '#334155' // Ï∂îÍ∞ÄÎê®
            },

            // 2. Emotion & Mood
            {
                name: 'ÏÉàÎ≤Ω Í∞êÏÑ±',
                bg1: '#a18cd1', bg2: '#fbc2eb', text: '#4a2c58', hr: '#d8b4fe',
                hlbg: '#e0c3fc', hltx: '#2e1065', th: '#6b4c9a', it: '#5b3c8a', bd: '#2e1065', qt: '#8e44ad',
                bb_l_bg: '#f3e5f5', bb_l_tx: '#4a148c', bb_r_bg: '#9b59b6', bb_r_tx: '#ffffff',
                sms_bg: '#f3e5f5', sms_tx: '#4a148c' // Ï∂îÍ∞ÄÎê®
            },
            {
                name: 'ÎÖ∏ÏùÑ',
                bg1: '#fa709a', bg2: '#fee140', text: '#5e2c2c', hr: '#ffb7b2',
                hlbg: '#ffdac1', hltx: '#8a2be2', th: '#d35400', it: '#c0392b', bd: '#8e44ad', qt: '#e67e22',
                bb_l_bg: '#fff3e0', bb_l_tx: '#e65100', bb_r_bg: '#ff7043', bb_r_tx: '#ffffff',
                sms_bg: '#fff8e1', sms_tx: '#e65100' // Ï∂îÍ∞ÄÎê®
            },
            {
                name: 'Ïò§ÎûòÎêú Ìé∏ÏßÄ',
                bg1: '#fdfbf7', bg2: '#f6e6b4', text: '#5d4037', hr: '#d7ccc8',
                hlbg: '#fff9c4', hltx: '#3e2723', th: '#8d6e63', it: '#795548', bd: '#3e2723', qt: '#5d4037',
                bb_l_bg: '#fffdeb', bb_l_tx: '#5d4037', bb_r_bg: '#8d6e63', bb_r_tx: '#ffffff', font: "'KoPub World Batang', serif",
                sms_bg: '#fff9c4', sms_tx: '#3e2723' // Ï∂îÍ∞ÄÎê®
            },

            // 3. Modern & Chic
            {
                name: 'Ïñ¥Î∞ò Í∑∏Î†àÏù¥',
                bg1: '#e0ece4', bg2: '#f3f4f6', text: '#2d3436', hr: '#b2bec3',
                hlbg: '#dfe6e9', hltx: '#000000', th: '#636e72', it: '#2d3436', bd: '#000000', qt: '#b2bec3',
                bb_l_bg: '#ffffff', bb_l_tx: '#2d3436', bb_r_bg: '#636e72', bb_r_tx: '#ffffff', font: "'Noto Sans KR', sans-serif",
                sms_bg: '#dfe6e9', sms_tx: '#2d3436' // Ï∂îÍ∞ÄÎê®
            },
            {
                name: 'Îã§ÌÅ¨ Î™®Îìú',
                bg1: '#1a1a1a', bg2: '#2d3436', text: '#dfe6e9', hr: '#636e72',
                hlbg: '#2d3436', hltx: '#74b9ff', th: '#b2bec3', it: '#dfe6e9', bd: '#ffffff', qt: '#636e72',
                bb_l_bg: '#2d3436', bb_l_tx: '#dfe6e9', bb_r_bg: '#0984e3', bb_r_tx: '#ffffff',
                sms_bg: '#2d3436', sms_tx: '#dfe6e9' // Ï∂îÍ∞ÄÎê® (Ï§ëÏöî: Ïñ¥ÎëêÏö¥ Î∞∞Í≤Ω)
            },

            // 4. Nature
            {
                name: 'Ïà≤ÏÜç',
                bg1: '#d4fc79', bg2: '#96e6a1', text: '#1b5e20', hr: '#a5d6a7',
                hlbg: '#c8e6c9', hltx: '#1b5e20', th: '#2e7d32', it: '#388e3c', bd: '#1b5e20', qt: '#4caf50',
                bb_l_bg: '#e8f5e9', bb_l_tx: '#1b5e20', bb_r_bg: '#4caf50', bb_r_tx: '#ffffff',
                sms_bg: '#e8f5e9', sms_tx: '#1b5e20' // Ï∂îÍ∞ÄÎê®
            },
            {
                name: 'Îî• Ïò§ÏÖò',
                bg1: '#0f172a', bg2: '#1e3a8a', text: '#e2e8f0', hr: '#3b82f6',
                hlbg: '#1e40af', hltx: '#ffffff', th: '#94a3b8', it: '#cbd5e1', bd: '#ffffff', qt: '#60a5fa',
                bb_l_bg: '#1e293b', bb_l_tx: '#e2e8f0', bb_r_bg: '#2563eb', bb_r_tx: '#ffffff',
                sms_bg: '#1e293b', sms_tx: '#cbd5e1' // Ï∂îÍ∞ÄÎê®
            },

            // 5. Pastel
            {
                name: 'ÏÜåÎã§',
                bg1: '#f0f9ff', bg2: '#bae6fd', text: '#0c4a6e', hr: '#7dd3fc',
                hlbg: '#e0f2fe', hltx: '#0284c7', th: '#0369a1', it: '#075985', bd: '#0c4a6e', qt: '#38bdf8',
                bb_l_bg: '#f0f9ff', bb_l_tx: '#0c4a6e', bb_r_bg: '#0ea5e9', bb_r_tx: '#ffffff',
                sms_bg: '#e0f2fe', sms_tx: '#0c4a6e' // Ï∂îÍ∞ÄÎê®
            },
            {
                name: 'ÎùºÎ≤§Îçî',
                bg1: '#f3e8ff', bg2: '#e0e7ff', text: '#4c1d95', hr: '#d8b4fe',
                hlbg: '#ede9fe', hltx: '#5b21b6', th: '#7c3aed', it: '#6d28d9', bd: '#4c1d95', qt: '#a78bfa',
                bb_l_bg: '#f5f3ff', bb_l_tx: '#4c1d95', bb_r_bg: '#8b5cf6', bb_r_tx: '#ffffff',
                sms_bg: '#f5f3ff', sms_tx: '#5b21b6' // Ï∂îÍ∞ÄÎê®
            },
            {
                name: 'ÏΩîÏßÄ Î∏îÎùºÏç∏',
                bg1: '#fff0f5', bg2: '#ffe4e9', text: '#5e2c38', hr: '#fbcfe8',
                hlbg: '#ffe4e6', hltx: '#881337', th: '#be123c', it: '#9f1239', bd: '#881337', qt: '#fb7185',
                bb_l_bg: '#fff1f2', bb_l_tx: '#881337', bb_r_bg: '#f43f5e', bb_r_tx: '#ffffff',
                sms_bg: '#ffe4e6', sms_tx: '#881337' // Ï∂îÍ∞ÄÎê®
            },
            {
                name: 'Ïò§Î¶¨ Î™®Îìú',
                bg1: '#3E3E3EFF',
                bg2: '#3E3E3EFF',
                text: '#dfe6e9',
                hr: '#636e72',
                hlbg: '#2d3436',
                hltx: '#FCC400',
                th: '#CC9F00FF',
                it: '#dfe6e9',
                bd: '#ffffff',
                qt: '#636e72',
                bb_l_bg: '#DAAA00FF',
                bb_l_tx: '#FFFFFFFF',
                bb_r_bg: '#9B9B9BFF',
                bb_r_tx: '#ffffff',
                sms_bg: '#2d3436',
                sms_tx: '#dfe6e9',
            },
            {
                name: 'Ï£ºÏù∏Ïû• ÎßàÏùå',
                bg1: '#F4FCFFFF',
                bg2: '#ECF9FFFF',
                text: '#1C1C1CFF',
                hr: '#C0DBE8FF',
                hlbg: '#E0F2FFFF',
                hltx: '#002D43FF',
                th: '#20A5EDFF',
                it: '#00A6FFFF',
                bd: '#003D74FF',
                qt: '#795548',
                bb_l_bg: '#D8EEFFFF',
                bb_l_tx: '#0c4a6e',
                bb_r_bg: '#0ea5e9',
                bb_r_tx: '#ffffff',
                sms_bg: '#7F7F7FFF',
                sms_tx: '#F6F6F6FF',
            }
        ];







        // Runtime State
        let bgState = { mode: 'gradient', imgData: null, sizeMode: 'contain', overlayColor: '#000000', scale: 100, posX: 50, posY: 50 };
        let insertTargetIndex = -1;
        let currentZoom = 100;
        let debounceTimer = null;

        // Default Block Content (v1.8.1)
        let blocks = [{
            type: 'text', content: `
# Î°úÍ∑∏ Ïπ¥Îìú ÏÉùÏÑ±Í∏∞ v1.8.1
## ÏÉµ(#)ÏúºÎ°ú Ï†úÎ™© ÌÅ¨Í∏∞ Ï°∞Ï†à
### ÏÉµ(#)ÏùÑ 1~3Í∞ú Ïì∞Î©¥ Îê©ÎãàÎã§
---

>> Ï∫êÎ¶≠ÌÑ∞ ÎßêÌíçÏÑ†ÏûÖÎãàÎã§
<< Ïú†Ï†Ä ÎßêÌíçÏÑ†Ïù¥ÏóêÏöî
"ÌÅ∞Îî∞Ïò¥ÌëúÎäî ÎåÄÏÇ¨Î°ú Ï≤òÎ¶¨ÎêòÍ≥†Ïöî,"
‚ÄúÏä§ÎßàÌä∏ Îî∞Ïò¥ÌëúÎèÑ ÏûêÎèôÏúºÎ°ú Ïù∏ÏãùÌï©ÎãàÎã§.‚Äù
'ÏûëÏùÄÎî∞Ïò¥ÌëúÎäî ÏÜçÎßàÏùåÏúºÎ°ú Ï≤òÎ¶¨Îê©ÎãàÎã§.'
\`Î∞±Ìã± ÌïòÎÇòÎäî Î¨∏ÏûêÎ©îÏãúÏßÄÎ°ú Ï≤òÎ¶¨Îê©ÎãàÎã§.\`
*Î≥ÑÌëú ÌïòÎÇòÎäî Ïù¥ÌÉ§Î¶≠ Ìö®Í≥º,*
**Î≥ÑÌëú Îëê Í∞úÎäî ÍµµÍ≤å Í∞ïÏ°∞Ìï¥Ïöî.**
ÏùºÎ∞ò ÌÖçÏä§Ìä∏Îäî ÎÇòÎ†àÏù¥ÏÖòÏúºÎ°ú Îì§Ïñ¥Í∞ëÎãàÎã§.
____ *üíåTip : ÏºÄÎçïÏù¥ÎÇò Î°úÌåêÏùÄ üå† Î≤ÑÌäºÏúºÎ°ú Î≥ÑÌëúÎ•º ÏßÄÏö∞Í±∞ÎÇò, ÎîîÌÖåÏùº ÏÑ§Ï†ïÏóêÏÑú Î≥ÑÌëú Í∞ïÏ°∞ Ìö®Í≥ºÎ•º ÎÅÑÎ©¥ ÏùºÎ∞ò ÎÇòÎ†àÏù¥ÏÖòÏúºÎ°ú ÎÑ£ÏùÑ Ïàò ÏûàÏñ¥Ïöî.*
---
'Ïä§ÌÉÄÏùº ÏÑ§Ï†ï'ÏùÑ ÌÜµÌï¥ÏÑú Ï†ÑÏ≤¥ ÌÖçÏä§Ìä∏Î•º Ï¢åÏ∏°, Í∞ÄÏö¥Îç∞, Ïö∞Ï∏°, ÏñëÏ™Ω Ï†ïÎ†¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.
ÎßåÏïΩ **Îî± ÌïúÏ§ÑÎßå** Ï†ïÎ†¨ÌïòÍ±∞ÎÇò Ìè∞Ìä∏ ÌÅ¨Í∏∞Î•º Ï°∞Ï†àÌïòÍ≥† Ïã∂Îã§Î©¥ Î¨∏Ïû• ÏïûÏóê **ÏïΩÏÜçÎêú Í∏∞Ìò∏**Î•º ÎÑ£Ïñ¥Ï£ºÏÑ∏Ïöî.
---
@@ ## [ÏïΩÏÜçÎêú Í∏∞Ìò∏]

[[ [[: ÏôºÏ™Ω Ï†ïÎ†¨
@@ @@: Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨
]] ]]: Ïò§Î•∏Ï™Ω Ï†ïÎ†¨
[[]] [[]]: ÏñëÏ™Ω Ï†ïÎ†¨
____ ____: Í∏ÄÏûê 2Îã®Í≥Ñ ÏûëÍ≤å
__ __: Í∏ÄÏûê 1Îã®Í≥Ñ ÏûëÍ≤å
++ ++: Í∏ÄÏûê 1Îã®Í≥Ñ ÌÅ¨Í≤å
++++ ++++: Í∏ÄÏûê 2Îã®Í≥Ñ ÌÅ¨Í≤å
---
\`\`\`
<div style="padding: 1.5em; background: #5d4037; color:white; border-radius: 16px;">
    <strong>üí° ÏïàÎÇ¥</strong><br><br>
    <hr>
    <br>
    <li><b>üõ°Ô∏è:</b> HTMLÏùÑ ÏûàÎäî Í∑∏ÎåÄÎ°ú Î≥¥Ïù¥ÎèÑÎ°ù ÎìúÎûòÍ∑∏Ìïú ÎÇ¥Ïö© ÏïûÎí§Ïóê Î∞±Ìã±ÏùÑ Î∂ôÏûÖÎãàÎã§(Í∞ÑÎã®Ìïú ÌÉúÍ∑∏ Ìò∏Ìôò).</li>
    <li><b>üå†:</b> Î≥ÑÌëú ÌïòÎÇòÎ•º ÏùºÍ¥Ñ ÏÇ≠Ï†úÌï©ÎãàÎã§(*ÌÖçÏä§Ìä∏* ‚Üí ÌÖçÏä§Ìä∏).</li>
    <li><b>üßπ:</b> Í≥µÎ∞± Ï§ÑÏùÑ ÏùºÍ¥Ñ ÏÇ≠Ï†úÌï©ÎãàÎã§.</li>
    <li><b>¬ÆÔ∏è:</b> Ï†ïÍ∑úÏãùÏùÑ ÏπòÌôòÌï©ÎãàÎã§.</li>
    <li><b>üßô‚Äç‚ôÇÔ∏è:</b> Ïô∏Î∂Ä ÌÖçÏä§Ìä∏ Í≤âÌè¨Ïû• Î∞ïÏä§(divÌÉúÍ∑∏ Îì±)ÏóêÏÑú Î∞∞Í≤ΩÏÉâÏùÑ Ï∂îÏ∂úÌï¥ ÌÖåÎßàÏóê ÎÑ£Í≥†, Í≤âÌè¨Ïû•ÏùÑ Î≤óÍ≤®Ï§çÎãàÎã§.</li>
    <li><b>üí¨:</b> ÎåÄÏÇ¨Î•º Ï∫êÎ¶≠ÌÑ∞ ÎßêÌíçÏÑ†ÏúºÎ°ú, ÌòπÏùÄ Í∑∏ Î∞òÎåÄÎ°ú Î≥ÄÌôòÌï©ÎãàÎã§.</li>
    <li><b>‚úÇÔ∏è/üß¥:</b> ÌÖçÏä§Ìä∏ Î∏îÎ°ùÏùÑ ÎÇòÎàÑÍ±∞ÎÇò Ìï©Ïπ©ÎãàÎã§.</li>
    <li><b>üñºÔ∏è:</b> Î≥∏Î¨∏Ïóê Ïù¥ÎØ∏ÏßÄÎ•º ÏÇΩÏûÖÌï©ÎãàÎã§.</li>
    <li><b>Ïä§ÌÉÄÏùº ÏÑ§Ï†ï:</b> Ìè∞Ìä∏, ÌÅ¨Í∏∞, Í∞ÑÍ≤©, Î∞∞Í≤Ω, ÌîÑÎ¶¨ÏÖã Îì±ÏùÑ Ïª§Ïä§ÌÑ∞ÎßàÏù¥ÏßïÌï©ÎãàÎã§.</li>
</div>
\`\`\`
`, width: 100
        }];

        // =========================================
        // 2. Initialization & Global Events
        // =========================================


        window.onload = function () {
            loadData();
            initPresets();
            renderBlocks();
            updateUI();
            setBgSize(bgState.sizeMode, false);
            setupPreviewClick();

            // =========================================
            // [ÏàòÏ†ïÎê®] Ï¥àÍ∏∞ Ï§å Î∞∞Ïú® ÏÑ§Ï†ï Î°úÏßÅ
            // PC: 100%, Î™®Î∞îÏùº: Í∞ÄÎ°ú Ìè≠ ÎßûÏ∂§(Width-Fit)
            // =========================================
            const isPC = window.matchMedia("(min-width: 1024px)").matches;

            if (isPC) {
                // PCÎäî 100% Í≥†Ï†ï
                currentZoom = 100;
            } else {
                // Î™®Î∞îÏùºÏùÄ ÌôîÎ©¥ Í∞ÄÎ°ú ÎÑàÎπÑÏóê Ïπ¥ÎìúÎ•º ÍΩâ Ï∞®Í≤å ÎßûÏ∂§
                const cardWidth = parseInt(document.getElementById('cardWidthInput').value) || 1080;
                // preview-containerÏùò Ï¢åÏö∞ Ìå®Îî©(20px+20px=40px)ÏùÑ Í≥†Î†§ÌïòÏó¨ Í≥ÑÏÇ∞
                const availableWidth = window.innerWidth - 40;

                // Î∞∞Ïú® Í≥ÑÏÇ∞ (ÌôîÎ©¥ÎÑàÎπÑ / Ïπ¥ÎìúÎÑàÎπÑ)
                let calcZoom = (availableWidth / cardWidth) * 100;

                // ÎÑàÎ¨¥ ÏûëÏïÑÏßÄÍ±∞ÎÇò Ïª§ÏßÄÎäî Í≤É Î∞©ÏßÄ (ÏµúÏÜå 10%, ÏµúÎåÄ 100%)
                calcZoom = Math.max(10, Math.min(calcZoom, 100));

                currentZoom = Math.floor(calcZoom);
            }

            // Ïä¨ÎùºÏù¥Îçî UIÏôÄ ÎùºÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
            const zoomRange = document.getElementById('zoomRange');
            const zoomLabel = document.getElementById('zoomLabel');
            if (zoomRange) zoomRange.value = currentZoom;
            if (zoomLabel) zoomLabel.innerText = currentZoom + '%';

            // ÏµúÏ¢Ö Ï†ÅÏö©
            updatePreview();
            // =========================================


            window.addEventListener('resize', updatePreview);

            // Editor panel initial state
            document.getElementById('editorArea').classList.add('collapsed');
            // const isPC check duplicated merely for icon logic inside original code
            document.getElementById('foldIcon').innerText = isPC ? '‚ñ≤' : '‚ñ≤';
        };

        window.addEventListener('beforeunload', (event) => { event.preventDefault(); event.returnValue = ''; });

        /* --- Helper: Input Synchronization --- */
        function syncInput(id, val) {
            const numInput = document.getElementById('input-' + id);
            if (numInput) numInput.value = val;
            if (id === 'bgScale') bgState.scale = parseInt(val);
            if (id === 'bgPosX') bgState.posX = parseInt(val);
            if (id === 'bgPosY') bgState.posY = parseInt(val);
            updateVal(id, val); updatePreview(); saveData();
        }

        function syncSlider(id, val) {
            const slider = document.getElementById(id);
            if (slider) slider.value = val;
            if (id === 'bgScale') bgState.scale = parseInt(val);
            if (id === 'bgPosX') bgState.posX = parseInt(val);
            if (id === 'bgPosY') bgState.posY = parseInt(val);
            updateVal(id, val); updatePreview(); saveData();
        }

        /* --- Helper: Zoom Control --- */
        function setZoom(mode) {
            const range = document.getElementById('zoomRange');
            let val = parseInt(range.value);
            if (mode === 'in') val = Math.min(val + 10, 200);
            else if (mode === 'out') val = Math.max(val - 10, 10);
            else if (mode === 'auto') { currentZoom = 'auto'; updatePreview(); return; }
            manualZoom(val);
        }

        function toggleZoomMenu(e) {
            if (e) e.stopPropagation();
            const menu = document.getElementById('zoomMenu');
            menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
        }

        document.addEventListener('click', function (e) {
            const wrapper = document.getElementById('zoomWrapper');
            const menu = document.getElementById('zoomMenu');
            if (wrapper && menu && !wrapper.contains(e.target)) menu.style.display = 'none';
        });

        function manualZoom(val) {
            currentZoom = parseInt(val);
            document.getElementById('zoomRange').value = currentZoom;
            document.getElementById('zoomLabel').innerText = currentZoom + '%';
            updatePreview();
        }

        /* --- Data Persistence (LocalStorage) --- */
        function saveData() {
            const data = {
                colors, bgState, blocks, presets,
                customCss: userCustomCss,
                settings: {
                    width: document.getElementById('cardWidthInput').value,
                    padding: document.getElementById('paddingRange').value,
                    fontSize: document.getElementById('fontSize').value,
                    fontWeight: document.getElementById('fontWeight').value,
                    lineHeight: document.getElementById('lineHeight').value,
                    font: document.getElementById('fontSelect').value,
                    angle: document.getElementById('gradAngle').value,
                    overlayAlpha: document.getElementById('overlayAlpha').value,
                    paraSpacing: document.getElementById('paraSpacing').value,
                    textAlign: document.getElementById('textAlignInput').value,
                    wordBreak: document.getElementById('wordBreakInput').value,
                    cssScale: document.getElementById('cssScale').value,
                    wncsScale: document.getElementById('wncsScale').value, // Ï∂îÍ∞Ä
                    noItalic: document.getElementById('noItalic').checked
                }
            };
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) { console.error("Save failed", e); }
        }

        function loadData() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            try {
                const data = JSON.parse(raw);
                if (data.colors) colors = data.colors;
                if (!colors.hr) colors.hr = '#cbd5e1';
                if (!colors.hltx) colors.hltx = '#3e2723';

                if (data.bgState) bgState = data.bgState;
                if (data.blocks) blocks = data.blocks;
                if (data.presets) presets = data.presets;
                if (data.settings.cssScale) {
                    document.getElementById('cssScale').value = data.settings.cssScale;
                    updateVal('cssScale', data.settings.cssScale); // Ïà´ÏûêÏ∞Ω ÎèôÍ∏∞Ìôî (updateVal Ìï®ÏàòÍ∞Ä ÏûàÎã§Î©¥)
                    if(document.getElementById('input-cssScale')) document.getElementById('input-cssScale').value = data.settings.cssScale;
                }
                        
                if (data.settings) {
                    document.getElementById('cardWidthInput').value = data.settings.width || 1080;
                    document.getElementById('paddingRange').value = data.settings.padding || 90;
                    document.getElementById('fontSize').value = data.settings.fontSize || 45;
                    document.getElementById('fontWeight').value = data.settings.fontWeight || 400;
                    document.getElementById('lineHeight').value = data.settings.lineHeight || 1.3;
                    document.getElementById('fontSelect').value = data.settings.font || "Pretendard, sans-serif";
                    document.getElementById('wncsScale').value = data.settings.wncsScale || 35; // Ï∂îÍ∞Ä
                    document.getElementById('input-wncsScale').value = data.settings.wncsScale || 35; // Ï∂îÍ∞Ä

                    // Set default word-break to 'break-all' if undefined (Req: v1.8.1)
                    setWordBreak(data.settings.wordBreak || 'break-all', false);

                    const savedAlign = data.settings.textAlign || 'justify';
                    setAlign(savedAlign, false);

                    // Restore Font Selection
                    const savedFont = data.settings.font || "Pretendard, sans-serif";
                    const btns = document.querySelectorAll('.font-btn');
                    btns.forEach(btn => btn.classList.remove('active'));
                    let targetBtn = Array.from(btns).find(b => b.getAttribute('onclick').includes(savedFont.replace(/'/g, "\\'")));
                    if (!targetBtn) targetBtn = btns[0];
                    if (targetBtn) targetBtn.classList.add('active');

                    document.getElementById('gradAngle').value = data.settings.angle || 235;
                    document.getElementById('overlayAlpha').value = data.settings.overlayAlpha || 0.5;
                    document.getElementById('paraSpacing').value = data.settings.paraSpacing || 27;
                    document.getElementById('noItalic').checked = data.settings.noItalic || false;
                    document.getElementById('input-gradAngle').value = data.settings.angle || 235;
                }
                // Update UI Displays
                updateVal('fontSize', document.getElementById('fontSize').value);
                updateVal('fontWeight', document.getElementById('fontWeight').value);
                updateVal('lineHeight', document.getElementById('lineHeight').value);
                updateVal('gradAngle', document.getElementById('gradAngle').value);
                updateVal('overlayAlpha', document.getElementById('overlayAlpha').value);
                updateVal('paraSpacing', document.getElementById('paraSpacing').value);
                updateVal('paddingRange', document.getElementById('paddingRange').value);

                if (data.customCss) {
                    userCustomCss = data.customCss;
                    applyCustomCss(userCustomCss);
                }

                if (bgState.mode === 'image') {
                    document.getElementById('showImgOption').checked = true;
                    toggleImgPanel(true, false);
                }
                updateVal('bgScale', bgState.scale);
                updateVal('bgPosX', bgState.posX);
                updateVal('bgPosY', bgState.posY);
                document.getElementById('bgScale').value = bgState.scale;
                document.getElementById('bgPosX').value = bgState.posX;
                document.getElementById('bgPosY').value = bgState.posY;
            } catch (e) { console.error("Load failed", e); }
        }

        function resetAll(e) {
            if (e) e.stopPropagation();
            if (confirm("Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå? (ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§)")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        /* =========================================
           [NEW] WNCS Î≥ÄÌôò Î°úÏßÅ (ÏàúÏàò Ìï®Ïàò)
           ========================================= */
        function renderWNCS(rawData) {
            if (!rawData.startsWith("WNCS{")) return rawData;
        
            // 1. ÎÇ¥Ïö© Ï†ïÏ†ú
            let content = rawData.substring(5, rawData.lastIndexOf('}'));
            let lines = content.split('\n').filter(line => line.trim() !== '');
        
            // 2. Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞Ìôî
            let globalInfo = { title: "ÎåìÍ∏ÄÏ∞Ω", count: "0" };
            let authorNote = "";
            let comments = [];
            let currentMainComment = null;
        
            lines.forEach(line => {
                line = line.trim();
                if (line.startsWith('GN:')) {
                    let info = line.substring(3);
                    let splitIdx = info.indexOf('-');
                    if (splitIdx !== -1) {
                        globalInfo.count = info.substring(0, splitIdx).trim();
                        globalInfo.title = info.substring(splitIdx + 1).trim();
                    } else { globalInfo.count = info; }
                } 
                else if (line.startsWith('AN:')) { authorNote = line.substring(3).trim(); } 
                else if (line.startsWith('R:|')) {
                    if (currentMainComment) {
                        let parts = line.split('|');
                        if (parts.length >= 3) {
                            currentMainComment.replies.push({ nick: parts[1], content: parts.slice(2).join('|') });
                        }
                    }
                } 
                else if (line.includes('|')) {
                    let parts = line.split('|');
                    if (parts.length >= 5) {
                        let newComment = {
                            nick: parts[0], date: parts[1], isBest: parts[2] === 'Y',
                            likes: parts[3], content: parts.slice(4).join('|'), replies: []
                        };
                        comments.push(newComment);
                        currentMainComment = newComment;
                    }
                }
            });
        
            // 3. HTML Ï°∞Î¶Ω (Î¨∏ÏûêÏó¥ Î∞òÌôò)
            let html = `
            <details class="wncs-details" open>
                <summary class="wncs-summary"><span>ÎåìÍ∏Ä Î™®Ïùå</span><span class="wncs-summary-ep">${globalInfo.title}</span></summary>
                <div class="wncs-container">
                    ${authorNote ? `<div class="wncs-author-note"><div class="wncs-author-title">ÏûëÍ∞ÄÏùò Îßê</div><div class="wncs-author-content">${authorNote}</div></div>` : ''}
                    <div class="wncs-header"><h2>${globalInfo.count}</h2><div class="wncs-header-filters"><span class="wncs-filter-active">Ï∂îÏ≤úÏàú</span><span>ÏµúÏã†Ïàú</span></div></div>
                    <div class="wncs-comment-list">`;
        
            comments.forEach((cmt, idx) => {
                const uniqueId = `reply-toggle-${Date.now()}-${idx}`; // Í≥†Ïú† ID ÏÉùÏÑ±
                const bestBadge = cmt.isBest ? `<span class="wncs-best-badge">BEST</span>` : '';
                
                let repliesHtml = '';
                if (cmt.replies.length > 0) {
                    repliesHtml = `
                    <input type="checkbox" id="${uniqueId}" class="wncs-reply-toggle-checkbox">
                    <div class="wncs-replies-container"><div class="wncs-replies-elevated">
                        ${cmt.replies.map(r => `
                        <div class="wncs-reply-comment">
                            <div class="wncs-comment-meta"><span class="wncs-nickname">${r.nick}</span><button class="wncs-options-button">‚ãÆ</button></div>
                            <div class="wncs-comment-content">${r.content}</div>
                        </div>`).join('')}
                    </div></div>`;
                }
        
                html += `
                <div class="wncs-comment-thread">
                    <div class="wncs-comment wncs-main-comment">
                        <div class="wncs-comment-meta">${bestBadge}<span class="wncs-nickname">${cmt.nick}</span><span class="wncs-date">${cmt.date}</span><button class="wncs-options-button">‚ãÆ</button></div>
                        <div class="wncs-comment-content">${cmt.content}</div>
                        <div class="wncs-comment-actions">
                            <span class="wncs-episode">${globalInfo.title}</span>
                            <button class="wncs-like-button"><span class="wncs-like-icon">üëç</span> ${cmt.likes}</button>
                            ${cmt.replies.length > 0 ? 
                            `<label for="${uniqueId}" class="wncs-reply-button"><span class="wncs-reply-icon">üí¨</span> ${cmt.replies.length}</label>` : 
                            `<button class="wncs-reply-button"><span class="wncs-reply-icon">üí¨</span> 0</button>`}
                        </div>
                    </div>
                    ${repliesHtml}
                </div>`;
            });
        
            html += `</div></div></details>`;
            return html;
        }

        /* =========================================
           3. Text Parsing & Processing Engine
           ========================================= */
        function parseContent(text) {
            if (!text) return '';
            const rawHtmlBlocks = [];

            // 1. Extract Code Blocks (``` ... ```)
            let processedText = text.replace(/```([\s\S]*?)```/g, function (match, innerContent) {
                rawHtmlBlocks.push(innerContent);
                return `__RAW_HTML_BLOCK_${rawHtmlBlocks.length - 1}__`;
            });

            // [NEW] [2] WNCS Blocks Extraction (WNCS{ ... })
            // WNCS Î∏îÎ°ùÏùÑ Î®ºÏ†Ä Ï∞æÏïÑÏÑú HTMLÎ°ú Î≥ÄÌôò ÌõÑ Î≥¥Ìò∏Ìï©ÎãàÎã§.
            processedText = processedText.replace(/WNCS\{[\s\S]*?\}/g, function (match) {
                const wncsHtml = renderWNCS(match);
                rawHtmlBlocks.push(wncsHtml);
                return `__RAW_HTML_BLOCK_${rawHtmlBlocks.length - 1}__`;
            });
        

            const lines = processedText.trim().split('\n');
            let html = '';

            lines.forEach(l => {
                let line = l.trim();
                if (!line) { html += '<br>'; return; }

                if (line.startsWith('__RAW_HTML_BLOCK_')) {
                    const index = parseInt(line.match(/\d+/)[0]);
                    html += rawHtmlBlocks[index];
                    return;
                }

                // 2. Parse Line Prefix (Align / Size)
                let alignClass = '';
                let sizeClass = '';

                // Alignment
                if (line.startsWith('[[]] ')) { alignClass = ' align-justify'; line = line.substring(5); }
                else if (line.startsWith('[[ ')) { alignClass = ' align-left'; line = line.substring(3); }
                else if (line.startsWith(']] ')) { alignClass = ' align-right'; line = line.substring(3); }
                else if (line.startsWith('@@ ')) { alignClass = ' align-center'; line = line.substring(3); }

                // Font Size
                if (line.startsWith('++++ ')) { sizeClass = ' size-up-2'; line = line.substring(5); }
                else if (line.startsWith('++ ')) { sizeClass = ' size-up-1'; line = line.substring(3); }
                else if (line.startsWith('____ ')) { sizeClass = ' size-down-2'; line = line.substring(5); }
                else if (line.startsWith('__ ')) { sizeClass = ' size-down-1'; line = line.substring(3); }

                // 3. HTML Tag Protection
                const tags = [];
                const safeLine = line.replace(/<[^>]+>/g, (match) => { tags.push(match); return `__TAG_${tags.length - 1}__`; });
                let s = safeLine.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

                // 4. Block Type Detection
                let type = 'p';
                if (s.startsWith('&gt;&gt; ')) { type = 'bubble-left'; s = s.substring(9); }
                else if (s.startsWith('&lt;&lt; ')) { type = 'bubble-right'; s = s.substring(9); }
                else if (s.startsWith('---')) { type = 'hr'; }
                else if (s.startsWith('# ')) { type = 'h1'; s = s.substring(2); }
                else if (s.startsWith('## ')) { type = 'h2'; s = s.substring(3); }
                else if (s.startsWith('### ')) { type = 'h3'; s = s.substring(4); }
                // ‚ñº‚ñº‚ñº [NEW] ÎßàÌÅ¨Îã§Ïö¥ Î¶¨Ïä§Ìä∏ Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä (* ÎÇ¥Ïö© -> ‚Ä¢ ÎÇ¥Ïö©) ‚ñº‚ñº‚ñº
                else if (s.startsWith('* ')) { 
                    // Î≥ÑÌëú(*)ÏôÄ Í≥µÎ∞±ÏùÑ Î∂àÎ¶ø Í∏∞Ìò∏(‚Ä¢)ÏôÄ Í≥µÎ∞±ÏúºÎ°ú ÍµêÏ≤¥
                    s = '&bull; ' + s.substring(2); 
                }
                // ‚ñ≤‚ñ≤‚ñ≤ Ïó¨Í∏∞ÍπåÏßÄ Ï∂îÍ∞Ä ‚ñ≤‚ñ≤‚ñ≤

                if (type === 'hr') { html += `<hr class="parsed-hr">`; return; }

                // 5. Inline Styling Parsing
                s = s.replace(/`([^`]+)`/g, '__SMS_S__$1__SMS_E__'); // sms-box
                s = s.replace(/\*\*(.*?)\*\*/g, '__BD_S__$1__BD_E__'); // Bold
                s = s.replace(/\*(.*?)\*/g, '__IT_S__$1__IT_E__');     // Italic
                s = s.replace(/‚Äú(.*?)‚Äù/g, '__HL_S__$1__HL_E__');       // Smart Quote
                s = s.replace(/"(.*?)"/g, '__HL_S__$1__HL_E__');       // Double Quote
                s = s.replace(/'(.*?)'/g, '__TH_S__$1__TH_E__');       // Single Quote (Thought)

                s = s.replace(/__BD_S__/g, '<span class="parsed-bold">').replace(/__BD_E__/g, '</span>')
                    .replace(/__IT_S__/g, '<span class="parsed-italic">').replace(/__IT_E__/g, '</span>')
                    .replace(/__HL_S__/g, '<span class="highlight-text">‚Äú').replace(/__HL_E__/g, '‚Äù</span>')
                    .replace(/__TH_S__/g, '<span class="parsed-thought">\'').replace(/__TH_E__/g, '\'</span>')
                    .replace(/__SMS_S__/g, '<span class="sms-box">').replace(/__SMS_E__/g, '</span>');


                // Restore HTML Tags
                s = s.replace(/__TAG_(\d+)__/g, (_, id) => tags[id]);

                // 6. Final HTML Generation
                if (type === 'bubble-left') html += `<div class="bubble-row left"><div class="bubble left">${s}</div></div>`;
                else if (type === 'bubble-right') html += `<div class="bubble-row right"><div class="bubble right">${s}</div></div>`;
                else if (type === 'h1') html += `<h1 class="parsed-h1${alignClass}">${s}</h1>`;
                else if (type === 'h2') html += `<h2 class="parsed-h2${alignClass}">${s}</h2>`;
                else if (type === 'h3') html += `<h3 class="parsed-h3${alignClass}">${s}</h3>`;
                else html += `<p class="text-part${alignClass}${sizeClass}">${s}</p>`;
            });
            return html;
        }

        /* --- Text Utility Functions --- */
        function wrapHtmlTags(i) {
            const textarea = document.getElementById(`editor-${i}`);
            if (!textarea) return;
            const start = textarea.selectionStart; const end = textarea.selectionEnd; const text = textarea.value;
            const selected = text.substring(start, end);
            const newText = text.substring(0, start) + '\n```\n' + selected + '\n```\n' + text.substring(end);
            blocks[i].content = newText; textarea.value = newText; updateTextContent(i, newText);
        }

        function toggleConvMode(i) {
            let content = blocks[i].content;
            const SAFE_L = '##_LEFT_ARROW_##'; const SAFE_R = '##_RIGHT_ARROW_##';
            content = content.replace(/<</g, SAFE_L).replace(/>>/g, SAFE_R);
            const tags = [];
            let safeContent = content.replace(/<[^>]+>/g, function (match) { tags.push(match); return `__PROTECTED_TAG_${tags.length - 1}__`; });
            safeContent = safeContent.replace(new RegExp(SAFE_L, 'g'), '<<').replace(new RegExp(SAFE_R, 'g'), '>>');

            let lines = safeContent.split('\n');
            let arrowCnt = 0; let quoteCnt = 0;
            for (let line of lines) {
                const t = line.trim();
                if (t.startsWith('<< ')) continue;
                if (t.startsWith('>> ')) arrowCnt++;
                else if ((t.startsWith('"') && t.endsWith('"')) || (t.startsWith('‚Äú') && t.endsWith('‚Äù'))) quoteCnt++;
            }

            let targetMode = (arrowCnt >= quoteCnt) ? 'toQuote' : 'toArrow';
            lines = lines.map(line => {
                const t = line.trim();
                if (t.startsWith('<< ')) return line;
                if (targetMode === 'toQuote') {
                    if (t.startsWith('>> ')) return '"' + t.substring(3) + '"';
                } else {
                    if ((t.startsWith('"') && t.endsWith('"')) || (t.startsWith('‚Äú') && t.endsWith('‚Äù'))) {
                        let inner = t.substring(1, t.length - 1); return '>> ' + inner;
                    }
                }
                return line;
            });

            safeContent = lines.join('\n');
            content = safeContent.replace(/__PROTECTED_TAG_(\d+)__/g, function (match, id) { return tags[id]; });
            blocks[i].content = content;
            const editorEl = document.getElementById(`editor-${i}`);
            if (editorEl) editorEl.value = content;
            updateTextContent(i, content);
        }

        function removeStars(i) {
            let content = blocks[i].content;
            // Removes single * pair (italic), keeps ** pair (bold)
            content = content.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '$1');
            blocks[i].content = content;
            const editorEl = document.getElementById(`editor-${i}`);
            if (editorEl) editorEl.value = content;
            updateTextContent(i, content);
        }

        function removeEmptyLines(i) {
            let content = blocks[i].content;
            content = content.replace(/^\s*[\r\n]/gm, '');
            blocks[i].content = content;
            const editorEl = document.getElementById(`editor-${i}`);
            if (editorEl) editorEl.value = content;
            updateTextContent(i, content);
        }

        /* =========================================
           4. Block Rendering & Management
           ========================================= */
        function renderBlocks() {
            const c = document.getElementById('block-list');
            c.innerHTML = '';
            blocks.forEach((b, i) => {
                const isVisible = (b.visible !== false);
                const div = document.createElement('div');
                div.className = 'block-item';
                if (!isVisible) { div.style.opacity = '0.5'; div.style.background = '#f1f5f9'; }

                // Block Header & Controls
                let inner = `<div class="block-header">
          <span class="block-tag">${b.type === 'text' ? 'TXT' : 'IMG'} #${i + 1} ${!isVisible ? '(Ïà®ÍπÄ)' : ''}</span>
          <div class="block-controls">
            <button class="btn-sm" onclick="toggleVisible(${i})" title="${isVisible ? 'Ïà®Í∏∞Í∏∞' : 'Î≥¥Ïù¥Í∏∞'}" style="font-size:14px;">${isVisible ? 'üëÅÔ∏è' : 'üôà'}</button>
            ${b.type === 'text' ? `<button class="btn-sm" style="background:#f3e8ff; color:#6b21a8;" onclick="wrapHtmlTags(${i})" title="HTML Î≥¥Ìò∏ ÌÉúÍ∑∏ ÏîåÏö∞Í∏∞">üõ°Ô∏è</button>` : ''}
            ${b.type === 'text' ? `<button class="btn-sm" style="background:#fff7ed; color:#c2410c;" onclick="removeStars(${i})" title="Î≥ÑÌëú(*) ÏßÄÏö∞Í∏∞ (Í∞ïÏ°∞ Ï†úÏô∏)">üå†</button>` : ''}
            ${b.type === 'text' ? `<button class="btn-sm" style="background:#f1f5f9; color:#475569;" onclick="removeEmptyLines(${i})" title="Îπà Ï§Ñ ÏßÄÏö∞Í∏∞">üßπ</button>` : ''}
            ${b.type === 'text' ? `<button class="btn-sm" style="background:#eef2ff; color:#4f46e5;" onclick="openRegexModal(${i})" title="Ï†ïÍ∑úÏãù ÏπòÌôò">¬ÆÔ∏è</button>` : ''}
            ${b.type === 'text' ? `<button class="btn-sm" style="background:#e0f2fe; color:#0369a1;" onclick="smartExtract(event, ${i})" title="Î∞∞Í≤ΩÏÉâ Ï∂îÏ∂ú">üßô‚Äç‚ôÇÔ∏è</button>` : ''}
            ${b.type === 'text' ? `<button class="btn-sm" style="background:#f0fdf4; color:#15803d;" onclick="toggleConvMode(${i})" title="ÎßêÌíçÏÑ†/Îî∞Ïò¥Ìëú Î≥ÄÌôò">üí¨</button>` : ''}
            ${b.type === 'text' ? `<button class="btn-sm" onclick="splitBlock(event, ${i})" title="ÎÇòÎàÑÍ∏∞">‚úÇÔ∏è</button>` : ''}
            ${(i > 0 && blocks[i - 1].type === 'text' && b.type === 'text') ? `<button class="btn-sm" onclick="mergeUp(${i})" title="Ìï©ÏπòÍ∏∞">üß¥</button>` : ''}
            <button class="btn-sm" style="background:#fef3c7; color:#d97706;" onclick="triggerInsertImage(${i})" title="Ïù¥ÎØ∏ÏßÄ ÏÇΩÏûÖ">+üñºÔ∏è</button>
            <button class="btn-icon" onclick="moveBlock(${i},-1)">‚¨ÜÔ∏è</button>
            <button class="btn-icon" onclick="moveBlock(${i},1)">‚¨áÔ∏è</button>
            <button class="btn-icon" style="color:#ef4444;" onclick="delBlock(${i})">‚úñ</button>
          </div></div>`;

                if (b.type === 'text') {
                    // Text Block Editor UI
                    inner += `<div class="input-wrapper">
                        <textarea id="editor-${i}" class="code-editor" oninput="updateTextContent(${i}, this.value)">${b.content}</textarea>
                        <button class="btn-copy-floating" onclick="copyBlockContent(${i})" title="ÎÇ¥Ïö© Î≥µÏÇ¨">üìã</button>
                      </div>`;
                    inner += `<div style="text-align:right;"><span class="source-label" onclick="toggleSource(${i})">üíª ÏÜåÏä§ Î≥¥Í∏∞</span></div>`;
                    inner += `<textarea id="source-${i}" class="source-viewer" readonly>${parseContent(b.content)}</textarea>`;
                } else {
                    // Image Block UI
                    const imgW = b.width || 100;
                    inner += `<div style="text-align:center; margin-bottom:10px;"><img src="${b.content}" class="editor-img-preview"></div>
            
            <div style="background:#f8fafc; padding:8px; border-radius:8px; border:1px solid #e2e8f0;">
                <div style="display:flex; align-items:center; gap:8px; font-size:11px;">
                    <span style="font-weight:bold; color:#64748b; min-width:30px;">ÎÑàÎπÑ:</span>
                    <input type="range" id="img-range-${i}" min="10" max="100" value="${imgW}" style="flex:1" oninput="updateImgWidth(${i}, this.value, 'range')">
                    <input type="number" id="img-num-${i}" value="${imgW}" style="width:50px; text-align:right; border:1px solid #cbd5e1; border-radius:4px;" oninput="updateImgWidth(${i}, this.value, 'number')">
                    <span>%</span>
                    <input type="checkbox" class="lock-chk" title="ÌÅ¨Í∏∞ Ïû†Í∏à" onchange="toggleImgLock(${i}, this.checked)">
                </div>
            </div>

            <div style="text-align:right; margin-top:5px;"><span class="source-label" onclick="toggleSource(${i})">üíª Base64</span></div>
            <textarea id="source-${i}" class="source-viewer" readonly>${b.content.substring(0, 200)}...</textarea>`;
                }
                div.innerHTML = inner; c.appendChild(div);
            });
        }

        function updateTextContent(i, val) {
            blocks[i].content = val;
            if (debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const v = document.getElementById(`source-${i}`);
                if (v) v.value = parseContent(val);
                updatePreview();
                saveData();
            }, 300);
        }


        /* --- UI Helper Functions --- */
        function updateVal(id, val) { const display = document.getElementById('val-' + id); if (display) display.innerText = val; }

        function hexToRgba(hex, alpha) {
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) { r = parseInt(hex[1] + hex[1], 16); g = parseInt(hex[2] + hex[2], 16); b = parseInt(hex[3] + hex[3], 16); }
            else { r = parseInt(hex.substring(1, 3), 16); g = parseInt(hex.substring(3, 5), 16); b = parseInt(hex.substring(5, 7), 16); }
            return `rgba(${r},${g},${b},${alpha})`;
        }

        /* =========================================
           5. Preview Rendering Engine (Core)
           ========================================= */
        function updatePreview() {
            const area = document.getElementById('capture-area');
            const widthInput = document.getElementById('cardWidthInput');
            if (!area || !widthInput) return;

            const width = widthInput.value;
            const globalAlign = document.getElementById('textAlignInput').value;
            const cssScaleVal = document.getElementById('cssScale') ? document.getElementById('cssScale').value : 1;

            // 1. Set Container Dimensions
            area.style.width = width + "px";
            const cardW = parseInt(width);

            // 2. Calculate Zoom Scale
            let scale = 1;
            if (currentZoom === 'auto') {
                area.style.transform = 'none';
                const cardH = area.scrollHeight;
                const availH = window.innerHeight - 200;
                const availW = window.innerWidth - 40;

                if (cardH > 0) {
                    const scaleH = availH / cardH;
                    const scaleW = availW / cardW;
                    scale = Math.min(scaleH, scaleW, 1.0);
                }
                document.getElementById('zoomRange').value = Math.round(scale * 100);
                document.getElementById('zoomLabel').innerText = 'FIT';
            } else {
                scale = currentZoom / 100;
                document.getElementById('zoomLabel').innerText = currentZoom + '%';
            }
            area.style.transform = `scale(${scale})`;

            // 3. Fetch Style Settings
            const fSize = document.getElementById('fontSize').value;
            const fWeight = document.getElementById('fontWeight').value;
            const lHeight = document.getElementById('lineHeight').value;
            const pad = document.getElementById('paddingRange').value;
            const font = document.getElementById('fontSelect').value;
            const isPlain = document.getElementById('noItalic').checked;

            // 4. Resolve Italic/Bold logic
            const itStyle = isPlain ? 'normal' : 'italic';
            const itWeight = isPlain ? fWeight : '700';
            const activeItalicColor = isPlain ? colors.text : colors.it;

            // 5. Generate Background Style
            const ang = document.getElementById('gradAngle').value;
            const c1 = hexToRgba(colors.bg1, 1);
            const c2 = hexToRgba(colors.bg2, 1);
            const gradLayer = `linear-gradient(${ang}deg, ${c1} 0%, ${c2} 100%)`;

            let bgStyle = (bgState.mode === 'image' && bgState.imgData) ?
                `background-image: linear-gradient(${hexToRgba(bgState.overlayColor, document.getElementById('overlayAlpha').value)}, ${hexToRgba(bgState.overlayColor, document.getElementById('overlayAlpha').value)}), url('${bgState.imgData}'), ${gradLayer}; background-size: 100% 100%, ${bgState.sizeMode === 'cover' ? 'cover' : bgState.scale + '% auto'}, 100% 100%; background-position: center, ${bgState.posX}% ${bgState.posY}%, center; background-repeat: no-repeat;` :
                `background: ${gradLayer};`;

                        // 6. Construct CSS Variables
            const wncsScaleVal = document.getElementById('wncsScale').value / 100; // 35 -> 0.35
            
            const cssVars = `--word-break:${document.getElementById('wordBreakInput').value}; --global-align:${globalAlign}; --base-weight:${fWeight}; --hl-bg:${colors.hlbg}; --hl-col:${colors.hltx}; --th-col:${colors.th}; --bd-col:${colors.bd}; --qt-col:${colors.qt}; --it-col:${activeItalicColor}; --it-weight:${itWeight}; --it-style:${itStyle}; --hr-col:${colors.hr}; --bb-l-bg:${colors.bb_l_bg}; --bb-l-tx:${colors.bb_l_tx}; --bb-r-bg:${colors.bb_r_bg}; --bb-r-tx:${colors.bb_r_tx}; --sms-bg:${colors.sms_bg}; --sms-tx:${colors.sms_tx}; --base-sz:${fSize}px; --base-lh:${lHeight}; --para-sp:${document.getElementById('paraSpacing').value}px; --wncs-scale:${wncsScaleVal}; --css-scale:${cssScaleVal};`;
            // ÎààÍ∏à HTML ÏÉùÏÑ±
            const rulers = `
            <div class="ruler-guide guide-left" style="top:50%" data-label="1/2"></div>
            <div class="ruler-guide guide-right" style="top:33.33%" data-label="1/3"></div>
            <div class="ruler-guide guide-right" style="top:66.66%" data-label="2/3"></div>
        `;


            // [ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ] updatePreview Ìï®Ïàò ÎÇ¥Î∂ÄÏùò Î†åÎçîÎßÅ Î°úÏßÅ
            // 7. Render Final HTML (rulers + card)
            // Î≥ÄÍ≤ΩÏ†ê: Í∞Å Î∏îÎ°ùÏùÑ Í∞êÏã∏Îäî divÏóê 'preview-block-item' ÌÅ¥ÎûòÏä§ÏôÄ 'data-index' ÏÜçÏÑ± Ï∂îÍ∞Ä
            area.innerHTML = rulers + `<div class="card-frame" style="width:${width}px; padding:${pad}px; ${bgStyle} color:${colors.text}; font-family:${font}; font-weight:var(--base-weight, 400); ${cssVars}">` +
                blocks.map((b, i) => {
                    if (b.visible === false) return '';

                    // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Î•º ÏúÑÌï¥ Í∞êÏã∏Îäî ÎûòÌçº(Wrapper) Ï∂îÍ∞Ä
                    return `<div class="preview-block-item" data-index="${i}" style="cursor: pointer;" title="ÌÅ¥Î¶≠ÌïòÏó¨ ÏàòÏ†ïÌïòÍ∏∞">` +
                        (b.type === 'text'
                            ? `<div style="display:contents;">${parseContent(b.content)}</div>`
                            : `<div style="text-align:center; margin:var(--para-sp) 0;"><img src="${b.content}" style="width:${b.width || 100}%; border-radius:8px;"></div>`)
                        + `</div>`;
                }).join('') + `</div>`;
        }

        /* =========================================
           6. Style & Preset Management
           ========================================= */
        function setColor(k, v) { colors[k] = v; updateUI(); updatePreview(); saveData(); }

        function updateUI() {
            for (const [k, v] of Object.entries(colors)) {
                const p = document.getElementById(k + '-pv'), t = document.getElementById(k + '-txt');
                if (p) { p.style.backgroundColor = v; if (p.nextElementSibling && p.nextElementSibling.type === 'color') p.nextElementSibling.value = v; }
                if (t) t.value = v;
            }
        }

        function toggleStylePanel() {
            const s = document.getElementById('styleBody'); const b = document.getElementById('btnStyleToggle');
            if (s.style.display === 'none') {
                s.style.display = 'block';
                if (b) b.innerText = 'üé® Ïä§ÌÉÄÏùº ÏÑ§Ï†ï ‚ñ≤';
                document.getElementById('editorContent').scrollTop = 0;
            }
            else { s.style.display = 'none'; if (b) b.innerText = 'üé® Ïä§ÌÉÄÏùº ÏÑ§Ï†ï ‚ñº'; }
        }

        function setFont(fontName) {
            document.getElementById('fontSelect').value = fontName;
            const btns = document.querySelectorAll('.font-btn');
            btns.forEach(btn => {
                if (btn.getAttribute('onclick').includes(fontName.replace(/'/g, "\\'"))) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            updatePreview(); saveData();
        }

        function switchTab(t, e) {
            document.querySelectorAll('.style-section').forEach(e => e.classList.remove('active'));
            document.getElementById('sect-' + t).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            if (e) e.target.classList.add('active');
        }

        function toggleImgPanel(isChecked, save = true) { bgState.mode = isChecked ? 'image' : 'gradient'; const panel = document.getElementById('img-controls'); if (isChecked) panel.classList.remove('hidden'); else panel.classList.add('hidden'); updatePreview(); if (save) saveData(); }

        function setBgSize(s, save = true) {
            bgState.sizeMode = s;
            document.getElementById('btnCover').className = s === 'cover' ? 'btn-fit active' : 'btn-fit';
            document.getElementById('btnContain').className = s === 'contain' ? 'btn-fit active' : 'btn-fit';
            const isDisabled = (s === 'cover');
            const ids = ['bgScale', 'bgPosX', 'bgPosY'];
            ids.forEach(id => {
                const el = document.getElementById(id); const row = document.getElementById('row-' + id);
                if (el) el.disabled = isDisabled;
                if (row) { if (isDisabled) row.classList.add('disabled'); else row.classList.remove('disabled'); }
            });
            updatePreview(); if (save) saveData();
        }

        function resetBgPos() {
            document.getElementById('bgPosX').value = 50; document.getElementById('bgPosY').value = 50; document.getElementById('bgScale').value = 100;
            document.getElementById('input-bgPosX').value = 50; document.getElementById('input-bgPosY').value = 50; document.getElementById('input-bgScale').value = 100;
            bgState.posX = 50; bgState.posY = 50; bgState.scale = 100;
            updateVal('bgPosX', 50); updateVal('bgPosY', 50); updateVal('bgScale', 100);
            updatePreview(); saveData();
        }

        function handleBgUpload(i) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = e => { bgState.imgData = e.target.result; document.getElementById('showImgOption').checked = true; toggleImgPanel(true); setBgSize('contain'); }; r.readAsDataURL(f); }
        function setOverlay(c, b) { bgState.overlayColor = c; document.querySelectorAll('.btn-overlay').forEach(el => el.classList.remove('selected')); b.classList.add('selected'); updatePreview(); saveData(); }

        /* --- Preset Handling --- */
        function applyPreset(p) {
            colors = { ...colors, ...p };

            // [ÏàòÏ†ïÎê®] ÌîÑÎ¶¨ÏÖãÏóê Ìè∞Ìä∏Í∞Ä ÏßÄÏ†ïÎêòÏñ¥ ÏûàÏùÑ ÎïåÎßå Î≥ÄÍ≤Ω (ÏóÜÏúºÎ©¥ ÌòÑÏû¨ Ìè∞Ìä∏ Ïú†ÏßÄ)
            if (p.font) {
                const targetFont = p.font;
                document.getElementById('fontSelect').value = targetFont;
                const btns = document.querySelectorAll('.font-btn');
                btns.forEach(b => b.classList.remove('active'));
                let targetBtn = Array.from(btns).find(b => {
                    const clickAttr = b.getAttribute('onclick');
                    return clickAttr && clickAttr.includes(targetFont.replace(/'/g, "\\'"));
                });
                if (!targetBtn && btns.length > 0) targetBtn = btns[0];
                if (targetBtn) targetBtn.classList.add('active');
            }

            if (p.textAlign) { setAlign(p.textAlign, false); }

            if (p.padding !== undefined) { document.getElementById('paddingRange').value = p.padding; updateVal('paddingRange', p.padding); }
            if (p.gradAngle !== undefined) {
                document.getElementById('gradAngle').value = p.gradAngle; updateVal('gradAngle', p.gradAngle);
                const angleInput = document.getElementById('input-gradAngle'); if (angleInput) angleInput.value = p.gradAngle;
            }
            if (p.paraSpacing !== undefined) { document.getElementById('paraSpacing').value = p.paraSpacing; updateVal('paraSpacing', p.paraSpacing); }
            if (p.width !== undefined) { document.getElementById('cardWidthInput').value = p.width; }
            if (p.noItalic !== undefined) { document.getElementById('noItalic').checked = p.noItalic; }

            // [ÏÉàÎ°ú Ï∂îÍ∞ÄÎê®] Í∏ÄÏûê ÌÅ¨Í∏∞, ÍµµÍ∏∞, Ï§ÑÍ∞ÑÍ≤© Ï†ÅÏö© Î°úÏßÅ
            if (p.fontSize !== undefined) {
                document.getElementById('fontSize').value = p.fontSize;
                updateVal('fontSize', p.fontSize);
            }
            if (p.fontWeight !== undefined) {
                document.getElementById('fontWeight').value = p.fontWeight;
                updateVal('fontWeight', p.fontWeight);
            }
            if (p.lineHeight !== undefined) {
                document.getElementById('lineHeight').value = p.lineHeight;
                updateVal('lineHeight', p.lineHeight);
            }

            if (p.bgState) {
                bgState = { ...bgState, ...p.bgState };
                updateVal('bgScale', bgState.scale); updateVal('bgPosX', bgState.posX); updateVal('bgPosY', bgState.posY);
                document.getElementById('bgScale').value = bgState.scale; document.getElementById('bgPosX').value = bgState.posX; document.getElementById('bgPosY').value = bgState.posY;
                if (bgState.mode === 'image') { document.getElementById('showImgOption').checked = true; toggleImgPanel(true, false); }
                else { document.getElementById('showImgOption').checked = false; toggleImgPanel(false, false); }
                setBgSize(bgState.sizeMode, false);
            }
            updateUI(); updatePreview(); saveData();
        }

        function initPresets() {
            const c = document.getElementById('presetList'); c.innerHTML = '';
            presets.forEach((p, idx) => {
                const b = document.createElement('div'); b.className = 'btn-preset';
                b.style.background = `linear-gradient(135deg, ${p.bg1}, ${p.bg2})`; b.title = p.name || 'ÌîÑÎ¶¨ÏÖã'; b.onclick = () => { applyPreset(p); };
                if (idx >= 14) {
                    b.classList.add('deletable');
                    b.onclick = (e) => {
                        const rect = b.getBoundingClientRect(); const isX = (e.clientX - rect.right) > -15 && (e.clientY - rect.top) < 15;
                        if (isX && confirm('Ïù¥ ÌîÑÎ¶¨ÏÖãÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) { e.stopPropagation(); presets.splice(idx, 1); initPresets(); saveData(); } else { applyPreset(p); }
                    }
                }
                c.appendChild(b);
            });
        }

        function saveCurrentToPreset() {
            const name = prompt("ÌòÑÏû¨ ÏÑ§Ï†ïÏùÑ Ï†ÄÏû•Ìï©ÎãàÎã§. Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:", "ÎÇòÎßåÏùò ÌîÑÎ¶¨ÏÖã");
            if (name) {
                // Í∏∞Ï°¥Ïóê ÏóÜÎçò Ìï≠Î™©Îì§(fontSize, fontWeight, lineHeight) Ï∂îÍ∞Ä
                const currentPadding = document.getElementById('paddingRange').value;
                const currentFont = document.getElementById('fontSelect').value;
                const currentAngle = document.getElementById('gradAngle').value;
                const currentWidth = document.getElementById('cardWidthInput').value;
                const currentNoItalic = document.getElementById('noItalic').checked;
                const currentParaSpacing = document.getElementById('paraSpacing').value;
                const currentAlign = document.getElementById('textAlignInput').value;

                // Ï∂îÍ∞ÄÎêú Ìï≠Î™©Îì§
                const currentFontSize = document.getElementById('fontSize').value;
                const currentFontWeight = document.getElementById('fontWeight').value;
                const currentLineHeight = document.getElementById('lineHeight').value;

                const newPreset = {
                    name: name,
                    ...colors,
                    padding: currentPadding,
                    textAlign: currentAlign,
                    font: currentFont,
                    gradAngle: currentAngle,
                    width: currentWidth,
                    noItalic: currentNoItalic,
                    paraSpacing: currentParaSpacing,
                    // Ïó¨Í∏∞Ïóê ÏÉàÎ°ú Ï∂îÍ∞Ä
                    fontSize: currentFontSize,
                    fontWeight: currentFontWeight,
                    lineHeight: currentLineHeight,

                    bgState: { ...bgState }
                };
                presets.push(newPreset); initPresets(); saveData();
            }
        }

        function setAlign(align, save = true) {
            document.getElementById('textAlignInput').value = align;
            const modes = ['left', 'center', 'right', 'justify'];
            modes.forEach(m => {
                const btn = document.getElementById('align-' + m);
                if (btn) {
                    if (m === align) btn.classList.add('active');
                    else btn.classList.remove('active');
                }
            });
            updatePreview();
            if (save) saveData();
        }

        function exportPresets() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(presets));
            const dlNode = document.createElement('a'); dlNode.setAttribute("href", dataStr); dlNode.setAttribute("download", "LogCard_presets_v1_8_1.json");
            document.body.appendChild(dlNode); dlNode.click(); dlNode.remove();
        }

        function loadPresets(input) {
            const file = input.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = function (e) { try { const loaded = JSON.parse(e.target.result); if (Array.isArray(loaded)) { presets = loaded; initPresets(); saveData(); alert("ÌîÑÎ¶¨ÏÖãÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∂àÎü¨ÏôîÏäµÎãàÎã§!"); } else { alert("Ïò¨Î∞îÎ•∏ JSON ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§."); } } catch (err) { alert("ÌååÏùº Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."); } };
            reader.readAsText(file); input.value = '';
        }

        /* =========================================
           7. Block Manipulation Helpers
           ========================================= */
        function addBlock(t) { blocks.push({ type: t, content: '' }); renderBlocks(); updatePreview(); saveData(); }
        function addImgBlock(i) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = e => { blocks.push({ type: 'image', content: e.target.result }); renderBlocks(); updatePreview(); saveData(); i.value = ''; }; r.readAsDataURL(f); }
        function delBlock(i) { if (confirm('Ïù¥ Î∏îÎ°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) { blocks.splice(i, 1); renderBlocks(); updatePreview(); saveData(); } }
        function splitBlock(e, i) { const t = document.getElementById('editor-' + i); if (!t) return; const v = t.value, p = t.selectionStart; blocks[i].content = v.substring(0, p); blocks.splice(i + 1, 0, { type: 'text', content: v.substring(p) }); renderBlocks(); updatePreview(); saveData(); }
        function mergeUp(i) { if (confirm('ÏúÑ Î∏îÎ°ùÍ≥º Ìï©ÏπòÏãúÍ≤†ÏäµÎãàÍπå?')) { blocks[i - 1].content += "\n" + blocks[i].content; blocks.splice(i, 1); renderBlocks(); updatePreview(); saveData(); } }
        function moveBlock(i, d) { const n = i + d; if (n < 0 || n >= blocks.length) return;[blocks[n], blocks[i]] = [blocks[i], blocks[n]]; renderBlocks(); updatePreview(); saveData(); }

        /* =========================================
           Ïù¥ÎØ∏ÏßÄ ÎÑàÎπÑ Ï°∞Ï†à Ìï®Ïàò
           ========================================= */
        function updateImgWidth(i, v, source) {
            let val = parseInt(v);
        
            // 1. Í∞íÏù¥ ÏóÜÍ±∞ÎÇò Ïà´ÏûêÍ∞Ä ÏïÑÎãàÎ©¥(Îã§ ÏßÄÏõ†ÏùÑ Îïå) Î¨¥Ïãú
            if (isNaN(val)) return;
        
            // 2. Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö©Ïö© 'ÏïàÏ†ÑÌïú Í∞í' Í≥ÑÏÇ∞ (10~100 ÏÇ¨Ïù¥Î°ú Ï†úÌïú)
            // ÏÇ¨Ïö©ÏûêÍ∞Ä '5'ÎùºÍ≥† Ï≥êÎèÑ ÎÇ¥Î∂ÄÏ†ÅÏúºÎ°úÎäî '10'ÏúºÎ°ú Ï≤òÎ¶¨Ìï¥ ÌîÑÎ¶¨Î∑∞Í∞Ä Íπ®ÏßÄÏßÄ ÏïäÍ≤å Ìï®
            let safeVal = val;
            if (safeVal < 10) safeVal = 10;
            if (safeVal > 100) safeVal = 100;
        
            blocks[i].width = safeVal;
        
            const rangeEl = document.getElementById(`img-range-${i}`);
            const numEl = document.getElementById(`img-num-${i}`);
        
            // 3. Ïä¨ÎùºÏù¥ÎçîÎäî Ìï≠ÏÉÅ ÏïàÏ†ÑÌïú Í∞íÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
            if (rangeEl) rangeEl.value = safeVal;
        
            // 4. [ÌïµÏã¨ ÏàòÏ†ï] ÌÖçÏä§Ìä∏ ÏûÖÎ†•Ï∞Ω ÏóÖÎç∞Ïù¥Ìä∏ Î°úÏßÅ Î≥ÄÍ≤Ω
            // Ïä¨ÎùºÏù¥ÎçîÎ•º ÏõÄÏßÅÏòÄÏùÑ Îïå(source !== 'number')Îßå ÌÖçÏä§Ìä∏Ï∞ΩÏùÑ Í∞ïÏ†úÎ°ú Î∞îÍøà.
            // ÏßÅÏ†ë ÌÉÄÏù¥Ìïë Ï§ë(source === 'number')Ïùº ÎïåÎäî Í±¥ÎìúÎ¶¨ÏßÄ ÏïäÏïÑÏÑú ÏûÖÎ†•ÏùÑ Î∞©Ìï¥ÌïòÏßÄ ÏïäÏùå.
            if (numEl && source !== 'number') {
                numEl.value = safeVal;
            }
        
            updatePreview();
            saveData();
        }

        function toggleImgLock(i, isLocked) {
            const rangeEl = document.getElementById(`img-range-${i}`);
            const numEl = document.getElementById(`img-num-${i}`);
            if (rangeEl) rangeEl.disabled = isLocked;
            if (numEl) numEl.disabled = isLocked;
            if (rangeEl && rangeEl.parentElement) { rangeEl.parentElement.style.opacity = isLocked ? '0.5' : '1'; }
        }

        function triggerInsertImage(i) { insertTargetIndex = i; document.getElementById('insertImgFileInput').click(); }
        function handleInsertImgUpload(i) { const f = i.files[0]; if (!f) return; const r = new FileReader(); r.onload = e => { blocks.splice(insertTargetIndex + 1, 0, { type: 'image', content: e.target.result, width: 100 }); renderBlocks(); updatePreview(); saveData(); i.value = ''; }; r.readAsDataURL(f); }
        function toggleSource(i) { document.getElementById(`source-${i}`).classList.toggle('show'); }

        // Editor Toggle (Responsive)
        function toggleEditor() {
            const area = document.getElementById('editorArea');
            const icon = document.getElementById('foldIcon');
            area.style.transition = 'transform 0.4s cubic-bezier(0.25, 1, 0.5, 1)';
            area.classList.toggle('collapsed');
            const isPC = window.matchMedia("(min-width: 1024px)").matches;
            if (area.classList.contains('collapsed')) { icon.innerText = isPC ? '‚ñ≤' : '‚ñ≤'; }
            else { icon.innerText = isPC ? '‚ñº' : '‚ñº'; }
        }

        // Drag Handle Logic for Mobile
        setTimeout(() => {
            const handle = document.querySelector('.index-handle');
            const editorArea = document.getElementById('editorArea');
            let isDragging = false;
            let startY = 0;
            let startHeight = 0;

            if (handle && editorArea) {
                handle.addEventListener('pointerdown', function (e) {
                    if (e.target.id === 'foldIcon') return;
                    if (window.matchMedia("(min-width: 1024px)").matches) return;
                    isDragging = true;
                    startY = e.clientY;
                    startHeight = editorArea.getBoundingClientRect().height;
                    handle.setPointerCapture(e.pointerId);
                    editorArea.style.transition = 'none';
                });

                handle.addEventListener('pointermove', function (e) {
                    if (!isDragging) return;
                    const delta = startY - e.clientY;
                    const newHeight = startHeight + delta;
                    if (newHeight > 150 && newHeight < window.innerHeight * 0.9) { editorArea.style.height = `${newHeight}px`; }
                });

                handle.addEventListener('pointerup', function (e) {
                    if (!isDragging) return;
                    isDragging = false;
                    handle.releasePointerCapture(e.pointerId);
                    editorArea.style.transition = 'transform 0.4s cubic-bezier(0.25, 1, 0.5, 1)';
                });
            }
        }, 500);

        // Color Extraction (Smart Extract)
        function smartExtract(e, i) {
            if (e) e.stopPropagation();
            const c = blocks[i].content; const parser = new DOMParser(); const doc = parser.parseFromString(c, 'text/html');
            let el = doc.querySelector('[style*="background"]'); if (!el) el = doc.body.firstElementChild;
            if (!el) { alert("Ï∂îÏ∂úÌï† Î∞∞Í≤Ω ÏöîÏÜåÎ•º Ï∞æÏßÄ Î™ªÌñàÏäµÎãàÎã§."); return; }

            let c1, c2, foundColor = false;
            if (el.style && el.style.background) { const m = el.style.background.match(/#(?:[0-9a-fA-F]{3}){1,2}/g); if (m) { if (m.length >= 2) { c1 = m[0]; c2 = m[1]; } else if (m.length === 1) { c1 = m[0]; c2 = m[0]; } foundColor = true; } }
            if (!foundColor) { const m = c.match(/#(?:[0-9a-fA-F]{3}){1,2}/g); if (m) { if (m.length >= 2) { c1 = m[0]; c2 = m[1]; } else if (m.length === 1) { c1 = m[0]; c2 = m[0]; } foundColor = true; } }

            if (foundColor) {
                if (confirm(`Î∞∞Í≤ΩÏÉâÏùÑ Í∞êÏßÄÌñàÏäµÎãàÎã§ (${c1}). Ï†ÅÏö©ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                    setColor('bg1', c1); setColor('bg2', c2);
                    while (el.firstChild) { el.parentNode.insertBefore(el.firstChild, el); } el.remove();
                    blocks[i].content = doc.body.innerHTML.trim().replace(/&gt;/g, '>').replace(/&lt;/g, '<').replace(/&amp;/g, '&');
                    renderBlocks(); updatePreview(); saveData();
                }
            } else { alert("Î∞∞Í≤ΩÏÉâ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."); }
        }

        function toggleVisible(i) {
            if (blocks[i].visible === undefined) blocks[i].visible = true;
            blocks[i].visible = !blocks[i].visible;
            renderBlocks(); updatePreview(); saveData();
        }

        function getFileName(ext) {
            const d = new Date();
            const y = d.getFullYear(); const m = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0'); const h = String(d.getHours()).padStart(2, '0'); const min = String(d.getMinutes()).padStart(2, '0'); const s = String(d.getSeconds()).padStart(2, '0');
            // Version Updated in Filename
            return `Log_Card_v1_8_1_${y}${m}${day}_${h}${min}${s}.${ext}`;
        }

        /* =========================================
           8. Save / Export Functions
           ========================================= */

        // Image Save: ÌôîÏßà ÏòµÏÖò(quality) Ï∂îÍ∞Ä Î∞è Î≤ÑÌäº ÏÉÅÌÉú Í∞úÎ≥Ñ Ï†úÏñ¥
        async function saveImage(btn, quality) {
            const widthInput = document.getElementById('cardWidthInput');
            const frame = document.querySelector('.card-frame');
            const realWidth = parseInt(widthInput.value);

            // ÌÅ¥Î¶≠Îêú Î≤ÑÌäºÏùò ÌÖçÏä§Ìä∏Î•º Ïû†Ïãú Î°úÎî© ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω
            const originalText = btn.innerText;
            btn.innerText = "‚è≥ Ìè∞Ìä∏ Î°úÎî© Ï§ë...";

            // Ìè∞Ìä∏ Î°úÎî© ÎåÄÍ∏∞
            try {
                await document.fonts.ready;
                await new Promise(resolve => setTimeout(resolve, 100));
            } catch (e) { console.log(e); }

            btn.innerText = "üì∏ Ïó¥Ïã¨Ìûà Ï∞çÎäî Ï§ë...";

            // ÌôîÏßà ÏÑ§Ï†ï: Í≥†ÌôîÏßàÏù¥Î©¥ 2, Í∏∞Î≥∏Ïù¥Î©¥ 1
            const ratio = (quality === 'high') ? 2 : 1;

            htmlToImage.toPng(frame, {
                cacheBust: true,
                pixelRatio: ratio, // Ïó¨Í∏∞ÏÑú ÌôîÏßà Í≤∞Ï†ï
                width: realWidth,
                height: frame.scrollHeight,
                style: {
                    width: realWidth + 'px',
                    minWidth: realWidth + 'px',
                    maxWidth: realWidth + 'px',
                    height: 'auto',
                    transform: 'none',
                    margin: '0',
                    display: 'block',
                    boxSizing: 'border-box',
                    whiteSpace: 'normal',
                    overflow: 'visible'
                }
            })
                .then(dataUrl => {
                    const link = document.createElement('a');
                    // ÌååÏùºÎ™ÖÏóê ÌôîÏßà Ï†ïÎ≥¥(_HQ Îì±)Î•º Î∂ôÏó¨ÏÑú Íµ¨Î∂Ñ
                    const suffix = (quality === 'high') ? '_HQ' : '';
                    link.download = getFileName('png').replace('.png', `${suffix}.png`);
                    link.href = dataUrl;
                    link.click();

                    // Î≤ÑÌäº ÌÖçÏä§Ìä∏ ÏõêÎ≥µ
                    setTimeout(() => { btn.innerText = originalText; }, 1000);
                })
                .catch(err => {
                    console.error('Capture failed:', err);
                    alert("Ïù¥ÎØ∏ÏßÄ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
                    btn.innerText = originalText;
                });
        }

        /* =========================================
       Project Save / Load (JSON)
       ========================================= */

        // Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (ÌÖçÏä§Ìä∏, Ïù¥ÎØ∏ÏßÄ, ÏÑ§Ï†ï Îì± Î™®Îëê Ìè¨Ìï®)
        function exportProject() {
            const data = {
                version: "1.5.1",
                date: new Date().toISOString(),
                colors,
                bgState,
                blocks,
                presets,
                customCss: userCustomCss,
                settings: {
                    width: document.getElementById('cardWidthInput').value,
                    padding: document.getElementById('paddingRange').value,
                    fontSize: document.getElementById('fontSize').value,
                    fontWeight: document.getElementById('fontWeight').value,
                    lineHeight: document.getElementById('lineHeight').value,
                    font: document.getElementById('fontSelect').value,
                    angle: document.getElementById('gradAngle').value,
                    overlayAlpha: document.getElementById('overlayAlpha').value,
                    paraSpacing: document.getElementById('paraSpacing').value,
                    textAlign: document.getElementById('textAlignInput').value,
                    wordBreak: document.getElementById('wordBreakInput').value,
                    noItalic: document.getElementById('noItalic').checked
                }
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            // ÌååÏùºÎ™ÖÏóê _ProjectÎ•º Î∂ôÏó¨ÏÑú Íµ¨Î∂Ñ
            dlNode.setAttribute("download", getFileName('json').replace('.json', '_Project.json'));
            document.body.appendChild(dlNode);
            dlNode.click();
            dlNode.remove();
        }

        // ÌîÑÎ°úÏ†ùÌä∏ ÌååÏùº Î∂àÎü¨Ïò§Í∏∞
        function loadProject(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (confirm("ÌòÑÏû¨ ÏûëÏóÖ ÎÇ¥Ïö©ÏùÑ ÎçÆÏñ¥Ïì∞Í≥† ÌîÑÎ°úÏ†ùÌä∏Î•º Î∂àÎü¨Ïò§ÏãúÍ≤†ÏäµÎãàÍπå?")) {
                        // Îç∞Ïù¥ÌÑ∞ Î≥µÍµ¨
                        if (data.colors) colors = data.colors;
                        if (data.bgState) bgState = data.bgState;
                        if (data.blocks) blocks = data.blocks;
                        if (data.presets) presets = data.presets; // Ï†ÄÏû•Îêú ÌîÑÎ¶¨ÏÖã Î™©Î°ùÎèÑ Î≥µÍµ¨
                        if (data.customCss) {
                                userCustomCss = data.customCss;
                                applyCustomCss(userCustomCss);
                            }
                        if (data.settings) {
                            document.getElementById('cardWidthInput').value = data.settings.width || 1080;
                            document.getElementById('paddingRange').value = data.settings.padding || 90;
                            document.getElementById('fontSize').value = data.settings.fontSize || 45;
                            document.getElementById('fontWeight').value = data.settings.fontWeight || 400;
                            document.getElementById('lineHeight').value = data.settings.lineHeight || 1.3;
                            document.getElementById('fontSelect').value = data.settings.font || "Pretendard, sans-serif";

                            setWordBreak(data.settings.wordBreak || 'break-all', false);
                            setAlign(data.settings.textAlign || 'justify', false);

                            // Ìè∞Ìä∏ Î≤ÑÌäº ÏÉÅÌÉú ÎèôÍ∏∞Ìôî
                            const savedFont = data.settings.font || "Pretendard, sans-serif";
                            const btns = document.querySelectorAll('.font-btn');
                            btns.forEach(btn => btn.classList.remove('active'));
                            let targetBtn = Array.from(btns).find(b => b.getAttribute('onclick').includes(savedFont.replace(/'/g, "\\'")));
                            if (!targetBtn) targetBtn = btns[0];
                            if (targetBtn) targetBtn.classList.add('active');

                            document.getElementById('gradAngle').value = data.settings.angle || 235;
                            document.getElementById('input-gradAngle').value = data.settings.angle || 235;

                            document.getElementById('overlayAlpha').value = data.settings.overlayAlpha || 0.5;
                            document.getElementById('paraSpacing').value = data.settings.paraSpacing || 27;
                            document.getElementById('noItalic').checked = data.settings.noItalic || false;
                        }

                        // UI Í∞í ÏóÖÎç∞Ïù¥Ìä∏ (Ïä¨ÎùºÏù¥Îçî Ïà´Ïûê Îì±)
                        updateVal('fontSize', document.getElementById('fontSize').value);
                        updateVal('fontWeight', document.getElementById('fontWeight').value);
                        updateVal('lineHeight', document.getElementById('lineHeight').value);
                        updateVal('gradAngle', document.getElementById('gradAngle').value);
                        updateVal('overlayAlpha', document.getElementById('overlayAlpha').value);
                        updateVal('paraSpacing', document.getElementById('paraSpacing').value);
                        updateVal('paddingRange', document.getElementById('paddingRange').value);

                        // Î∞∞Í≤Ω Î™®Îìú Î≥µÍµ¨
                        if (bgState.mode === 'image') {
                            document.getElementById('showImgOption').checked = true;
                            toggleImgPanel(true, false);
                        } else {
                            document.getElementById('showImgOption').checked = false;
                            toggleImgPanel(false, false);
                        }

                        // Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï Î≥µÍµ¨
                        updateVal('bgScale', bgState.scale);
                        updateVal('bgPosX', bgState.posX);
                        updateVal('bgPosY', bgState.posY);
                        document.getElementById('bgScale').value = bgState.scale;
                        document.getElementById('bgPosX').value = bgState.posX;
                        document.getElementById('bgPosY').value = bgState.posY;

                        setBgSize(bgState.sizeMode, false); // Cover/Contain ÏÉÅÌÉú Î≥µÍµ¨

                        // ÌôîÎ©¥ Í∞±Ïã† Î∞è ÏûêÎèô Ï†ÄÏû•
                        initPresets(); // ÌîÑÎ¶¨ÏÖã Î™©Î°ù Í∞±Ïã†
                        updateUI();    // ÏÉâÏÉÅ Îì± UI Í∞±Ïã†
                        renderBlocks(); // ÌÖçÏä§Ìä∏/Ïù¥ÎØ∏ÏßÄ Î∏îÎ°ù Îã§Ïãú Í∑∏Î¶¨Í∏∞
                        updatePreview(); // ÎØ∏Î¶¨Î≥¥Í∏∞ Í∞±Ïã†
                        saveData();    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•

                        alert("ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÌîÑÎ°úÏ†ùÌä∏Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§!");
                    }
                } catch (err) {
                    alert("ÌååÏùºÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïò¨Î∞îÎ•∏ JSON ÌååÏùºÏù∏ÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
            input.value = ''; // Í∞ôÏùÄ ÌååÏùº Îã§Ïãú Î°úÎìú Í∞ÄÎä•ÌïòÍ≤å Ï¥àÍ∏∞Ìôî
        }


        // HTML Save: Generates standalone HTML with v1.8.1 headers
        function saveHtml() {
            const content = document.getElementById('capture-area').innerHTML;
            const widthVal = document.getElementById('cardWidthInput').value;

            const cssVars = `
            --wncs-scale: ${document.getElementById('wncsScale').value / 100}; /* Ï∂îÍ∞ÄÎê® */
            --word-break: ${document.getElementById('wordBreakInput').value};
            --global-align: ${document.getElementById('textAlignInput').value};
            --base-weight: ${document.getElementById('fontWeight').value};
            --hl-bg: ${colors.hlbg}; --hl-col: ${colors.hltx};
            --th-col: ${colors.th}; --bd-col: ${colors.bd};
            --qt-col: ${colors.qt}; --it-col: ${document.getElementById('noItalic').checked ? colors.text : colors.it};
            --hr-col: ${colors.hr};
            --bb-l-bg: ${colors.bb_l_bg}; --bb-l-tx: ${colors.bb_l_tx};
            --bb-r-bg: ${colors.bb_r_bg}; --bb-r-tx: ${colors.bb_r_tx};
            --sms-bg: ${colors.sms_bg}; --sms-tx: ${colors.sms_tx};
            --base-sz: ${document.getElementById('fontSize').value}px;
            --base-lh: ${document.getElementById('lineHeight').value};
            --para-sp: ${document.getElementById('paraSpacing').value}px;
        `;

            const c1 = hexToRgba(colors.bg1, 1);
            const c2 = hexToRgba(colors.bg2, 1);
            const ang = document.getElementById('gradAngle').value;
            const gradLayer = `linear-gradient(${ang}deg, ${c1} 0%, ${c2} 100%)`;

            let finalBgStyle = `background: ${gradLayer};`;
            if (bgState.mode === 'image' && bgState.imgData) {
                const overlay = hexToRgba(bgState.overlayColor, document.getElementById('overlayAlpha').value);
                finalBgStyle = `
                background-image: linear-gradient(${overlay}, ${overlay}), url('${bgState.imgData}'), ${gradLayer};
                background-size: 100% 100%, ${bgState.sizeMode === 'cover' ? 'cover' : bgState.scale + '% auto'}, 100% 100%;
                background-position: center, ${bgState.posX}% ${bgState.posY}%, center;
                background-repeat: no-repeat;
             `;
            }

            const fullHtml = `<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Log Card Export (v1.8.1)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang&family=Gowun+Dodum&family=Nanum+Gothic&family=Nanum+Myeongjo&family=Nanum+Pen+Script&family=Noto+Sans+KR:wght@100..900&family=Noto+Serif+KR:wght@200..900&display=swap');
  @import url("https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css");
  @import url('https://cdn.jsdelivr.net/npm/ridibatang@1.0.0/dist/ridibatang.css');
  @font-face { font-family: 'KoPub World Batang'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_eight@1.0/KoPubWorldBatangPro-Regular.woff') format('woff'); }
  @font-face { font-family: 'MaruBuri'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_20-10-21@1.0/MaruBuri-Regular.woff') format('woff'); font-weight: normal; font-style: normal; }
  @font-face { font-family: 'Cafe24SsurroundAir'; src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2105_2@1.0/Cafe24SsurroundAir.woff') format('woff'); font-weight: normal; font-style: normal; }
  
  body { display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 0; background: #e2e8f0; } 
  
  .card-frame { 
    ${cssVars}
    ${finalBgStyle}
    ${userCustomCss}
    color: ${colors.text};
    font-family: ${document.getElementById('fontSelect').value};
    padding: ${document.getElementById('paddingRange').value}px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
    margin: 20px auto; 
    
    width: ${widthVal}px;  /* Fixed Width */
    max-width: 100%;       /* Responsive Fallback */
    box-sizing: border-box; 
  }
  
  .text-part { margin: 0 0 1.2em 0; text-align: var(--global-align, justify); word-break: var(--word-break, break-all); line-height: inherit; } 
  .align-left { text-align: left !important; } .align-center { text-align: center !important; } .align-right { text-align: right !important; } .align-justify { text-align: justify !important; }
  
  .size-up-1 { font-size: 1.2em; line-height: 1.6; }
  .size-up-2 { font-size: 1.4em; line-height: 1.5; }
  .size-down-1 { font-size: 0.9em; opacity: 0.9; }
  .size-down-2 { font-size: 0.8em; opacity: 0.8; }

  .bubble-row { display: flex; margin-bottom: 0.8em; width: 100%; } 
  .bubble-row.left { justify-content: flex-start; } 
  .bubble-row.right { justify-content: flex-end; } 
  .bubble { max-width: 85%; padding: 0.6em 0.8em; border-radius: 0.6em; font-size: 0.95em; position: relative; line-height: inherit; word-break: break-all; } 
  .bubble.left { background: var(--bb-l-bg); color: var(--bb-l-tx); border: 1px solid rgba(0,0,0,0.05); border-top-left-radius: 2px; } 
  .bubble.right { background: var(--bb-r-bg); color: var(--bb-r-tx); border-top-right-radius: 2px; } 
  
  .highlight-text { background: linear-gradient(to bottom, transparent 40%, var(--hl-bg) 40%); border-radius: 2px; padding: 0 2px; font-weight: 700; color: var(--hl-col); } 
  .quote-text { color: var(--qt-col); font-weight: 700; display: block; margin: 0.5em 0; padding-left: 12px; border-left: 3px solid var(--qt-col); } 
  
  .parsed-bold { font-weight: 800; color: var(--bd-col); } 
  .parsed-italic { color: var(--it-col); font-size: 0.95em; font-weight: var(--it-weight); font-style: var(--it-style); } 
  .parsed-thought { color: var(--th-col); font-size: 0.95em; font-style: italic; font-family: var(--th-font); } 
  
  .parsed-h1 { font-size: 1.5em; font-weight: 800; margin: 0.5em 0; color: inherit; letter-spacing: -0.5px; } 
  .parsed-h2 { font-size: 1.2em; font-weight: 700; margin: 0.5em 0; color: inherit; } 
  .parsed-h3 { font-size: 1.1em; font-weight: 700; margin: 0.4em 0 0.2em; color: inherit; opacity: 0.9; } 
  .parsed-hr { border: 0; height: 1px; background: var(--hr-col, #cbd5e1); margin: 1.5em 0; } 


</style>
</head>
<body>
    <div class="card-frame">
        ${content.replace(/<div class="card-frame"[^>]*>|<\/div>$/g, '')} 
    </div>
</body>
</html>`;

            const blob = new Blob([fullHtml], { type: "text/html;charset=utf-8" });
            const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.download = getFileName('html'); link.href = url; link.click();
        }

        /* =========================================
           9. Color Picker Integration (Iro.js)
           ========================================= */
        let currentPickerTarget = null;
        let iroPicker = null;

        window.addEventListener('DOMContentLoaded', () => {
            iroPicker = new iro.ColorPicker("#iroPicker", {
                width: 250, display: "block",
                layout: [
                    { component: iro.ui.Box },
                    { component: iro.ui.Slider, options: { sliderType: 'hue' } },
                    { component: iro.ui.Slider, options: { sliderType: 'alpha' } }
                ]
            });
            iroPicker.on('color:change', function (color) {
                document.getElementById('hexInput').value = color.hex8String.toUpperCase();
            });
        });


        /* =========================================
   [NEW] ÏÇ¨Ïö©Ïûê CSS Í¥ÄÎ¶¨ Î°úÏßÅ
   ========================================= */
let userCustomCss = ""; // Ï†ÑÏó≠ Î≥ÄÏàò

// 1. Î™®Îã¨ Ïó¥Í∏∞/Îã´Í∏∞
function openCssModal() {
    document.getElementById('cssModal').style.display = 'flex';
    document.getElementById('pickerOverlay').style.display = 'block';
    // ÌòÑÏû¨ Í∞í Î°úÎìú
    document.getElementById('customCssInput').value = userCustomCss;
}

function closeCssModal() {
    document.getElementById('cssModal').style.display = 'none';
    document.getElementById('pickerOverlay').style.display = 'none';
    saveData(); // Îã´ÏùÑ Îïå Ï†ÄÏû•
}

// 2. CSS Ï¶âÏãú Ï†ÅÏö© (ÎùºÏù¥Î∏å ÌîÑÎ¶¨Î∑∞)
function applyCustomCss(cssContent) {
    userCustomCss = cssContent;
    
    // Î¨∏ÏÑú Ìó§ÎìúÏóê Ïä§ÌÉÄÏùº ÌÉúÍ∑∏Í∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
    let styleTag = document.getElementById('user-custom-style');
    if (!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = 'user-custom-style';
        document.head.appendChild(styleTag);
    }
    
    // ÎÇ¥Ïö© Ï£ºÏûÖ
    styleTag.innerHTML = cssContent;
}

// [Ï§ëÏöî] Ï¥àÍ∏∞Ìôî Ïãú(window.onload)Ïóê Ïã§ÌñâÎê† Ìï®ÏàòÏóê Ï∂îÍ∞Ä ÌïÑÏöî
// loadData() Ìï®Ïàò ÎÇ¥Î∂Ä Îß® ÎÅùÏóê ÏïÑÎûò Ìïú Ï§ÑÏùÑ Ï∂îÍ∞ÄÌï¥Ïïº Ìï©ÎãàÎã§.
// if (data.customCss) { applyCustomCss(data.customCss); }
        

        function openPicker(targetKey, title) {
            currentPickerTarget = targetKey;
            document.getElementById('pickerTitle').innerText = title + " ÏÑ†ÌÉù";

            const currentColor = colors[targetKey] || "#ffffffff";
            iroPicker.color.set(currentColor);
            document.getElementById('hexInput').value = currentColor.toUpperCase();

            document.getElementById('colorPickerModal').style.display = 'block';
            document.getElementById('pickerOverlay').style.display = 'block';
        }

        function closePicker(save) {
            if (save) {
                const newColor = document.getElementById('hexInput').value;
                setColor(currentPickerTarget, newColor);
            }
            document.getElementById('colorPickerModal').style.display = 'none';
            document.getElementById('pickerOverlay').style.display = 'none';
        }

        function copyBlockContent(i) {
            const text = blocks[i].content;
            navigator.clipboard.writeText(text).then(() => {
                alert("ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.");
            }).catch(err => {
                console.error('Copy failed:', err);
                alert("Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            });
        }

        function setWordBreak(mode, save = true) {
            document.getElementById('wordBreakInput').value = mode;
            document.getElementById('wb-keep').className = mode === 'keep-all' ? 'btn-fit active' : 'btn-fit';
            document.getElementById('wb-break').className = mode === 'break-all' ? 'btn-fit active' : 'btn-fit';
            updatePreview();
            if (save) saveData();
        }

        /* =========================================
               Multi-Regex Logic (Advanced)
               ========================================= */

        // Ï†ïÍ∑úÏãù Í∑úÏπôÎì§ÏùÑ Ï†ÄÏû•Ìï† Î∞∞Ïó¥ (Î™®Îã¨ÏùÑ Îã´ÏïÑÎèÑ Ïú†ÏßÄÎê®)
        let regexQueue = [];
        let currentRegexTarget = -1;

        // 1. Î™®Îã¨ Ïó¥Í∏∞
        function openRegexModal(index) {
            currentRegexTarget = index;
            document.getElementById('regexModal').style.display = 'flex';
            document.getElementById('pickerOverlay').style.display = 'block';

            renderRegexList();

            const oneBtn = document.getElementById('btnRegexOne');
            if (index === -1) {
                oneBtn.style.display = 'none'; // Ï†ÑÏ≤¥ Î™®ÎìúÎ©¥ Í∞úÎ≥Ñ Î≤ÑÌäº Ïà®ÍπÄ
            } else {
                oneBtn.style.display = 'block';
                oneBtn.innerText = `üëá Ïù¥ Î∏îÎ°ù(#${index + 1})Îßå Ï†ÅÏö©`;
            }
        }

        function closeRegexModal() {
            document.getElementById('regexModal').style.display = 'none';
            document.getElementById('pickerOverlay').style.display = 'none';
        }

        // 2. Í∑úÏπô Ï∂îÍ∞Ä (m ÌîåÎûòÍ∑∏ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï)
        function addRegexRule(type) {
            // multiline: trueÎ•º Í∏∞Î≥∏ÏúºÎ°ú Ï∂îÍ∞Ä (Îπà Ï§Ñ ÏÇ≠Ï†ú Îì±Ïóê ÌïÑÏàò)
            let newRule = { pattern: '', replace: '', ignoreCase: false, multiline: true };

            if (type === 'lightboard') {
                newRule.pattern = '<!-- Platform managed do not generate -->[\\s\\S]*?<!-- End platform managed -->';
            } else if (type === 'wncs') {
                newRule.pattern = 'WNCS\\{[\\s\\S]*?\\}';
            } else if (type === 'response') {
                newRule.pattern = '# ÏùëÎãµ';
            } else if (type === 'details') {
                newRule.pattern = '<details>[\\s\\S]*?<\\/details>';
            } else if (type === 'nai') {
                newRule.pattern = '<lb-NAIimg>[\\s\\S]*?</lb-NAIimg>';
            } else if (type === 'says nothing') {
                newRule.pattern = '\\*says nothing\\*';
            } else if (type === 'annotation') {
                newRule.pattern = '<!--[\\s\\S]*?-->';
            } else if (type === 'empty') {
                newRule.pattern = '^\\s*[\\r\\n]';
            }

            regexQueue.push(newRule);
            renderRegexList();
            setTimeout(() => {
                const container = document.getElementById('regexListContainer');
                if (container) container.scrollTop = container.scrollHeight;
            }, 50);
        }

        // 3. Í∑úÏπô ÏÇ≠Ï†ú
        function removeRegexRule(idx) {
            regexQueue.splice(idx, 1);
            renderRegexList();
        }

        // 4. ÏûÖÎ†•Í∞í ÎèôÍ∏∞Ìôî (multiline Ï≤òÎ¶¨ Ï∂îÍ∞Ä)
        function updateRegexRule(idx, field, value) {
            // Ï≤¥ÌÅ¨Î∞ïÏä§(boolean)ÏôÄ ÌÖçÏä§Ìä∏(string) Î™®Îëê Ï≤òÎ¶¨
            regexQueue[idx][field] = value;
        }

        // 5. ÌôîÎ©¥ Í∑∏Î¶¨Í∏∞ (Î†åÎçîÎßÅ) - Multiline ÏòµÏÖò Ï∂îÍ∞ÄÎê®
        function renderRegexList() {
            const container = document.getElementById('regexListContainer');
            container.innerHTML = '';

            regexQueue.forEach((rule, idx) => {
                const div = document.createElement('div');
                div.className = 'regex-row-item';
                div.innerHTML = `
                <div class="regex-row-header">
                    <span>RULE #${idx + 1}</span>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <div style="display:flex; gap:6px;">
                            <label style="display:flex; align-items:center; gap:3px; cursor:pointer;" title="ÎåÄÏÜåÎ¨∏Ïûê Íµ¨Î∂Ñ Ïïà Ìï®">
                                <input type="checkbox" ${rule.ignoreCase ? 'checked' : ''} onchange="updateRegexRule(${idx}, 'ignoreCase', this.checked)"> 
                                <span style="font-size:10px;">i (ÎåÄÏÜåÎ¨∏Ïûê)</span>
                            </label>
                            <label style="display:flex; align-items:center; gap:3px; cursor:pointer;" title="Ïó¨Îü¨ Ï§Ñ Î™®Îìú (^, $ ÏÇ¨Ïö© Í∞ÄÎä•)">
                                <input type="checkbox" ${rule.multiline ? 'checked' : ''} onchange="updateRegexRule(${idx}, 'multiline', this.checked)"> 
                                <span style="font-size:10px; font-weight:bold; color:#2563eb;">m (Îã§Ï§ëÌñâ)</span>
                            </label>
                        </div>
                        <button class="btn-del-row" onclick="removeRegexRule(${idx})" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="regex-inputs-row">
                    <input type="text" class="regex-mini-input" placeholder="Ï∞æÏùÑ Ìå®ÌÑ¥ (Ïòà: ^\\s*[\\r\\n])" value="${rule.pattern.replace(/"/g, '&quot;')}" oninput="updateRegexRule(${idx}, 'pattern', this.value)">
                </div>
                <div class="regex-inputs-row">
                    <input type="text" class="regex-mini-input" placeholder="Î∞îÍøÄ ÎÇ¥Ïö© (ÎπÑÏö∞Î©¥ ÏÇ≠Ï†ú)" value="${rule.replace.replace(/"/g, '&quot;')}" oninput="updateRegexRule(${idx}, 'replace', this.value)">
                </div>
            `;
                container.appendChild(div);
            });
        }

        // 6. Ïã§Ìñâ Î°úÏßÅ (ÌîåÎûòÍ∑∏ Ï°∞Ìï© ÏàòÏ†ï)
        function executeRegexQueue(isAll) {
            if (regexQueue.length === 0) { alert("Ï†ÅÏö©Ìï† Í∑úÏπôÏù¥ ÏóÜÏäµÎãàÎã§."); return; }
            const validRules = regexQueue.filter(r => r.pattern.trim() !== '');
            if (validRules.length === 0) { alert("ÏûÖÎ†•Îêú Ìå®ÌÑ¥Ïù¥ ÏóÜÏäµÎãàÎã§."); return; }

            if (isAll && !confirm(`Ï¥ù ${validRules.length}Í∞úÏùò Í∑úÏπôÏùÑ 'Î™®Îì† Î∏îÎ°ù'Ïóê ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ï†ÅÏö©ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§)`)) return;

            try {
                let changedCount = 0;
                const targetIndices = isAll ? blocks.map((_, i) => i) : (currentRegexTarget !== -1 ? [currentRegexTarget] : []);

                if (targetIndices.length === 0) return;

                targetIndices.forEach(blockIdx => {
                    if (blocks[blockIdx].type !== 'text') return;

                    let content = blocks[blockIdx].content;
                    let original = content;

                    validRules.forEach(rule => {
                        // ‚úÖ Ïó¨Í∏∞ÏÑú m ÌîåÎûòÍ∑∏Î•º Ï∂îÍ∞ÄÌï©ÎãàÎã§!
                        const flags = 'g' + (rule.ignoreCase ? 'i' : '') + (rule.multiline ? 'm' : '');
                        const regex = new RegExp(rule.pattern, flags);
                        content = content.replace(regex, rule.replace);
                    });

                    if (content !== original) {
                        blocks[blockIdx].content = content;
                        changedCount++;
                        const editor = document.getElementById(`editor-${blockIdx}`);
                        if (editor) editor.value = content;
                    }
                });

                if (changedCount > 0) {
                    renderBlocks(); updatePreview(); saveData();
                    regexQueue = []; renderRegexList(); closeRegexModal();
                    alert(`ÏôÑÎ£å! ${changedCount}Í∞úÏùò Î∏îÎ°ùÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.`);
                } else {
                    alert("Ìï¥Îãπ Ìå®ÌÑ¥ÏùÑ Ï∞æÏßÄ Î™ªÌï¥ Î≥ÄÍ≤ΩÎêú ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.");
                }

            } catch (e) {
                alert("Ï†ïÍ∑úÏãù Ïò§Î•ò Î∞úÏÉù: " + e.message);
            }
        }

        /* =========================================
               Visibility Control (Global)
               ========================================= */
        function setAllVisibility(visible) {
            // Î™®Îì† Î∏îÎ°ùÏùò visible ÏÉÅÌÉúÎ•º Î≥ÄÍ≤Ω
            blocks.forEach(b => {
                b.visible = visible;
            });

            // ÌôîÎ©¥ Í∞±Ïã†
            renderBlocks();   // ÏóêÎîîÌÑ∞(ÏûÖÎ†•Ï∞Ω) Îã§Ïãú Í∑∏Î¶¨Í∏∞
            updatePreview();  // ÎØ∏Î¶¨Î≥¥Í∏∞ Ïπ¥Îìú Îã§Ïãú Í∑∏Î¶¨Í∏∞
            saveData();       // Ï†ÄÏû•

            // ÏïåÎ¶º (ÏÑ†ÌÉù ÏÇ¨Ìï≠)
            // const msg = visible ? "Î™®Îì† Î∏îÎ°ùÏùÑ ÌëúÏãúÌï©ÎãàÎã§." : "Î™®Îì† Î∏îÎ°ùÏùÑ Ïà®ÍπÅÎãàÎã§.";
            // alert(msg); 
        }


       /* =========================================
           Batch Split Logic (Updated)
           ========================================= */
        function splitAllBlocks() {
            // 1Ï∞® ÏßàÎ¨∏: ÎÇòÎàÑÍ∏∞ Ïã§Ìñâ Ïó¨Î∂Ä
            if (!confirm("Î™®Îì† ÌÖçÏä§Ìä∏ Î∏îÎ°ù ÎÇ¥Ïùò '---'Î•º Í∏∞Ï§ÄÏúºÎ°ú ÎÇòÎàÑÏãúÍ≤†ÏäµÎãàÍπå?")) return;

            // 2Ï∞® ÏßàÎ¨∏: Íµ¨Î∂ÑÏÑ† Ïú†ÏßÄ Ïó¨Î∂Ä (ÌôïÏù∏=Ïú†ÏßÄ, Ï∑®ÏÜå=ÏÇ≠Ï†ú)
            const keepSeparator = confirm("'---' Íµ¨Î∂ÑÏÑ†ÏùÑ Ïú†ÏßÄÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n[ÌôïÏù∏] : Íµ¨Î∂ÑÏÑ† Ïú†ÏßÄ (Î∏îÎ°ù ÎÅùÏóê --- ÎÇ®ÍπÄ)\n[Ï∑®ÏÜå] : Íµ¨Î∂ÑÏÑ† ÏÇ≠Ï†ú (ÌÖçÏä§Ìä∏Îßå ÎÇ®ÍπÄ)");

            let newBlocks = [];
            let splitCount = 0;

            blocks.forEach(block => {
                // ÌÖçÏä§Ìä∏ Î∏îÎ°ùÏù¥Í≥† ÎÇ¥Ïö©Ïóê '---'Í∞Ä ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå Ï≤òÎ¶¨
                if (block.type === 'text' && block.content.includes('---')) {
                    // '---'Î•º Í∏∞Ï§ÄÏúºÎ°ú Ï™ºÍ∞úÍ∏∞
                    const parts = block.content.split('---');

                    parts.forEach((part, index) => {
                        let trimmedContent = part.trim();

                        // [ÌïµÏã¨ Î≥ÄÍ≤ΩÏ†ê] Íµ¨Î∂ÑÏÑ†ÏùÑ Ïú†ÏßÄÌïòÍ≤†Îã§Í≥† ÌñàÏúºÎ©¥, 
                        // ÎßàÏßÄÎßâ Ï°∞Í∞ÅÏù¥ ÏïÑÎãå Í≤ΩÏö∞ ÎÇ¥Ïö© Îí§Ïóê Îã§Ïãú ---Î•º Î∂ôÏó¨Ï§çÎãàÎã§.
                        if (keepSeparator && index < parts.length - 1) {
                            trimmedContent += "\n---";
                        }

                        // ÎÇ¥Ïö©Ïù¥ ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå ÏÉà Î∏îÎ°ùÏúºÎ°ú Ï∂îÍ∞Ä
                        if (trimmedContent.length > 0) {
                            newBlocks.push({
                                type: 'text',
                                content: trimmedContent,
                                visible: block.visible, // Í∏∞Ï°¥ Ïà®ÍπÄ/ÌëúÏãú ÏÉÅÌÉú Ïú†ÏßÄ
                                width: block.width || 100
                            });
                        }
                    });

                    // Ï™ºÍ∞úÏßÑ ÌöüÏàò Ïπ¥Ïö¥Ìä∏ (Ï°∞Í∞Å Í∞úÏàò - 1)
                    if (parts.length > 1) splitCount += (parts.length - 1);
                } else {
                    // Ìï¥Îãπ ÏóÜÎäî Î∏îÎ°ùÏùÄ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ
                    newBlocks.push(block);
                }
            });

            if (splitCount > 0) {
                blocks = newBlocks;
                renderBlocks();
                updatePreview();
                saveData();
                alert(`Ï¥ù ${splitCount}Í≥≥ÏùÑ ÏûòÎùºÎÇ¥Ïñ¥ Î∏îÎ°ùÏùÑ ÎÇòÎàÑÏóàÏäµÎãàÎã§!`);
            } else {
                alert("ÎÇòÎàå Ïàò ÏûàÎäî '---'Í∞Ä Ìè¨Ìï®Îêú Î∏îÎ°ùÏù¥ ÏóÜÏäµÎãàÎã§.");
            }
        }

        /* =========================================
           Batch Merge Logic (üß¥All)
           ========================================= */
        function mergeAllBlocks() {
            if (!confirm("Î™®Îì† ÌÖçÏä§Ìä∏ Î∏îÎ°ùÏùÑ Ìï©ÏπòÏãúÍ≤†ÏäµÎãàÍπå?\n(Ïù¥ÎØ∏ÏßÄ Î∏îÎ°ù ÏÇ¨Ïù¥Ïùò ÌÖçÏä§Ìä∏ÎÅºÎ¶¨ Î≠âÏ≥êÏßëÎãàÎã§)")) return;

            let newBlocks = [];
            let mergedCount = 0;

            blocks.forEach((block) => {
                // 1. ÏïÑÏßÅ ÏÉà Î¶¨Ïä§Ìä∏Ïóê ÏïÑÎ¨¥Í≤ÉÎèÑ ÏóÜÍ±∞ÎÇò, ÌòÑÏû¨ Î∏îÎ°ùÏù¥ Ïù¥ÎØ∏ÏßÄÎ©¥ Í∑∏ÎÉ• Ï∂îÍ∞Ä
                if (newBlocks.length === 0 || block.type !== 'text') {
                    newBlocks.push(block);
                    return; 
                }

                // 2. ÌòÑÏû¨ Î∏îÎ°ùÏù¥ ÌÖçÏä§Ìä∏Ïùº Îïå, ÏßÅÏ†Ñ Î∏îÎ°ùÏùÑ ÌôïÏù∏
                let lastBlock = newBlocks[newBlocks.length - 1];

                // 3. ÏßÅÏ†Ñ Î∏îÎ°ùÎèÑ ÌÖçÏä§Ìä∏ÎùºÎ©¥? -> Ìï©ÏπòÍ∏∞!
                if (lastBlock.type === 'text') {
                    lastBlock.content += "\n" + block.content;
                    mergedCount++;
                } 
                // 4. ÏßÅÏ†Ñ Î∏îÎ°ùÏù¥ Ïù¥ÎØ∏ÏßÄÏòÄÎã§Î©¥? -> ÏÉàÎ°ú Ï∂îÍ∞Ä
                else {
                    newBlocks.push(block);
                }
            });

            if (mergedCount > 0) {
                blocks = newBlocks;
                renderBlocks();
                updatePreview();
                saveData();
                alert(`Ï¥ù ${mergedCount}Î≤à Ìï©Ï≤¥ ÏÑ±Í≥µ! üß¥`);
            } else {
                alert("Ìï©Ïπ† Ïàò ÏûàÎäî Ïù∏Ï†ëÌïú ÌÖçÏä§Ìä∏ Î∏îÎ°ùÏù¥ ÏóÜÏäµÎãàÎã§.");
            }
        }
        

        /* =========================================
           Delete All Blocks (Clear)
           ========================================= */
        function deleteAllBlocks() {
            if (confirm("‚ö†Ô∏è Ï†ïÎßêÎ°ú Î™®Îì† ÎÇ¥Ïö©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏûëÏÑ± Ï§ëÏù∏ ÌÖçÏä§Ìä∏ÏôÄ Ïù¥ÎØ∏ÏßÄÍ∞Ä Î™®Îëê ÏÇ¨ÎùºÏßÄÎ©∞, ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.")) {
                // Î∏îÎ°ù Î∞∞Ïó¥ÏùÑ ÎπÑÏö∞Í≥†, Îπà ÌÖçÏä§Ìä∏ Î∏îÎ°ù 1Í∞úÎßå ÎÇ®ÍπÄ
                blocks = [{ type: 'text', content: '' }];

                renderBlocks();
                updatePreview();
                saveData();

                // ÌôîÎ©¥ Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏúÑÎ°ú
                window.scrollTo(0, 0);
            }
        }

        /* =========================================
   [ÏàòÏ†ïÎê®] Preview Click to Edit (Îî∞Ïò¥Ìëú Ìò∏ÌôòÏÑ± Í∞úÏÑ†)
   ========================================= */
        function setupPreviewClick() {
            const captureArea = document.getElementById('capture-area');

            captureArea.addEventListener('click', function (e) {
                // 1. ÌÅ¥Î¶≠Îêú ÏöîÏÜåÍ∞Ä Ïñ¥Îäê Î∏îÎ°ùÏóê ÏÜçÌïòÎäîÏßÄ Ï∞æÍ∏∞
                const wrapper = e.target.closest('.preview-block-item');
                if (!wrapper) return;

                const index = wrapper.getAttribute('data-index');
                const textarea = document.getElementById(`editor-${index}`);

                if (textarea) {
                    // 2. ÏóêÎîîÌÑ∞ Ìå®ÎÑêÏù¥ Îã´ÌòÄÏûàÎã§Î©¥ Ïó¥Í∏∞
                    const editorArea = document.getElementById('editorArea');
                    if (editorArea.classList.contains('collapsed')) {
                        toggleEditor();
                    }

                    // 3. ÌÅ¥Î¶≠Ìïú ÌÖçÏä§Ìä∏ ÎÇ¥Ïö© Í∞ÄÏ†∏Ïò§Í∏∞
                    let clickedText = e.target.innerText.trim();
                    if (!clickedText) return;

                    // 4. ÏóêÎîîÌÑ∞Ïùò ÏõêÎ≥∏ ÌÖçÏä§Ìä∏(Raw Text)ÏóêÏÑú ÏúÑÏπò Ï∞æÍ∏∞
                    const rawContent = textarea.value;

                    // [ÏàòÏ†ï Ìè¨Ïù∏Ìä∏] 1Ï∞® ÏãúÎèÑ: ÏûàÎäî Í∑∏ÎåÄÎ°ú Ï∞æÍ∏∞
                    let pos = rawContent.indexOf(clickedText);

                    // [ÏàòÏ†ï Ìè¨Ïù∏Ìä∏] 2Ï∞® ÏãúÎèÑ: Ïã§Ìå®ÌñàÎã§Î©¥ Ïä§ÎßàÌä∏ Îî∞Ïò¥ÌëúÎ•º ÏùºÎ∞ò Îî∞Ïò¥ÌëúÎ°ú Î≥ÄÌôòÌï¥ Ï∞æÍ∏∞
                    if (pos === -1) {
                        // ‚Äú, ‚Äù -> " Î°ú Î≥ÄÍ≤Ω / ‚Äò, ‚Äô -> ' Î°ú Î≥ÄÍ≤Ω
                        const normalizedText = clickedText.replace(/[‚Äú‚Äù]/g, '"').replace(/[‚Äò‚Äô]/g, "'");
                        pos = rawContent.indexOf(normalizedText);
                    }

                    // [ÏàòÏ†ï Ìè¨Ïù∏Ìä∏] 3Ï∞® ÏãúÎèÑ: Í∑∏ÎûòÎèÑ Ïã§Ìå®ÌñàÎã§Î©¥(Ïä§ÌÉÄÏùº ÌÉúÍ∑∏ Îì±ÏúºÎ°ú Ïù∏Ìï¥), ÏïûÎí§ Îî∞Ïò¥ÌëúÎ•º ÎñºÍ≥† ÏïåÎßπÏù¥Îßå Ï∞æÍ∏∞
                    if (pos === -1) {
                        const strippedText = clickedText.replace(/^["‚Äú‚Äù'‚Äò‚Äô]/, '').replace(/["‚Äú‚Äù'‚Äò‚Äô]$/, '');
                        if (strippedText.length > 2) { // ÎÑàÎ¨¥ ÏßßÏùÄ Îã®Ïñ¥Îäî Ïò§ÏûëÎèô Î∞©ÏßÄ
                            pos = rawContent.indexOf(strippedText);
                        }
                    }

                    // 5. Ïä§ÌÅ¨Î°§ Ïù¥Îèô Î∞è Ìè¨Ïª§Ïä§
                    textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    setTimeout(() => {
                        textarea.focus();
                        if (pos !== -1) {
                            // Ï∞æÏùÄ ÏúÑÏπòÎ°ú Ïª§ÏÑú Ïù¥Îèô Î∞è ÌÖçÏä§Ìä∏ ÏÑ†ÌÉù
                            textarea.setSelectionRange(pos, pos + clickedText.length);
                        }
                    }, 300);
                }
            });
        }




        /* =========================================
           [NEW] TXT Import Logic with Options
           ========================================= */
           
        let pendingTxtFile = null; // ÏÑ†ÌÉùÎêú ÌååÏùºÏùÑ ÏûÑÏãú Ï†ÄÏû•Ìï† Î≥ÄÏàò
        
        // 1. ÌååÏùº ÏÑ†ÌÉù Ïãú Î™®Îã¨ Ïó¥Í∏∞
        function openTxtImportModal(input) {
            if (!input.files || !input.files[0]) return;
            pendingTxtFile = input.files[0]; // ÌååÏùº Ï†ÄÏû•
            
            // Î™®Îã¨ ÌëúÏãú
            document.getElementById('txtImportModal').style.display = 'flex';
            document.getElementById('pickerOverlay').style.display = 'block';
            
            // input Ï¥àÍ∏∞Ìôî (Ï∑®ÏÜå ÌõÑ Îã§Ïãú Í∞ôÏùÄ ÌååÏùº ÏÑ†ÌÉù Í∞ÄÎä•ÌïòÍ≤å)
            input.value = '';
        }
        
        // 2. Î™®Îã¨ Îã´Í∏∞
        function closeTxtImportModal() {
            document.getElementById('txtImportModal').style.display = 'none';
            document.getElementById('pickerOverlay').style.display = 'none';
            pendingTxtFile = null; // ÏûÑÏãú ÌååÏùº Ï¥àÍ∏∞Ìôî
        }
        
        // 3. Ïã§Ìñâ (ÏÑ†ÌÉùÎêú ÏòµÏÖòÏóê Îî∞Îùº Ï†ïÍ∑úÏãù Ï†ÅÏö©)
        function executeTxtImport() {
            if (!pendingTxtFile) {
                alert("ÌååÏùºÏù¥ ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
                closeTxtImportModal();
                return;
            }
        
            const reader = new FileReader();
            reader.onload = function(e) {
                let content = e.target.result;
        
                // --- Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú ÌôïÏù∏ Î∞è ÏπòÌôò ---
                
                // 1. ü§ñ ÎùºÏù¥Ìä∏Î≥¥Îìú Ï†úÍ±∞
                if (document.getElementById('chk-lightboard').checked) {
                    content = content.replace(/<!-- Platform managed do not generate -->[\s\S]*?<!-- End platform managed -->/g, '');
                }
        
                // 2. ‚öôÔ∏è WNCS Ï†úÍ±∞
                if (document.getElementById('chk-wncs').checked) {
                    content = content.replace(/WNCS\{[\s\S]*?\}/g, '');
                }
        
                // 3. üñºÔ∏è NAI ÌÉúÍ∑∏ Ï†úÍ±∞
                if (document.getElementById('chk-nai').checked) {
                    content = content.replace(/<lb-NAIimg>[\s\S]*?<\/lb-NAIimg>/g, '');
                }
        
                // 4. üìù '# ÏùëÎãµ' Ï†úÍ±∞
                if (document.getElementById('chk-response').checked) {
                    content = content.replace(/# ÏùëÎãµ/g, '');
                }
        
                // 5. üôä *says nothing* Ï†úÍ±∞
                if (document.getElementById('chk-saysnothing').checked) {
                    content = content.replace(/\*says nothing\*/g, '');
                }
        
                // 6. ‚úèÔ∏è Ï£ºÏÑù Ï†úÍ±∞
                if (document.getElementById('chk-annotation').checked) {
                    content = content.replace(/<!--[\s\S]*?-->/g, '');
                }
        
                // 7. üìÇ Details ÌÉúÍ∑∏ Ï†úÍ±∞
                if (document.getElementById('chk-details').checked) {
                    content = content.replace(/<details>[\s\S]*?<\/details>/g, '');
                }
        
                // 8. üßπ Îπà Ï§Ñ Ï†úÍ±∞
                if (document.getElementById('chk-empty').checked) {
                    content = content.replace(/^\s*[\r\n]/gm, '');
                }
        
                // --- Î∏îÎ°ù Ï∂îÍ∞Ä Î∞è Ï†ÄÏû• ---
                blocks.push({
                    type: 'text',
                    content: content.trim(),
                    visible: true
                });
        
                renderBlocks();
                updatePreview();
                saveData();
        
                // Î™®Îã¨ Îã´Í∏∞ Î∞è ÏïåÎ¶º
                closeTxtImportModal();
                alert("üì• ÌÖçÏä§Ìä∏ Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å!");
                setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
            };
        
            reader.readAsText(pendingTxtFile);
        }

        

        /* =========================================
           Bookmarklet Modal Logic
           ========================================= */
        function openBookmarkletModal() {
            document.getElementById('bookmarkletModal').style.display = 'flex';
            document.getElementById('pickerOverlay').style.display = 'block';
        }

        function closeBookmarkletModal() {
            document.getElementById('bookmarkletModal').style.display = 'none';
            document.getElementById('pickerOverlay').style.display = 'none';
        }

        /* =========================================
           Í≤åÏãúÌåêÏö© Ïù∏ÎùºÏù∏ HTML Î≥µÏÇ¨ Í∏∞Îä•
           ========================================= */
        function copySafeHtml() {
            // 1. ÌòÑÏû¨ ÏÑ§Ï†ïÍ∞í Í∞ÄÏ†∏Ïò§Í∏∞
            const widthVal = document.getElementById('cardWidthInput').value;
            const paddingVal = document.getElementById('paddingRange').value;
            const fontSize = document.getElementById('fontSize').value;
            const lineHeight = document.getElementById('lineHeight').value;
            const fontName = document.getElementById('fontSelect').value;
            const align = document.getElementById('textAlignInput').value;
            const paraSpacing = document.getElementById('paraSpacing').value;
            const wordBreak = document.getElementById('wordBreakInput').value;
            
            // Ïù¥ÌÉ§Î¶≠ ÏÑ§Ï†ï ÌôïÏù∏
            const noItalic = document.getElementById('noItalic').checked;
            const itStyle = noItalic ? 'normal' : 'italic';
            const itWeight = noItalic ? document.getElementById('fontWeight').value : '700';
            const itColor = noItalic ? colors.text : colors.it;
        
            // 2. Î∞∞Í≤Ω Ïä§ÌÉÄÏùº ÏÉùÏÑ±
            const c1 = hexToRgba(colors.bg1, 1);
            const c2 = hexToRgba(colors.bg2, 1);
            const ang = document.getElementById('gradAngle').value;
            let bgStyle = `background: linear-gradient(${ang}deg, ${c1} 0%, ${c2} 100%);`;
        
            if (bgState.mode === 'image' && bgState.imgData) {
                const overlay = hexToRgba(bgState.overlayColor, document.getElementById('overlayAlpha').value);
                const sizeStyle = bgState.sizeMode === 'cover' ? 'cover' : `${bgState.scale}% auto`;
                bgStyle = `
                    background-image: linear-gradient(${overlay}, ${overlay}), url('${bgState.imgData}'), linear-gradient(${ang}deg, ${c1} 0%, ${c2} 100%);
                    background-size: 100% 100%, ${sizeStyle}, 100% 100%;
                    background-position: center, ${bgState.posX}% ${bgState.posY}%, center;
                    background-repeat: no-repeat;
                `;
            }
        
            // 3. HTML Ï°∞Î¶Ω (Ï†ÑÏ≤¥ ÎûòÌçº)
            let html = `<div style="width: auto; max-width: ${widthVal}px; margin: 0 auto; padding: ${paddingVal}px; box-sizing: border-box; ${bgStyle} color: ${colors.text}; font-family: ${fontName}, sans-serif; font-size: ${fontSize}px; line-height: ${lineHeight}; text-align: ${align}; word-break: ${wordBreak};">`;
        
            // 4. Î∏îÎ°ù ÏàúÌöåÌïòÎ©∞ Ïä§ÌÉÄÏùº Ï£ºÏûÖ
            blocks.forEach(b => {
                // visibleÏù¥ falseÏùº ÎïåÎßå Í±¥ÎÑàÎúÄ (undefinedÎäî Î≥¥Ïù¥Îäî Í≤ÉÏúºÎ°ú Ï≤òÎ¶¨)
                if (b.visible === false) return;
        
                if (b.type === 'image') {
                    html += `<div style="text-align:center; margin-bottom:${paraSpacing}px;"><img src="${b.content}" style="width:${b.width || 100}%; border-radius:8px; display:inline-block;"></div>`;
                } else {
                    let tempDiv = document.createElement('div');
                    // ÌååÏã±Îêú HTMLÏùÑ ÏûÑÏãú divÏóê ÎÑ£Ïùå
                    tempDiv.innerHTML = parseContent(b.content);
        
                    // P ÌÉúÍ∑∏ Ïä§ÌÉÄÏùº Ï£ºÏûÖ
                    tempDiv.querySelectorAll('p').forEach(p => {
                        p.style.margin = `0 0 ${paraSpacing}px 0`;
                        p.style.lineHeight = lineHeight;
                        // ÌÅ¥ÎûòÏä§Î≥Ñ Ïä§ÌÉÄÏùº Ïù∏ÎùºÏù∏Ìôî
                        if (p.classList.contains('align-center')) p.style.textAlign = 'center';
                        if (p.classList.contains('align-right')) p.style.textAlign = 'right';
                        if (p.classList.contains('align-left')) p.style.textAlign = 'left';
                        if (p.classList.contains('align-justify')) p.style.textAlign = 'justify';
                        
                        if (p.classList.contains('size-up-1')) p.style.fontSize = '1.2em';
                        if (p.classList.contains('size-up-2')) p.style.fontSize = '1.4em';
                        if (p.classList.contains('size-down-1')) { p.style.fontSize = '0.9em'; p.style.opacity = '0.9'; }
                        if (p.classList.contains('size-down-2')) { p.style.fontSize = '0.8em'; p.style.opacity = '0.8'; }
                    });
        
                    // Ï†úÎ™© ÌÉúÍ∑∏ Ïä§ÌÉÄÏùº Ï£ºÏûÖ
                    tempDiv.querySelectorAll('h1').forEach(h => { h.style.fontSize = '1.5em'; h.style.fontWeight = '800'; h.style.margin = `0 0 ${paraSpacing}px 0`; });
                    tempDiv.querySelectorAll('h2').forEach(h => { h.style.fontSize = '1.2em'; h.style.fontWeight = '700'; h.style.margin = `0 0 ${paraSpacing}px 0`; });
                    tempDiv.querySelectorAll('h3').forEach(h => { h.style.fontSize = '1.1em'; h.style.fontWeight = '700'; h.style.margin = `0 0 ${paraSpacing}px 0`; h.style.opacity = '0.9'; });
        
                    // Íµ¨Î∂ÑÏÑ† Ïä§ÌÉÄÏùº Ï£ºÏûÖ
                    tempDiv.querySelectorAll('.parsed-hr').forEach(hr => { 
                        hr.style.border = '0'; 
                        hr.style.height = '1px'; 
                        hr.style.background = colors.hr; 
                        hr.style.margin = '1.5em 0'; 
                    });
        
                    // ÎßêÌíçÏÑ† Î†àÏù¥ÏïÑÏõÉ Ïä§ÌÉÄÏùº Ï£ºÏûÖ
                    tempDiv.querySelectorAll('.bubble-row').forEach(row => {
                        row.style.display = 'flex';
                        row.style.marginBottom = `${parseInt(paraSpacing) * 0.7}px`;
                        row.style.width = '100%';
                        if (row.classList.contains('left')) row.style.justifyContent = 'flex-start'; 
                        else row.style.justifyContent = 'flex-end';
                    });
                    
                    // ÎßêÌíçÏÑ† Î≥∏Î¨∏ Ïä§ÌÉÄÏùº Ï£ºÏûÖ
                    tempDiv.querySelectorAll('.bubble').forEach(bb => {
                        bb.style.maxWidth = '85%'; 
                        bb.style.padding = '0.6em 0.8em'; 
                        bb.style.borderRadius = '0.6em'; 
                        bb.style.fontSize = '1em'; 
                        bb.style.wordBreak = 'break-all';
                        
                        if (bb.classList.contains('left')) { 
                            bb.style.background = colors.bb_l_bg; 
                            bb.style.color = colors.bb_l_tx; 
                            bb.style.border = '1px solid rgba(0,0,0,0.05)'; 
                            bb.style.borderTopLeftRadius = '2px'; 
                        } else { 
                            bb.style.background = colors.bb_r_bg; 
                            bb.style.color = colors.bb_r_tx; 
                            bb.style.borderTopRightRadius = '2px'; 
                        }
                    });
        
                    // Ïù∏ÎùºÏù∏ ÌÖçÏä§Ìä∏ Ïä§ÌÉÄÏùº Ï£ºÏûÖ (Bold, Italic, Highlight Îì±)
                    tempDiv.querySelectorAll('.parsed-bold').forEach(s => { s.style.fontWeight = '800'; s.style.color = colors.bd; });
                    tempDiv.querySelectorAll('.parsed-italic').forEach(s => { s.style.color = itColor; s.style.fontStyle = itStyle; s.style.fontWeight = itWeight; });
                    tempDiv.querySelectorAll('.parsed-thought').forEach(s => { s.style.color = colors.th; s.style.fontStyle = 'italic'; s.style.fontFamily = "'Ridibatang', serif"; });
                    
                    // ÌòïÍ¥ëÌéú Ìö®Í≥º
                    tempDiv.querySelectorAll('.highlight-text').forEach(s => { 
                        s.style.background = `linear-gradient(to bottom, transparent 40%, ${colors.hlbg} 40%)`; 
                        s.style.fontWeight = '700'; 
                        s.style.color = colors.hltx; 
                        s.style.borderRadius = '2px'; 
                        s.style.padding = '0 2px'; 
                    });
                    
                    // Î¨∏Ïûê Î©îÏãúÏßÄ Î∞ïÏä§
                    tempDiv.querySelectorAll('.sms-box').forEach(s => { 
                        s.style.background = colors.sms_bg; 
                        s.style.color = colors.sms_tx; 
                        s.style.border = '1px solid rgba(0,0,0,0.1)'; 
                        s.style.borderRadius = '15px'; 
                        s.style.padding = '2px 8px'; 
                        s.style.display = 'inline-block'; 
                        s.style.fontSize = '0.97em'; 
                    });
                    
                    // Ïù∏Ïö©Íµ¨
                    tempDiv.querySelectorAll('.quote-text').forEach(s => { 
                        s.style.color = colors.qt; 
                        s.style.fontWeight = '700'; 
                        s.style.display = 'block'; 
                        s.style.margin = '0.5em 0'; 
                        s.style.paddingLeft = '12px'; 
                        s.style.borderLeft = `3px solid ${colors.qt}`; 
                    });
        
                    // ÏôÑÏÑ±Îêú ÎÇ¥Î∂Ä HTMLÏùÑ Î©îÏù∏ HTMLÏóê Ï∂îÍ∞Ä
                    html += tempDiv.innerHTML;
                }
            });
        
            html += `</div>`;
        
            // 5. Î≥µÏÇ¨ Ïã§Ìñâ
            navigator.clipboard.writeText(html)
                .then(() => {
                    alert("‚úÖ Í≤åÏãúÌåêÏö© HTML ÏΩîÎìúÍ∞Ä Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!\nÎ∏îÎ°úÍ∑∏ÎÇò Í≤åÏãúÌåêÏùò [HTML Î™®Îìú]Ïóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî.");
                })
                .catch(err => {
                    console.error("Î≥µÏÇ¨ Ïã§Ìå®:", err);
                    prompt("‚ö†Ô∏è ÏûêÎèô Î≥µÏÇ¨Í∞Ä Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§. ÏïÑÎûò ÏΩîÎìúÎ•º Ï†ÑÏ≤¥ Î≥µÏÇ¨(Ctrl+A, C)ÌïòÏÑ∏Ïöî:", html);
                });
        }

        // =========================================
        // [NEW] ÌÅ¥Î¶ΩÎ≥¥Îìú Ïù¥ÎØ∏ÏßÄ Î∂ôÏó¨ÎÑ£Í∏∞ Í∏∞Îä•
        // =========================================
        window.addEventListener('paste', function(e) {
            // 1. ÌÅ¥Î¶ΩÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let blob = null;
        
            // 2. Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏù¥ ÏûàÎäîÏßÄ ÌÉêÏÉâ
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    blob = items[i].getAsFile();
                    break;
                }
            }
        
            // 3. Ïù¥ÎØ∏ÏßÄÍ∞Ä Î∞úÍ≤¨ÎêòÎ©¥ Î∏îÎ°ùÏúºÎ°ú Ï∂îÍ∞Ä
            if (blob !== null) {
                // ÌÖçÏä§Ìä∏ ÏûÖÎ†•Ï∞Ω Îì±Ïóê Î∂ôÏó¨ÎÑ£Í∏∞ ÎêòÎäî Í∏∞Î≥∏ ÎèôÏûë ÎßâÍ∏∞
                e.preventDefault(); 
        
                const reader = new FileReader();
                reader.onload = function(event) {
                    // Í∏∞Ï°¥ addImgBlock Î°úÏßÅÏùÑ ÌôúÏö©Ìï¥ÏÑú Î∏îÎ°ù Ï∂îÍ∞Ä
                    blocks.push({
                        type: 'image',
                        content: event.target.result, // Base64 Îç∞Ïù¥ÌÑ∞
                        width: 100
                    });
                    renderBlocks();
                    updatePreview();
                    saveData();
                    
                    // ÌôîÎ©¥ Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏïÑÎûòÎ°ú Ïù¥Îèô
                    setTimeout(() => {
                        const blockList = document.getElementById('block-list');
                        if(blockList) blockList.lastElementChild.scrollIntoView({behavior: "smooth"});
                    }, 100);
                    
                    // ÏïåÎ¶º (ÏÑ†ÌÉù ÏÇ¨Ìï≠)
                    console.log("ÌÅ¥Î¶ΩÎ≥¥Îìú Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!"); 
                };
                reader.readAsDataURL(blob);
            }
        });

    </script>
</body>

</html>
